////Graphics///

function setPreloaderPict(parentId,preloaderId,preloaderStyle){
  var div = document.createElement("div");
  div.setAttribute('id', preloaderId);
  var s = div.style;
  s.position = "absolute";
  s.zIndex=12;
  document.getElementById(parentId).appendChild(div);
  if (preloaderStyle=="mini")
  	div.innerHTML="<img src=\"/images/ajax-miniloader.gif\" width=\"16\" height=\"16\" />";
  else div.innerHTML="<img src=\"/images/ajax-loader.gif\" width=\"93\" height=\"26\" />";
  return div;
}

function getPos(el,sProp) {
	var iPos = 0;
	while (el!=null) {
		iPos+=el["offset" + sProp]
		el = el.offsetParent;
	}
	return iPos
}

function getOffset(elem) {
 if (elem.getBoundingClientRect) {
 return getOffsetRect(elem)
 } else {
 return getOffsetSum(elem)
 }
}

function getOffsetSum(elem) {
 var top=0, left=0
 while(elem) {
 top = top + parseInt(elem.offsetTop)
 left = left + parseInt(elem.offsetLeft)
 elem = elem.offsetParent
 }
 
 return {top: top, left: left}
}
 

function getOffsetRect(elem) {
 var box = elem.getBoundingClientRect()
 var body = document.body
 var docElem = document.documentElement
 
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 
 var top = box.top + scrollTop - clientTop
 var left = box.left + scrollLeft - clientLeft
 
 return { top: Math.round(top), left: Math.round(left) }
}

function setPreloaderStyle(parentDiv,preloaderDiv){
	var div=document.getElementById(preloaderDiv);
	var pdiv=document.getElementById(parentDiv);
	div.style.left=Math.round(pdiv.offsetWidth/2)-Math.round(div.offsetWidth/2)+"px";

	if ((parentDiv=="townsContainer") && (pdiv.className=="townsContainerMain"))
		div.style.top=Math.round(pdiv.offsetHeight/2)-Math.round(div.offsetHeight/2)+"px";
	else
		div.style.top=Math.round(pdiv.offsetHeight/2)+15-Math.round(div.offsetHeight/2)+"px";
}

function initPreloader(parentId, preloaderId,preloaderStyle) {
	var pobj=document.getElementById(parentId);

	var obj=document.getElementById(preloaderId);
	if (!obj) {

		obj=setPreloaderPict(parentId,preloaderId,preloaderStyle);
		setPreloaderStyle(parentId,preloaderId);

	}

	obj.style.visibility="visible";
}

function GraphObj(townindex,geosuffix) {

	var graph = this;
	graph._townindex=townindex;
	graph._arrGraphName=new Array("P","T","R","W");
	graph._n=graph._arrGraphName.length;
	graph._arrGraphPic=new Array();
	graph._lastShowGraphic=0;
	graph._graphicTimer=null;

	graph.preloadGraph=function() {
		var k=0;
		for (var i=numFRC*graph._n; i<(numFRC+1)*graph._n; i++){
			if (graph._arrGraphPic[i]==null) {
				graph._arrGraphPic[i]=new Image();
				graph._arrGraphPic[i].src="http://www.meteonova.ru/images/graphics/"+graph._arrGraphName[k]+"G"+graph._townindex+"_1"+numFRC+".png"+geosuffix;
				graph._arrGraphPic[i].onLoad=graph.initGraphic(i);
		  }
		  k++;
		}
	}

	graph.preloadGraphic=function(k) {
		var i=numFRC*graph._n+k;
		if (graph._arrGraphPic[i]==null) {
			graph._arrGraphPic[i]=new Image();
			graph._arrGraphPic[i].src="http://www.meteonova.ru/images/graphics/"+graph._arrGraphName[k]+"G"+graph._townindex+"_1"+numFRC+".png"+geosuffix;
			graph._arrGraphPic[i].onLoad=graph.initGraphic(i);
		  }
	}

	graph.initGraphic=function(i) {
		if (!document.getElementById("graph"+i)) {
	  		var img= document.createElement("img");
				img.setAttribute("id", "graph"+i);
	  		img.src=graph._arrGraphPic[i].src;
				var s = img.style;
				s.top=0;
	  		s.left=0;
	  		s.visibility = "hidden";
	  		s.position = "absolute";
	  		s.zIndex=12;
			document.getElementById('graphic').appendChild(img);
	  }
	}

	graph.showGraphic=function(el,graph_num) {
		clearTimeout(graph._graphicTimer);
 		var obj=document.getElementById("graphic");
   		if (obj) {
//    		obj.style.left = getPos(document.getElementById("td2"),"Left");
//     		obj.style.top =  getPos(el,"Top")+el.offsetHeight+"px";
		obj.style.left = getOffset(document.getElementById("frc_cont")).left+"px";
		obj.style.top =  getOffset(el).top+el.offsetHeight+"px";
     		obj.style.visibility = "visible";
    	}

    var div=document.getElementById("graph"+graph._lastShowGraphic);
    if (div) div.style.visibility="hidden";

    div=document.getElementById("graph"+graph_num);
   	if (div) {
   		div.style.visibility="visible";
   		graph._lastShowGraphic=graph_num;
   	}
  }

  graph.hideGraphic=function(){
	clearTimeout(graph._graphicTimer);
    var div=document.getElementById("graph"+graph._lastShowGraphic);
    if (div) div.style.visibility="hidden";
    div=document.getElementById("graphic");
    if (div) div.style.visibility = "hidden";
  }

  graph.timerHideGraphic=function() {
  	graph._graphicTimer=setTimeout(function(){graph.hideGraphic();},1000);
  }

}

//// Hints /////

var hintTimeouts = new Array();

function showHint(parentObj, id, bVisible, width) {
	id = id.toString();
	var obj = document.getElementById("hint_content_"+id);
	if (!obj) initHint(id, width);

	var hintObj = document.getElementById(id);
	if (hintObj) {
    hintObj.style.left=getPos(parentObj,"Left")+2+"px";
    hintObj.style.top =  getPos(parentObj,"Top")+parentObj.offsetHeight+2+"px";
    setTimeoutHint(hintObj, bVisible);
  }
}

function setTimeoutHint(hintObj, bVisible) {
	var id = hintObj.getAttribute("id").toString();
	var hintTimeout = hintTimeouts[id];
	clearTimeout(hintTimeout);
  hintTimeouts[id] = setTimeout(function() {
  		if (bVisible) hintObj.style.visibility="visible";
  		else hintObj.style.visibility="hidden";
    },
    500
  );
}

function initModalWnd(id, width, bVisible, callbackfunction) {
	var obj = document.getElementById("hint_content_"+id);
	if (!obj) initHint(id, width, callbackfunction);
	var ovStyle = document.getElementById("overlay").style;
	modalWndStyle = document.getElementById(id).style;
	if (bVisible) {
		ovStyle.display = "block";
		modalWndStyle.visibility = "visible";
		updateModalWnd();
		if (bIE) window.attachEvent('onscroll', updateModalWnd);
	}
	else {
		ovStyle.display = "none";
		modalWndStyle.visibility = "hidden";
		window.detachEvent('onscroll', updateModalWnd);
	}
}

function updateModalWnd() {
	var dtop = -100;
	var ddtop = 0;
	var clientWidth = window.innerWidth || (document.documentElement && document.documentElement.clientWidth) || document.body.clientWidth;	
	var clientHeight = window.innerHeight || (document.documentElement && document.documentElement.clientHeight) || document.body.clientHeight;
	var ovStyle = document.getElementById("overlay").style;
	var modalWndStyle = document.getElementById('modalWnd').style;
	if (bIE)
		ddtop = window.pageYOffset || (document.documentElement && document.documentElement.scrollTop) || document.body.scrollTop; 
  modalWndStyle.left = clientWidth/2-parseInt(modalWndStyle.width, 10)/2;
  modalWndStyle.top = Math.round(clientHeight/2-parseInt(modalWndStyle.height, 10)/2)+ddtop+dtop;
	ovStyle.top = ddtop;
}

function initHint(id, width, callbackfunction) {
	var imgUrl = "/images/hints";
	var hintObj = document.getElementById(id);
	if (hintObj) {
		var content = hintObj.innerHTML;
		var hintBlock = "<div>";
		hintBlock+="<div class='hint_top_left'><img src='"+imgUrl+"/hint_top_left.png' width='15' height='18' class='corner' onLoad='transparent(this)'></div>";
		hintBlock+="<div class='hint_top_center' style='width: "+width+"px;'></div>";
		hintBlock+="<div class='hint_top_right'><img src='"+imgUrl+"/hint_top_right.png' width='23' height='18' class='corner' onLoad='transparent(this)'></div>";
		hintBlock+="</div>";
    hintBlock+="<div>";
		hintBlock+="<div class='hint_body_left' id='hint_body_left"+id+"'><img src='"+imgUrl+"/hint_body_left.png' id='img_hint_body_left"+id+"' width=15 onLoad='transparent(this)'></div>";
		var el = document.getElementById('modalWnd');	
		if (callbackfunction && el) hintBlock+="<div class='hint_body_center' id='hint_content_"+id+"' style='width: "+width+"px; background-color: #f8f9fd'>"+content+"<div class='btn-close'><a href='javascript:document.getElementById(\"ModalWndBtnCansel\").onclick()'></a></div></div>";
		else hintBlock+="<div class='hint_body_center' id='hint_content_"+id+"' style='width: "+width+"px; background-color: #f8f9fd'>"+content+"</div>"; 
		hintBlock+="<div class='hint_body_right'  id='hint_body_right"+id+"'><img src='"+imgUrl+"/hint_body_right.png' id='img_hint_body_right"+id+"' width=23 onLoad='transparent(this)'></div>";
		hintBlock+="</div>";
    hintBlock+= "<div style=\"margin-top: -2px;\">";
		hintBlock+="<div class='hint_bottom_left'><img src='"+imgUrl+"/hint_bottom_left.png' width='15' height='18' class='corner' onLoad='transparent(this)'></div>";
		hintBlock+="<div class='hint_bottom_center' style='width: "+width+"px;'></div>";
		hintBlock+="<div class='hint_bottom_right'><img src='"+imgUrl+"/hint_bottom_right.png' width='23' height='18' class='corner' onLoad='transparent(this)'></div>";
		hintBlock+="</div>";
		hintObj.innerHTML = hintBlock;
		var content_height = document.getElementById("hint_content_"+id).offsetHeight;
		document.getElementById("img_hint_body_left"+id).style.height = content_height+'px';
		document.getElementById("img_hint_body_right"+id).style.height = content_height+'px';
		document.getElementById("hint_body_left"+id).style.height = content_height+'px';
		document.getElementById("hint_body_right"+id).style.height = content_height+'px';		
		hintObj.style.width = width+40+'px';
		hintObj.style.height = content_height+'px';
		el = document.getElementById('ModalWndBtnOk');
		if (callbackfunction && el) el.onclick = callbackfunction;
	}
}

//// Scroll Forecasts /////

/////////////////////// прокрутка прогноза///////////////////////////////////////

var tm=null;
var spd=10;
var tleft=-999;
D_IDLE=0;
D_SCROLLLEFT=1;
D_SCROLLRIGHT=2;
D_ALIGNLEFT=3;
D_ALIGNRIGHT=4;
D_SETPOS=5;
D_SCROLLTOP=6;
D_SCROLLBOTTOM=7;
D_ALIGNTOP=8;
D_ALIGNBOTTOM=9;
var mode=D_IDLE;
var fco=null;

function scrollH(i){
  with(fco){
    var pos = scrollLeft+i;
    if(pos<0) { pos=0; mode=D_IDLE;} else if(pos>=scrollWidth){ pos=scrollWidth-1; mode=D_IDLE;} else scrollLeft=pos;
    }
  }
function scrollV(i){
  with(fco){
    var posv = scrollTop+i;
    if(posv<0) { posv=0; mode=D_IDLE;} else if(posv>=scrollHeight){ posv=scrollHeight-1; mode=D_IDLE;} else scrollTop=posv;
    }
  }
function stopAutoScroll(){ if(mode==D_SCROLLLEFT) mode=D_ALIGNLEFT; else if(mode==D_SCROLLRIGHT) mode=D_ALIGNRIGHT;}
function goLeft(){ mode=D_SCROLLLEFT; }
function goRight(){ mode=D_SCROLLRIGHT; }
function goTop(){ mode=D_SCROLLTOP; }
function goBottom(){ mode=D_SCROLLBOTTOM; }
function goToFRC(){
 mode=D_SETPOS; } 

function tmDispatch(){
switch(mode) {
 case D_IDLE:        spd=10; break;
 case D_SCROLLLEFT:  scrollH(-spd/10); spd++; if(spd>60) spd=60; updateForecastBg(Math.round(fco.scrollLeft/fco.scrollWidth*6)); break;
 case D_SCROLLRIGHT: scrollH(spd/10); spd++; if(spd>60) spd=60; updateForecastBg(Math.round(fco.scrollLeft/fco.scrollWidth*6)); break;
 case D_ALIGNLEFT:   d=fco.scrollLeft % 51; if(d>1) scrollH(-1); else mode=D_IDLE; break;
 case D_ALIGNRIGHT:  d=fco.scrollLeft % 51; if(d>1) scrollH(1); else mode=D_IDLE; break;
 case D_SETPOS:      pos=numFRC*510+1; d=pos-fco.scrollLeft; if(Math.abs(d)>600) sp=80; else if(Math.abs(d)>200) sp=40; else if(Math.abs(d)>40) sp=20; else sp=1; if(d>=1) scrollH(sp); else  if(d<=-1) scrollH(-sp); else mode=D_IDLE; break;
 case D_SCROLLTOP:   scrollV(-spd/10); spd++; if(spd>60) spd=60; break;
 case D_SCROLLBOTTOM: scrollV(spd/10); spd++; if(spd>60) spd=60; break;
 case D_ALIGNTOP:    d=fco.scrollTop % 15; if(d>1) scrollV(-1); else mode=D_IDLE; break;
 case D_ALIGNBOTTOM:  d=fco.scrollTop % 15; if(d>1) scrollV(1); else mode=D_IDLE; break;
 }
}

var arrFrcDay=new Array("0","1","2","3","4","5");
var numFRC=0;
function checkFrcTopLink(){
   for (var i=0; i<arrFrcDay.length; i++)
     if (numFRC>=0 && numFRC==arrFrcDay[i]) {
       document.getElementById("frc_"+arrFrcDay[i]).style.color="#3b55c5";
       document.getElementById("frc_"+arrFrcDay[i]).style.fontWeight="bold";
     }
     else {
       document.getElementById("frc_"+arrFrcDay[i]).style.color="#0000ee";
       document.getElementById("frc_"+arrFrcDay[i]).style.fontWeight="normal";
     }
 }


function initScrollContent(obj) {
	  if(obj) {
	   obj.state = 0;
		 obj.maxVert = obj.scrollHeight - obj.offsetHeight;
	  }
	}

  function scroll(val,contentId) {
    var obj=document.getElementById(contentId);
   	if (obj) {
   		initScrollContent(obj);
   		obj.scrollTop=obj.maxVert*(val/100);
    }
	}

  function scroll2(el,contentId, vSlider,slideHandle) {
  	var obj=document.getElementById(contentId);
  	if (obj) {
  		initScrollContent(obj);
  		if (el.getAttribute("id").indexOf("slideBottom")>-1) {
  			if (obj.maxVert > obj.scrollTop) obj.scrollTop=obj.scrollTop+16;
      } else obj.scrollTop=obj.scrollTop-16;
    }

    var obj2=document.getElementById(vSlider);
    var obj3=document.getElementById(slideHandle);

    if ((obj2)&&(obj3))
    	obj3.style.top=Math.ceil(obj2.offsetHeight-22-((obj2.offsetHeight-22)*((obj.maxVert-obj.scrollTop)/obj.maxVert)))+"px";
	}

  function scroll3(contentId, vSlider,slideHandle, i) {
  	var obj=document.getElementById(contentId);
  	if (obj) {
  		initScrollContent(obj);
  	    if (obj.maxVert > obj.scrollTop) obj.scrollTop=(obj.scrollTop+16)*i;
    }

    var obj2=document.getElementById(vSlider);
    var obj3=document.getElementById(slideHandle);

    if ((obj2)&&(obj3))
    	obj3.style.top=Math.ceil(obj2.offsetHeight-22-((obj2.offsetHeight-22)*((obj.maxVert-obj.scrollTop)/obj.maxVert)))+"px";
	}


///////////////////////// Make Start /////////////////////////////////////////////////////////

function MakeStartFF(url){
alert('Чтобы сделать Метеонову Вашей стартовой страницей, перетащите ссылку "Сделать стартовой" на иконку с изображением домика в панели инструментов браузера');
}




function mnovaSuggest(suggestO, inputO) {
	this.suggest = suggestO;
	this.input = inputO;
	this.searchTimeout = 300;
	this.timeoutSearchHnd = null;	
	this.timeoutBlurHnd = null;	
	this.countRequest = Math.floor(Math.random() * (10000 - 1000 + 1)) + 1000;
	this.url = '/sinpl';
	this.items = null;
	this.minwidth = 0;
	this.init();
}

mnovaSuggest.prototype.init = function() {	
	this.suggest.o = document.getElementById(this.suggest.o);
	this.input.parent = document.getElementById(this.input.parent);
	var coords = this.getOffset(this.input.parent);
	this.suggest.o.style.left = coords.left+'px';	
	this.suggest.o.style.top = coords.top+this.input.parent.offsetHeight+'px';
	removeClass(this.suggest.o, 'onfocus');
	this.input.o.value = '';
	this.input.loader = document.getElementById(this.input.loader);
	var parent = this;	
	this.input.o.onblur = function(event) {parent.blur(parent)};
	this.input.o.onclick = function(event) {parent.click(parent)};
	this.input.o.onkeydown = function(event) {parent.keydown(event, parent)};	
	this.input.loader.onclick = function() {parent.loaderClick(parent)};	
}

mnovaSuggest.prototype.click = function(obj) {
	if (this.input.o.value == obj.input.defVal) this.input.o.value = '';
}

mnovaSuggest.prototype.blur = function(obj) {
	this.timeoutBlurHnd = setTimeout(function() {
		if (obj.input.o.value.length == 0) obj.input.o.value = obj.input.defVal;
		obj.suggest.o.style.width = 0;
		removeClass(obj.suggest.o, 'onfocus');
		removeClass(obj.input.loader, 'spinner');
	}, 200);
}

mnovaSuggest.prototype.redrawSuggest = function() {
	addClass(this.suggest.o, 'onfocus');
	this.suggest.o.style.width = 'auto';	
	this.minwidth = this.input.parent.offsetWidth+'px';
	if (this.suggest.o.offsetWidth < parseInt(this.minwidth.replace('px',''), 10))
		this.suggest.o.style.width = this.minwidth;
	else 
		this.suggest.o.style.width = this.suggest.o.offsetWidth;
	this.suggest.o.style.width = parseInt(this.suggest.o.style.width.replace('px', ''), 10)+'px';
	this.mouseOver(1); 
}

mnovaSuggest.prototype.loaderClick = function(obj){
	clearTimeout(obj.timeoutBlurHnd);
	if (obj.input.o.value.length == 0 || obj.input.o.value == obj.input.defVal) return;
	if (!hasClass(obj.input.loader, 'x') && !hasClass(obj.input.loader, 'spinner'))
		obj.getAjaxList();
	else if (hasClass(obj.input.loader, 'x')) {
		removeClass(obj.input.loader, 'spinner');	
		removeClass(obj.input.loader, 'x');
		obj.input.o.value = '';
		removeClass(obj.suggest.o, 'onfocus');
		obj.input.o.focus();
	}
}

mnovaSuggest.prototype.keydown = function(e, obj) {
	e = e || event;
	var code = (e.charCode) ? e.charCode : e.keyCode;
	switch(code) {
    case 13:
    	obj.mouseClick();		
    break; 			      
    case 38:
    	obj.mouseOver(-1);		
    break; 
    case 40:
    	obj.mouseOver(1);		
    break; 
    case 16: case 17: case 20: case 9: case 37: case 39: 
    break;
		default:	
			clearTimeout(obj.timeoutSearchHnd);	
			obj.getAjaxList();	
    break; 	    		      	  				
	} 	
}

mnovaSuggest.prototype.getAjaxList = function() {
	removeClass(this.suggest.o, 'onfocus');
	removeClass(this.input.loader, 'x');			
	addClass(this.input.loader, 'spinner');	
	var parent = this;		
	this.timeoutSearchHnd = setTimeout(function() {		
		if (parent.input.o.value.length==0) { 
			removeClass(parent.input.loader, 'spinner');					
			return;	
		}
		parent.countRequest++;	
		var loadData = new LoadDataSearch(parent);
		loadData.getData(parent.url+"?lang=ru&id="+parent.countRequest+"&fchar="+encodeURIComponent((parent.input.o.value)));		
	}, this.searchTimeout);	
}

mnovaSuggest.prototype.mouseClick = function() {
	for(var i=0; i<this.items.length; i++) {
		var o = document.getElementById(this.items[i].id);
		if (hasClass(o, 'onhover')) {
			if(this.items[i].type == 't')
				document.location = '/frc/'+this.items[i].id+'.htm';
			if(this.items[i].type == 'a') 
				document.location = '/avia/'+((parseInt(this.items[i].id, 10)+10000)*(-1))+'.htm';			
			if(this.items[i].type == 'c')
				document.location = '/list/countries/'+this.escape(this.items[i].name);
			if(this.items[i].type == 'd')
				document.location = '/list/regions/'+this.escape(this.items[i].id);
			if(this.items[i].type == 'mu')
				document.location = '/list/municipals/'+this.escape(this.items[i].id);			
			return;
		}			
	}
	var o = document.getElementById("err_a");
	if (o) document.location = document.getElementById("err_a").getAttribute('href');
}

mnovaSuggest.prototype.mouseOver = function(step, o) {
	if (!this.items) return;
	if (this.items.length == 0) {
		//o = document.getElementById('discript');
		//if (o) addClass(o, 'onhover');
		return;
	}
	var e = null;
	if (!o) {
		for(var i=0; i<this.items.length; i++) {
			o = document.getElementById(this.items[i].id);
			if (hasClass(o, 'onhover')) {
				e = this.items[i+step]!=undefined?this.items[i+step]:
								step==1?this.items[0]:this.items[this.items.length-1];
				this.input.o.value = e.name; 								
				break;						
			}							
		}
		if (!e) 
			e = step==1?this.items[0]:this.items[this.items.length-1];
		o = document.getElementById(e.id);			
	}
	this.mouseOut();	
	if (o) addClass(o, 'onhover');	
	if (!e) 
		for(var i=0; i<this.items.length; i++) {
			o = document.getElementById(this.items[i].id);
			if (hasClass(o, 'onhover')) {
				e = this.items[i]; 	
			}	
		}		
	if (!e) this.items[0];
				
}

mnovaSuggest.prototype.mouseOut = function() {
	var o = null;
	for(var i=0; i<this.items.length; i++) {	
		o = document.getElementById(this.items[i].id); 
		if (o) removeClass(o, 'onhover'); 
	}
}

mnovaSuggest.prototype.getSuggest = function() {
	var html = '',
		str = '',
		isCountry = false,
		isCity = false,
		isAvia = false,
		isDistrict = false,
		isMu = false,
		html = this.suggest.nulltpl;
	addClass(this.suggest.o, 'e');
	for(var i=0; i<this.items.length; i++) {
		if (i==0) html = '';
		if (this.items[i].type=='c' && isCountry == false) { 
			html +=this.suggest.tplc;
			isCountry = true;
		}				
		if (this.items[i].type=='t' && isCity == false) {
			html +=this.suggest.tplt;
			isCity = true;
		}
		if (this.items[i].type=='a' && isAvia == false) {
			html +=this.suggest.tpla;
			isAvia = true;
		}				
		if (this.items[i].type=='d' && isDistrict == false) {
			html +=this.suggest.tpld;
			isDistrict = true;
		}
		if (this.items[i].type=='mu' && isMu == false) {
			html +=this.suggest.tplmu;
			isMu = true;
		}		
	
		html += this.suggest.tpl;
		
	  do{
	  	if (!(str = html.match(/%([\w\d.]+)%/gim)))
	    	break;
	    for (var j in str){
	    	if (parseInt(j, 10) != j) continue;
	    	try {
	     		var tp=str[j].replace(/%/gi,'');
	     		if (this.items[i][tp]) {
	     		 	html = html.replace(str[j], (tp=='d_name' || tp=='mun_name')?this.items[i][tp].replace(/ /gi,'&nbsp;')+',&nbsp;':this.items[i][tp].replace(/ /gi,'&nbsp;'));     			     		}
	     		else 
	      			html = html.replace(str[j], '');
	      }
	      catch(err) {}     
	    }
	  }while(1);		
	}
	if (this.items.length>0) {
		html += '<div class="discript"><span class="all_search"><a href="/search/'+this.escape(this.input.o.value)+'">'+this.suggest.tpl_allsearch+'</a></span></div>';
		html += '<div class="discript"><span class="all_search"><a href="/mgfind.htm">Нет нужного пункта? Используйте Мегапоиск</a></span></div>';	
		removeClass(this.suggest.o, 'e');
	}
	return html;
}

function LoadDataSearch(parent) {
	this.parent = parent; 
  this.XMLObj = null;
  this.getData = function(url) {
	  try {
	  	this.XMLObj = new XMLHttpRequest();
	  } catch(err) {
	  	this.XMLObj = new ActiveXObject("Microsoft.XMLHttp");
	  }
    if (this.XMLObj) {
      this.XMLObj.onreadystatechange = this.LoadDataCallbackFunction (this.XMLObj, this.parent);    
      this.XMLObj.open("GET", url+'&r='+Math.random(), true);
    	this.XMLObj.send(null);
    }
  }

  this.LoadDataCallbackFunction = function(XMLObj, parent) {
  	return function() {
  		parent.items = {};
    	if (XMLObj.readyState == 4) {
    		if (XMLObj.status == 200) {
    			try { 
	    			var data = JSON.parse(XMLObj.responseText);
	    			parent.items = data.items;
					parent.suggest.o.innerHTML = parent.getSuggest().replace('%input.val%', parent.escape(parent.input.o.value)).replace('%input.val%', parent.input.o.value);
					parent.redrawSuggest();				
					addClass(parent.input.loader, 'x');
				}
				catch(err) {}
	      		XMLObj= null;
	      	}
		}
   	}
  }
}

mnovaSuggest.prototype.getOffset = function(elem) {
	function getOffsetSum(elem) {
	 	var top=0, left=0
	 	while(elem) {
	 		top = top + parseInt(elem.offsetTop)
	 		left = left + parseInt(elem.offsetLeft)
	 		elem = elem.offsetParent
		}
	 	return {top: top, left: left}
	}
	
	function getOffsetRect(elem) {
 	 var box = elem.getBoundingClientRect()
 	 var body = document.body
 	 var docElem = document.documentElement
 	 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 	 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 	 var clientTop = docElem.clientTop || body.clientTop || 0
 	 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 	 var top = box.top + scrollTop - clientTop
 	 var left = box.left + scrollLeft - clientLeft
 	 return { top: Math.round(top), left: Math.round(left) }
	}	
	
	if (elem.getBoundingClientRect)
		return getOffsetRect(elem)
	else
	 	return getOffsetSum(elem)
}

function getNavigatorName() {
	var useragent=navigator.userAgent;
	var navigatorname;
	if (useragent.indexOf('MSIE')!= -1) {
	    navigatorname="MSIE";
	}
	else if (useragent.indexOf('Gecko')!= -1) {
	    if (useragent.indexOf('Chrome')!= -1)
	    navigatorname="Chrome";
	    else navigatorname="Mozilla";
	}
	else if (useragent.indexOf('Mozilla')!= -1) {
	    navigatorname="old Netscape or Mozilla";
	}
	else if (useragent.indexOf('Opera')!= -1) {
	    navigatorname="Opera";
	}
	return navigatorname.toLowerCase();
}

function addClass(o, c){
	if (!o) return;
	var re = new RegExp("(^|\\s)" + c + "(\\s|$)", "g");
	if (re.test(o.className)) return
	o.className = (o.className + " " + c).replace(/\s+/g, " ").replace(/(^ | $)/g, "");
}
  
function removeClass(o, c){
	if (!o) return;	
	var re = new RegExp("(^|\\s)" + c + "(\\s|$)", "g");
	o.className = o.className.replace(re, "$1").replace(/\s+/g, " ").replace(/(^ | $)/g, "");
}

function hasClass(o, c) {
	if (!o) return '';	
	return o.className.match(new RegExp('(\\s|^)'+c+'(\\s|$)'));
}

mnovaSuggest.prototype.escape = function(str) {
	var trans = [];
	for (var i = 0x410; i <= 0x44F; i++) trans[i] = i - 0x350; // A-?a-y
	trans[0x401] = 0xA8;    // ?
	trans[0x451] = 0xB8;    // ?
	trans[0x457] = 0xBF;    // ?
	trans[0x407] = 0xAF;    // ?
	trans[0x456] = 0xB3;    // ?
	trans[0x406] = 0xB2;    // ?
	trans[0x404] = 0xBA;    // ?
	trans[0x454] = 0xAA;    // ?
	
  var res='';
  for (var i = 0; i < str.length; i++) {
    var n = str.charCodeAt(i);
    if (typeof trans[n] != 'undefined') {
      n = trans[n];
      res=res+escape(String.fromCharCode(n));
    }
    else {
      n = str.charAt(i);
      res=res+n;
    }
  }
  return res;
}
var Scroll = function(par) {
	this.scrollObj = document.getElementById(par.scrollObjId);
	this.delta = par.delta;
	this.min_delta = par.delta;
	this.step = par.step;
	this.requestId = 0;
	this.init = function(par) {
		var _this = this;
		if ( !window.requestAnimationFrame ) {
		  window.requestAnimationFrame = ( function() {
		    return window.webkitRequestAnimationFrame ||
		    window.mozRequestAnimationFrame ||
		    window.oRequestAnimationFrame ||
		    window.msRequestAnimationFrame ||
		    function( /* function FrameRequestCallback */ callback, /* DOMElement Element */ element ) {
		      var requestId = window.setTimeout(callback, 1000/60);
		      return requestId;
		    };
		  })();
    	if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function(id) {
            clearTimeout(id);
        };		  
		}
		this.isTouch = this.detectTouch();
		if (this.isTouch) this.step = this.step.touch;
		else this.step = this.step.normal; 
		this.callbacks = {left: par.doLeft, right: par.doRight, top: par.doTop, bottom: par.doBottom};	
		this.bindEvents(par.leftBtns, par.doLeft, 0);
		this.bindEvents(par.rightBtns, par.doRight, 1);
		this.bindEvents(par.topBtns, par.doTop, 0);
		this.bindEvents(par.bottomBtns, par.doBottom, 1);
		this.bindEventScrollObj({left: par.doLeft, right: par.doRight, top: par.doTop, bottom: par.doBottom});
	}		
	this.bindEvents = function(btns, callback, _forward) {
		var _this = this;
		btns = this.getBnts(btns);
		for (var i=0; i < btns.length; i++) {
			if (this.isTouch) {
				btns[i].onclick = function(evt) {
					//evt.preventDefault();
					cancelAnimationFrame(_this.requestId);
					_this.delta = par.doLeft || par.doRigh?(_this.scrollObj.offsetWidth-1):_this.scrollObj.offsetHeight;
					var delta = 0;
					_this.animate(delta, _this.step, callback);				
				};							
			}	
			else {
				btns[i].onmouseover = function() {
					cancelAnimationFrame(_this.requestId);
					var pos = par.doLeft || par.doRigh?_this.scrollObj.scrollLeft:_this.scrollObj.scrollTop;
					var l = par.doLeft || par.doRigh?_this.scrollObj.scrollWidth:_this.scrollObj.scrollHeight;
					_this.delta = _forward == 0?pos:(l - pos);
					_this.animate(0, _this.step, callback);
				};
				btns[i].onmouseout = function() {
					cancelAnimationFrame(_this.requestId);
					_this.delta = _this.min_delta;
					var pos = par.doLeft || par.doRigh?_this.scrollObj.scrollLeft:_this.scrollObj.scrollTop;
					var delta = (_forward == 1?pos % _this.delta:(_this.delta - pos % _this.delta));
					_this.animate(delta, _this.step, callback);
				}
			}		
		}		
	}
	this.bindEventScrollObj = function(actions) {
		var _this = this;
		var touchPos = {
			touchstart: {x: 0, y: 0, _scroll: {_left: 0}},
			touchmove: {x: 0, y: 0}
		};
		if (this.isTouch) {
			this.scrollObj.addEventListener("touchstart",  function(evt) {
				//evt.preventDefault();
				cancelAnimationFrame(_this.requestId);				
				var touch = evt.touches[0];
				touchPos.touchstart = {x: touch.pageX, y: touch.pageY, _scroll:{_left: _this.scrollObj.scrollLeft}};
				touchPos.touchmove = {x: 0, y: 0};
			}, false);
			
			this.scrollObj.addEventListener('touchmove', function(evt) {
				evt.preventDefault();
				cancelAnimationFrame(_this.requestId);			
				var touch = evt.touches[0];
				if (touchPos.touchmove.x != 0) {
					var callback = touch.pageX < touchPos.touchmove.x?actions.right:actions.left;
					var delta = Math.abs(touch.pageX-touchPos.touchmove.x);
					touchPos.touchmove = {x: touch.pageX, y: touch.pageY};
					_this.delta = _this.min_delta;
					callback(_this.scrollObj, delta);
				}
				else touchPos.touchmove = {x: touch.pageX, y: touch.pageY};				
			}, false);
			
			this.scrollObj.addEventListener('touchend', function(evt) {
				evt.preventDefault();	
				cancelAnimationFrame(_this.requestId);
				var _forward = touchPos.touchmove.x < touchPos.touchstart.x?1:0; 							
				var callback = touchPos.touchmove.x < touchPos.touchstart.x?actions.right:actions.left;
				var delta = Math.abs(touchPos.touchstart._scroll._left - _this.scrollObj.scrollLeft);
				var mod = delta<_this.delta?delta:delta%_this.delta;   
				_this.animate(mod, _this.step*2, callback);
			}, false);
		}
		else {
  		_this.addHandler(_this.scrollObj, 'DOMMouseScroll', _this.wheel);
  		_this.addHandler(_this.scrollObj, 'mousewheel', _this.wheel);					
		}
	}
	this.wheel = function(evt, context) {
		evt = evt || window.event;
    if (evt.preventDefault) evt.preventDefault();
    evt.returnValue = false;
    var delta;
    if (evt.wheelDelta) { // В Opera и IE
      delta = evt.wheelDelta / 120;
      //if (window.opera) delta = -delta; // Дополнительно для Opera
    }
    else if (evt.detail) { // Для Gecko
      delta = -evt.detail / 3;
    }
    cancelAnimationFrame(context.requestId);
    if (context.callbacks.left || context.callbacks.right) var callback = (delta>=0?context.callbacks.left:context.callbacks.right);
    if (context.callbacks.bottom || context.callbacks.top) var callback = (delta>=0?context.callbacks.top:context.callbacks.bottom);
		callback(context.scrollObj, context.min_delta);
	}
	this.jump = function(curSegment, newSegment) {
		if (curSegment == newSegment) return;
		cancelAnimationFrame(this.requestId);
		var callback = par.doRight;
		this.delta = Math.abs(newSegment*this.scrollObj.offsetWidth - this.scrollObj.scrollLeft);
		if (newSegment < curSegment) callback = par.doLeft;
		var step = 25*Math.abs(newSegment - curSegment);
		this.animate(0, step, callback);
	}
	this.getBnts = function(btns) {
		var a = [];
		if (btns)
			for (var i = 0; i<btns.length; i++) {
				a[i] = 	document.getElementById(btns[i]);
			}
		return a;
	}
	this.animate = function(delta, defStep, callback) {
		var _this = this;
		if (delta<this.delta) {
			var step = defStep;
 			if (delta + defStep>=this.delta) step = this.delta -	delta;
 			callback(this.scrollObj, step);
 			delta += defStep;
 			this.requestId = requestAnimationFrame(function(){_this.animate(delta, defStep, callback)});
		}
	}
	this.detectTouch = function() {
		var isTouch = false;
		if ("ontouchstart" in window || navigator.msMaxTouchPoints) isTouch = true;
		return isTouch;
	}
	this.addHandler = function(object, event, handler) {
		var _this = this;
    if (object.addEventListener) {
      object.addEventListener(event, function(event){handler(event, _this)}, false);
    }
    else if (object.attachEvent) {
      object.attachEvent('on' + event, handler);
    }
	}
	this.addHandler = function(object, event, handler) {
		var _this = this;
    if (object.addEventListener) {
      object.addEventListener(event, function(event){handler(event, _this)}, false);
    }
    else if (object.attachEvent) {
      object.attachEvent('on' + event, handler);
    } 
	}	
	this.init(par);
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJtZXRlb25vdmEubW9udGgubWluLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vLy9HcmFwaGljcy8vL1xyXG5cclxuZnVuY3Rpb24gc2V0UHJlbG9hZGVyUGljdChwYXJlbnRJZCxwcmVsb2FkZXJJZCxwcmVsb2FkZXJTdHlsZSl7XHJcbiAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgZGl2LnNldEF0dHJpYnV0ZSgnaWQnLCBwcmVsb2FkZXJJZCk7XHJcbiAgdmFyIHMgPSBkaXYuc3R5bGU7XHJcbiAgcy5wb3NpdGlvbiA9IFwiYWJzb2x1dGVcIjtcclxuICBzLnpJbmRleD0xMjtcclxuICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChwYXJlbnRJZCkuYXBwZW5kQ2hpbGQoZGl2KTtcclxuICBpZiAocHJlbG9hZGVyU3R5bGU9PVwibWluaVwiKVxyXG4gIFx0ZGl2LmlubmVySFRNTD1cIjxpbWcgc3JjPVxcXCIvaW1hZ2VzL2FqYXgtbWluaWxvYWRlci5naWZcXFwiIHdpZHRoPVxcXCIxNlxcXCIgaGVpZ2h0PVxcXCIxNlxcXCIgLz5cIjtcclxuICBlbHNlIGRpdi5pbm5lckhUTUw9XCI8aW1nIHNyYz1cXFwiL2ltYWdlcy9hamF4LWxvYWRlci5naWZcXFwiIHdpZHRoPVxcXCI5M1xcXCIgaGVpZ2h0PVxcXCIyNlxcXCIgLz5cIjtcclxuICByZXR1cm4gZGl2O1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRQb3MoZWwsc1Byb3ApIHtcclxuXHR2YXIgaVBvcyA9IDA7XHJcblx0d2hpbGUgKGVsIT1udWxsKSB7XHJcblx0XHRpUG9zKz1lbFtcIm9mZnNldFwiICsgc1Byb3BdXHJcblx0XHRlbCA9IGVsLm9mZnNldFBhcmVudDtcclxuXHR9XHJcblx0cmV0dXJuIGlQb3NcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0T2Zmc2V0KGVsZW0pIHtcclxuIGlmIChlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCkge1xyXG4gcmV0dXJuIGdldE9mZnNldFJlY3QoZWxlbSlcclxuIH0gZWxzZSB7XHJcbiByZXR1cm4gZ2V0T2Zmc2V0U3VtKGVsZW0pXHJcbiB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldE9mZnNldFN1bShlbGVtKSB7XHJcbiB2YXIgdG9wPTAsIGxlZnQ9MFxyXG4gd2hpbGUoZWxlbSkge1xyXG4gdG9wID0gdG9wICsgcGFyc2VJbnQoZWxlbS5vZmZzZXRUb3ApXHJcbiBsZWZ0ID0gbGVmdCArIHBhcnNlSW50KGVsZW0ub2Zmc2V0TGVmdClcclxuIGVsZW0gPSBlbGVtLm9mZnNldFBhcmVudFxyXG4gfVxyXG4gXHJcbiByZXR1cm4ge3RvcDogdG9wLCBsZWZ0OiBsZWZ0fVxyXG59XHJcbiBcclxuXHJcbmZ1bmN0aW9uIGdldE9mZnNldFJlY3QoZWxlbSkge1xyXG4gdmFyIGJveCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcclxuIHZhciBib2R5ID0gZG9jdW1lbnQuYm9keVxyXG4gdmFyIGRvY0VsZW0gPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnRcclxuIFxyXG4gdmFyIHNjcm9sbFRvcCA9IHdpbmRvdy5wYWdlWU9mZnNldCB8fCBkb2NFbGVtLnNjcm9sbFRvcCB8fCBib2R5LnNjcm9sbFRvcFxyXG4gdmFyIHNjcm9sbExlZnQgPSB3aW5kb3cucGFnZVhPZmZzZXQgfHwgZG9jRWxlbS5zY3JvbGxMZWZ0IHx8IGJvZHkuc2Nyb2xsTGVmdFxyXG4gXHJcbiB2YXIgY2xpZW50VG9wID0gZG9jRWxlbS5jbGllbnRUb3AgfHwgYm9keS5jbGllbnRUb3AgfHwgMFxyXG4gdmFyIGNsaWVudExlZnQgPSBkb2NFbGVtLmNsaWVudExlZnQgfHwgYm9keS5jbGllbnRMZWZ0IHx8IDBcclxuIFxyXG4gdmFyIHRvcCA9IGJveC50b3AgKyBzY3JvbGxUb3AgLSBjbGllbnRUb3BcclxuIHZhciBsZWZ0ID0gYm94LmxlZnQgKyBzY3JvbGxMZWZ0IC0gY2xpZW50TGVmdFxyXG4gXHJcbiByZXR1cm4geyB0b3A6IE1hdGgucm91bmQodG9wKSwgbGVmdDogTWF0aC5yb3VuZChsZWZ0KSB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNldFByZWxvYWRlclN0eWxlKHBhcmVudERpdixwcmVsb2FkZXJEaXYpe1xyXG5cdHZhciBkaXY9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocHJlbG9hZGVyRGl2KTtcclxuXHR2YXIgcGRpdj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChwYXJlbnREaXYpO1xyXG5cdGRpdi5zdHlsZS5sZWZ0PU1hdGgucm91bmQocGRpdi5vZmZzZXRXaWR0aC8yKS1NYXRoLnJvdW5kKGRpdi5vZmZzZXRXaWR0aC8yKStcInB4XCI7XHJcblxyXG5cdGlmICgocGFyZW50RGl2PT1cInRvd25zQ29udGFpbmVyXCIpICYmIChwZGl2LmNsYXNzTmFtZT09XCJ0b3duc0NvbnRhaW5lck1haW5cIikpXHJcblx0XHRkaXYuc3R5bGUudG9wPU1hdGgucm91bmQocGRpdi5vZmZzZXRIZWlnaHQvMiktTWF0aC5yb3VuZChkaXYub2Zmc2V0SGVpZ2h0LzIpK1wicHhcIjtcclxuXHRlbHNlXHJcblx0XHRkaXYuc3R5bGUudG9wPU1hdGgucm91bmQocGRpdi5vZmZzZXRIZWlnaHQvMikrMTUtTWF0aC5yb3VuZChkaXYub2Zmc2V0SGVpZ2h0LzIpK1wicHhcIjtcclxufVxyXG5cclxuZnVuY3Rpb24gaW5pdFByZWxvYWRlcihwYXJlbnRJZCwgcHJlbG9hZGVySWQscHJlbG9hZGVyU3R5bGUpIHtcclxuXHR2YXIgcG9iaj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChwYXJlbnRJZCk7XHJcblxyXG5cdHZhciBvYmo9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocHJlbG9hZGVySWQpO1xyXG5cdGlmICghb2JqKSB7XHJcblxyXG5cdFx0b2JqPXNldFByZWxvYWRlclBpY3QocGFyZW50SWQscHJlbG9hZGVySWQscHJlbG9hZGVyU3R5bGUpO1xyXG5cdFx0c2V0UHJlbG9hZGVyU3R5bGUocGFyZW50SWQscHJlbG9hZGVySWQpO1xyXG5cclxuXHR9XHJcblxyXG5cdG9iai5zdHlsZS52aXNpYmlsaXR5PVwidmlzaWJsZVwiO1xyXG59XHJcblxyXG5mdW5jdGlvbiBHcmFwaE9iaih0b3duaW5kZXgsZ2Vvc3VmZml4KSB7XHJcblxyXG5cdHZhciBncmFwaCA9IHRoaXM7XHJcblx0Z3JhcGguX3Rvd25pbmRleD10b3duaW5kZXg7XHJcblx0Z3JhcGguX2FyckdyYXBoTmFtZT1uZXcgQXJyYXkoXCJQXCIsXCJUXCIsXCJSXCIsXCJXXCIpO1xyXG5cdGdyYXBoLl9uPWdyYXBoLl9hcnJHcmFwaE5hbWUubGVuZ3RoO1xyXG5cdGdyYXBoLl9hcnJHcmFwaFBpYz1uZXcgQXJyYXkoKTtcclxuXHRncmFwaC5fbGFzdFNob3dHcmFwaGljPTA7XHJcblx0Z3JhcGguX2dyYXBoaWNUaW1lcj1udWxsO1xyXG5cclxuXHRncmFwaC5wcmVsb2FkR3JhcGg9ZnVuY3Rpb24oKSB7XHJcblx0XHR2YXIgaz0wO1xyXG5cdFx0Zm9yICh2YXIgaT1udW1GUkMqZ3JhcGguX247IGk8KG51bUZSQysxKSpncmFwaC5fbjsgaSsrKXtcclxuXHRcdFx0aWYgKGdyYXBoLl9hcnJHcmFwaFBpY1tpXT09bnVsbCkge1xyXG5cdFx0XHRcdGdyYXBoLl9hcnJHcmFwaFBpY1tpXT1uZXcgSW1hZ2UoKTtcclxuXHRcdFx0XHRncmFwaC5fYXJyR3JhcGhQaWNbaV0uc3JjPVwiaHR0cDovL3d3dy5tZXRlb25vdmEucnUvaW1hZ2VzL2dyYXBoaWNzL1wiK2dyYXBoLl9hcnJHcmFwaE5hbWVba10rXCJHXCIrZ3JhcGguX3Rvd25pbmRleCtcIl8xXCIrbnVtRlJDK1wiLnBuZ1wiK2dlb3N1ZmZpeDtcclxuXHRcdFx0XHRncmFwaC5fYXJyR3JhcGhQaWNbaV0ub25Mb2FkPWdyYXBoLmluaXRHcmFwaGljKGkpO1xyXG5cdFx0ICB9XHJcblx0XHQgIGsrKztcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdGdyYXBoLnByZWxvYWRHcmFwaGljPWZ1bmN0aW9uKGspIHtcclxuXHRcdHZhciBpPW51bUZSQypncmFwaC5fbitrO1xyXG5cdFx0aWYgKGdyYXBoLl9hcnJHcmFwaFBpY1tpXT09bnVsbCkge1xyXG5cdFx0XHRncmFwaC5fYXJyR3JhcGhQaWNbaV09bmV3IEltYWdlKCk7XHJcblx0XHRcdGdyYXBoLl9hcnJHcmFwaFBpY1tpXS5zcmM9XCJodHRwOi8vd3d3Lm1ldGVvbm92YS5ydS9pbWFnZXMvZ3JhcGhpY3MvXCIrZ3JhcGguX2FyckdyYXBoTmFtZVtrXStcIkdcIitncmFwaC5fdG93bmluZGV4K1wiXzFcIitudW1GUkMrXCIucG5nXCIrZ2Vvc3VmZml4O1xyXG5cdFx0XHRncmFwaC5fYXJyR3JhcGhQaWNbaV0ub25Mb2FkPWdyYXBoLmluaXRHcmFwaGljKGkpO1xyXG5cdFx0ICB9XHJcblx0fVxyXG5cclxuXHRncmFwaC5pbml0R3JhcGhpYz1mdW5jdGlvbihpKSB7XHJcblx0XHRpZiAoIWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZ3JhcGhcIitpKSkge1xyXG5cdCAgXHRcdHZhciBpbWc9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJpbWdcIik7XHJcblx0XHRcdFx0aW1nLnNldEF0dHJpYnV0ZShcImlkXCIsIFwiZ3JhcGhcIitpKTtcclxuXHQgIFx0XHRpbWcuc3JjPWdyYXBoLl9hcnJHcmFwaFBpY1tpXS5zcmM7XHJcblx0XHRcdFx0dmFyIHMgPSBpbWcuc3R5bGU7XHJcblx0XHRcdFx0cy50b3A9MDtcclxuXHQgIFx0XHRzLmxlZnQ9MDtcclxuXHQgIFx0XHRzLnZpc2liaWxpdHkgPSBcImhpZGRlblwiO1xyXG5cdCAgXHRcdHMucG9zaXRpb24gPSBcImFic29sdXRlXCI7XHJcblx0ICBcdFx0cy56SW5kZXg9MTI7XHJcblx0XHRcdGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdncmFwaGljJykuYXBwZW5kQ2hpbGQoaW1nKTtcclxuXHQgIH1cclxuXHR9XHJcblxyXG5cdGdyYXBoLnNob3dHcmFwaGljPWZ1bmN0aW9uKGVsLGdyYXBoX251bSkge1xyXG5cdFx0Y2xlYXJUaW1lb3V0KGdyYXBoLl9ncmFwaGljVGltZXIpO1xyXG4gXHRcdHZhciBvYmo9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJncmFwaGljXCIpO1xyXG4gICBcdFx0aWYgKG9iaikge1xyXG4vLyAgICBcdFx0b2JqLnN0eWxlLmxlZnQgPSBnZXRQb3MoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ0ZDJcIiksXCJMZWZ0XCIpO1xyXG4vLyAgICAgXHRcdG9iai5zdHlsZS50b3AgPSAgZ2V0UG9zKGVsLFwiVG9wXCIpK2VsLm9mZnNldEhlaWdodCtcInB4XCI7XHJcblx0XHRvYmouc3R5bGUubGVmdCA9IGdldE9mZnNldChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImZyY19jb250XCIpKS5sZWZ0K1wicHhcIjtcclxuXHRcdG9iai5zdHlsZS50b3AgPSAgZ2V0T2Zmc2V0KGVsKS50b3ArZWwub2Zmc2V0SGVpZ2h0K1wicHhcIjtcclxuICAgICBcdFx0b2JqLnN0eWxlLnZpc2liaWxpdHkgPSBcInZpc2libGVcIjtcclxuICAgIFx0fVxyXG5cclxuICAgIHZhciBkaXY9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJncmFwaFwiK2dyYXBoLl9sYXN0U2hvd0dyYXBoaWMpO1xyXG4gICAgaWYgKGRpdikgZGl2LnN0eWxlLnZpc2liaWxpdHk9XCJoaWRkZW5cIjtcclxuXHJcbiAgICBkaXY9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJncmFwaFwiK2dyYXBoX251bSk7XHJcbiAgIFx0aWYgKGRpdikge1xyXG4gICBcdFx0ZGl2LnN0eWxlLnZpc2liaWxpdHk9XCJ2aXNpYmxlXCI7XHJcbiAgIFx0XHRncmFwaC5fbGFzdFNob3dHcmFwaGljPWdyYXBoX251bTtcclxuICAgXHR9XHJcbiAgfVxyXG5cclxuICBncmFwaC5oaWRlR3JhcGhpYz1mdW5jdGlvbigpe1xyXG5cdGNsZWFyVGltZW91dChncmFwaC5fZ3JhcGhpY1RpbWVyKTtcclxuICAgIHZhciBkaXY9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJncmFwaFwiK2dyYXBoLl9sYXN0U2hvd0dyYXBoaWMpO1xyXG4gICAgaWYgKGRpdikgZGl2LnN0eWxlLnZpc2liaWxpdHk9XCJoaWRkZW5cIjtcclxuICAgIGRpdj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImdyYXBoaWNcIik7XHJcbiAgICBpZiAoZGl2KSBkaXYuc3R5bGUudmlzaWJpbGl0eSA9IFwiaGlkZGVuXCI7XHJcbiAgfVxyXG5cclxuICBncmFwaC50aW1lckhpZGVHcmFwaGljPWZ1bmN0aW9uKCkge1xyXG4gIFx0Z3JhcGguX2dyYXBoaWNUaW1lcj1zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7Z3JhcGguaGlkZUdyYXBoaWMoKTt9LDEwMDApO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbi8vLy8gSGludHMgLy8vLy9cclxuXHJcbnZhciBoaW50VGltZW91dHMgPSBuZXcgQXJyYXkoKTtcclxuXHJcbmZ1bmN0aW9uIHNob3dIaW50KHBhcmVudE9iaiwgaWQsIGJWaXNpYmxlLCB3aWR0aCkge1xyXG5cdGlkID0gaWQudG9TdHJpbmcoKTtcclxuXHR2YXIgb2JqID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJoaW50X2NvbnRlbnRfXCIraWQpO1xyXG5cdGlmICghb2JqKSBpbml0SGludChpZCwgd2lkdGgpO1xyXG5cclxuXHR2YXIgaGludE9iaiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTtcclxuXHRpZiAoaGludE9iaikge1xyXG4gICAgaGludE9iai5zdHlsZS5sZWZ0PWdldFBvcyhwYXJlbnRPYmosXCJMZWZ0XCIpKzIrXCJweFwiO1xyXG4gICAgaGludE9iai5zdHlsZS50b3AgPSAgZ2V0UG9zKHBhcmVudE9iaixcIlRvcFwiKStwYXJlbnRPYmoub2Zmc2V0SGVpZ2h0KzIrXCJweFwiO1xyXG4gICAgc2V0VGltZW91dEhpbnQoaGludE9iaiwgYlZpc2libGUpO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gc2V0VGltZW91dEhpbnQoaGludE9iaiwgYlZpc2libGUpIHtcclxuXHR2YXIgaWQgPSBoaW50T2JqLmdldEF0dHJpYnV0ZShcImlkXCIpLnRvU3RyaW5nKCk7XHJcblx0dmFyIGhpbnRUaW1lb3V0ID0gaGludFRpbWVvdXRzW2lkXTtcclxuXHRjbGVhclRpbWVvdXQoaGludFRpbWVvdXQpO1xyXG4gIGhpbnRUaW1lb3V0c1tpZF0gPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xyXG4gIFx0XHRpZiAoYlZpc2libGUpIGhpbnRPYmouc3R5bGUudmlzaWJpbGl0eT1cInZpc2libGVcIjtcclxuICBcdFx0ZWxzZSBoaW50T2JqLnN0eWxlLnZpc2liaWxpdHk9XCJoaWRkZW5cIjtcclxuICAgIH0sXHJcbiAgICA1MDBcclxuICApO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpbml0TW9kYWxXbmQoaWQsIHdpZHRoLCBiVmlzaWJsZSwgY2FsbGJhY2tmdW5jdGlvbikge1xyXG5cdHZhciBvYmogPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImhpbnRfY29udGVudF9cIitpZCk7XHJcblx0aWYgKCFvYmopIGluaXRIaW50KGlkLCB3aWR0aCwgY2FsbGJhY2tmdW5jdGlvbik7XHJcblx0dmFyIG92U3R5bGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIm92ZXJsYXlcIikuc3R5bGU7XHJcblx0bW9kYWxXbmRTdHlsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKS5zdHlsZTtcclxuXHRpZiAoYlZpc2libGUpIHtcclxuXHRcdG92U3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcclxuXHRcdG1vZGFsV25kU3R5bGUudmlzaWJpbGl0eSA9IFwidmlzaWJsZVwiO1xyXG5cdFx0dXBkYXRlTW9kYWxXbmQoKTtcclxuXHRcdGlmIChiSUUpIHdpbmRvdy5hdHRhY2hFdmVudCgnb25zY3JvbGwnLCB1cGRhdGVNb2RhbFduZCk7XHJcblx0fVxyXG5cdGVsc2Uge1xyXG5cdFx0b3ZTdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XHJcblx0XHRtb2RhbFduZFN0eWxlLnZpc2liaWxpdHkgPSBcImhpZGRlblwiO1xyXG5cdFx0d2luZG93LmRldGFjaEV2ZW50KCdvbnNjcm9sbCcsIHVwZGF0ZU1vZGFsV25kKTtcclxuXHR9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZU1vZGFsV25kKCkge1xyXG5cdHZhciBkdG9wID0gLTEwMDtcclxuXHR2YXIgZGR0b3AgPSAwO1xyXG5cdHZhciBjbGllbnRXaWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoIHx8IChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoKSB8fCBkb2N1bWVudC5ib2R5LmNsaWVudFdpZHRoO1x0XHJcblx0dmFyIGNsaWVudEhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQpIHx8IGRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0O1xyXG5cdHZhciBvdlN0eWxlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJvdmVybGF5XCIpLnN0eWxlO1xyXG5cdHZhciBtb2RhbFduZFN0eWxlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21vZGFsV25kJykuc3R5bGU7XHJcblx0aWYgKGJJRSlcclxuXHRcdGRkdG9wID0gd2luZG93LnBhZ2VZT2Zmc2V0IHx8IChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCkgfHwgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3A7IFxyXG4gIG1vZGFsV25kU3R5bGUubGVmdCA9IGNsaWVudFdpZHRoLzItcGFyc2VJbnQobW9kYWxXbmRTdHlsZS53aWR0aCwgMTApLzI7XHJcbiAgbW9kYWxXbmRTdHlsZS50b3AgPSBNYXRoLnJvdW5kKGNsaWVudEhlaWdodC8yLXBhcnNlSW50KG1vZGFsV25kU3R5bGUuaGVpZ2h0LCAxMCkvMikrZGR0b3ArZHRvcDtcclxuXHRvdlN0eWxlLnRvcCA9IGRkdG9wO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpbml0SGludChpZCwgd2lkdGgsIGNhbGxiYWNrZnVuY3Rpb24pIHtcclxuXHR2YXIgaW1nVXJsID0gXCIvaW1hZ2VzL2hpbnRzXCI7XHJcblx0dmFyIGhpbnRPYmogPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7XHJcblx0aWYgKGhpbnRPYmopIHtcclxuXHRcdHZhciBjb250ZW50ID0gaGludE9iai5pbm5lckhUTUw7XHJcblx0XHR2YXIgaGludEJsb2NrID0gXCI8ZGl2PlwiO1xyXG5cdFx0aGludEJsb2NrKz1cIjxkaXYgY2xhc3M9J2hpbnRfdG9wX2xlZnQnPjxpbWcgc3JjPSdcIitpbWdVcmwrXCIvaGludF90b3BfbGVmdC5wbmcnIHdpZHRoPScxNScgaGVpZ2h0PScxOCcgY2xhc3M9J2Nvcm5lcicgb25Mb2FkPSd0cmFuc3BhcmVudCh0aGlzKSc+PC9kaXY+XCI7XHJcblx0XHRoaW50QmxvY2srPVwiPGRpdiBjbGFzcz0naGludF90b3BfY2VudGVyJyBzdHlsZT0nd2lkdGg6IFwiK3dpZHRoK1wicHg7Jz48L2Rpdj5cIjtcclxuXHRcdGhpbnRCbG9jays9XCI8ZGl2IGNsYXNzPSdoaW50X3RvcF9yaWdodCc+PGltZyBzcmM9J1wiK2ltZ1VybCtcIi9oaW50X3RvcF9yaWdodC5wbmcnIHdpZHRoPScyMycgaGVpZ2h0PScxOCcgY2xhc3M9J2Nvcm5lcicgb25Mb2FkPSd0cmFuc3BhcmVudCh0aGlzKSc+PC9kaXY+XCI7XHJcblx0XHRoaW50QmxvY2srPVwiPC9kaXY+XCI7XHJcbiAgICBoaW50QmxvY2srPVwiPGRpdj5cIjtcclxuXHRcdGhpbnRCbG9jays9XCI8ZGl2IGNsYXNzPSdoaW50X2JvZHlfbGVmdCcgaWQ9J2hpbnRfYm9keV9sZWZ0XCIraWQrXCInPjxpbWcgc3JjPSdcIitpbWdVcmwrXCIvaGludF9ib2R5X2xlZnQucG5nJyBpZD0naW1nX2hpbnRfYm9keV9sZWZ0XCIraWQrXCInIHdpZHRoPTE1IG9uTG9hZD0ndHJhbnNwYXJlbnQodGhpcyknPjwvZGl2PlwiO1xyXG5cdFx0dmFyIGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21vZGFsV25kJyk7XHRcclxuXHRcdGlmIChjYWxsYmFja2Z1bmN0aW9uICYmIGVsKSBoaW50QmxvY2srPVwiPGRpdiBjbGFzcz0naGludF9ib2R5X2NlbnRlcicgaWQ9J2hpbnRfY29udGVudF9cIitpZCtcIicgc3R5bGU9J3dpZHRoOiBcIit3aWR0aCtcInB4OyBiYWNrZ3JvdW5kLWNvbG9yOiAjZjhmOWZkJz5cIitjb250ZW50K1wiPGRpdiBjbGFzcz0nYnRuLWNsb3NlJz48YSBocmVmPSdqYXZhc2NyaXB0OmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFxcXCJNb2RhbFduZEJ0bkNhbnNlbFxcXCIpLm9uY2xpY2soKSc+PC9hPjwvZGl2PjwvZGl2PlwiO1xyXG5cdFx0ZWxzZSBoaW50QmxvY2srPVwiPGRpdiBjbGFzcz0naGludF9ib2R5X2NlbnRlcicgaWQ9J2hpbnRfY29udGVudF9cIitpZCtcIicgc3R5bGU9J3dpZHRoOiBcIit3aWR0aCtcInB4OyBiYWNrZ3JvdW5kLWNvbG9yOiAjZjhmOWZkJz5cIitjb250ZW50K1wiPC9kaXY+XCI7IFxyXG5cdFx0aGludEJsb2NrKz1cIjxkaXYgY2xhc3M9J2hpbnRfYm9keV9yaWdodCcgIGlkPSdoaW50X2JvZHlfcmlnaHRcIitpZCtcIic+PGltZyBzcmM9J1wiK2ltZ1VybCtcIi9oaW50X2JvZHlfcmlnaHQucG5nJyBpZD0naW1nX2hpbnRfYm9keV9yaWdodFwiK2lkK1wiJyB3aWR0aD0yMyBvbkxvYWQ9J3RyYW5zcGFyZW50KHRoaXMpJz48L2Rpdj5cIjtcclxuXHRcdGhpbnRCbG9jays9XCI8L2Rpdj5cIjtcclxuICAgIGhpbnRCbG9jays9IFwiPGRpdiBzdHlsZT1cXFwibWFyZ2luLXRvcDogLTJweDtcXFwiPlwiO1xyXG5cdFx0aGludEJsb2NrKz1cIjxkaXYgY2xhc3M9J2hpbnRfYm90dG9tX2xlZnQnPjxpbWcgc3JjPSdcIitpbWdVcmwrXCIvaGludF9ib3R0b21fbGVmdC5wbmcnIHdpZHRoPScxNScgaGVpZ2h0PScxOCcgY2xhc3M9J2Nvcm5lcicgb25Mb2FkPSd0cmFuc3BhcmVudCh0aGlzKSc+PC9kaXY+XCI7XHJcblx0XHRoaW50QmxvY2srPVwiPGRpdiBjbGFzcz0naGludF9ib3R0b21fY2VudGVyJyBzdHlsZT0nd2lkdGg6IFwiK3dpZHRoK1wicHg7Jz48L2Rpdj5cIjtcclxuXHRcdGhpbnRCbG9jays9XCI8ZGl2IGNsYXNzPSdoaW50X2JvdHRvbV9yaWdodCc+PGltZyBzcmM9J1wiK2ltZ1VybCtcIi9oaW50X2JvdHRvbV9yaWdodC5wbmcnIHdpZHRoPScyMycgaGVpZ2h0PScxOCcgY2xhc3M9J2Nvcm5lcicgb25Mb2FkPSd0cmFuc3BhcmVudCh0aGlzKSc+PC9kaXY+XCI7XHJcblx0XHRoaW50QmxvY2srPVwiPC9kaXY+XCI7XHJcblx0XHRoaW50T2JqLmlubmVySFRNTCA9IGhpbnRCbG9jaztcclxuXHRcdHZhciBjb250ZW50X2hlaWdodCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiaGludF9jb250ZW50X1wiK2lkKS5vZmZzZXRIZWlnaHQ7XHJcblx0XHRkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImltZ19oaW50X2JvZHlfbGVmdFwiK2lkKS5zdHlsZS5oZWlnaHQgPSBjb250ZW50X2hlaWdodCsncHgnO1xyXG5cdFx0ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJpbWdfaGludF9ib2R5X3JpZ2h0XCIraWQpLnN0eWxlLmhlaWdodCA9IGNvbnRlbnRfaGVpZ2h0KydweCc7XHJcblx0XHRkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImhpbnRfYm9keV9sZWZ0XCIraWQpLnN0eWxlLmhlaWdodCA9IGNvbnRlbnRfaGVpZ2h0KydweCc7XHJcblx0XHRkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImhpbnRfYm9keV9yaWdodFwiK2lkKS5zdHlsZS5oZWlnaHQgPSBjb250ZW50X2hlaWdodCsncHgnO1x0XHRcclxuXHRcdGhpbnRPYmouc3R5bGUud2lkdGggPSB3aWR0aCs0MCsncHgnO1xyXG5cdFx0aGludE9iai5zdHlsZS5oZWlnaHQgPSBjb250ZW50X2hlaWdodCsncHgnO1xyXG5cdFx0ZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnTW9kYWxXbmRCdG5PaycpO1xyXG5cdFx0aWYgKGNhbGxiYWNrZnVuY3Rpb24gJiYgZWwpIGVsLm9uY2xpY2sgPSBjYWxsYmFja2Z1bmN0aW9uO1xyXG5cdH1cclxufVxyXG5cclxuLy8vLyBTY3JvbGwgRm9yZWNhc3RzIC8vLy8vXHJcblxyXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLyDQv9GA0L7QutGA0YPRgtC60LAg0L/RgNC+0LPQvdC+0LfQsC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xyXG5cclxudmFyIHRtPW51bGw7XHJcbnZhciBzcGQ9MTA7XHJcbnZhciB0bGVmdD0tOTk5O1xyXG5EX0lETEU9MDtcclxuRF9TQ1JPTExMRUZUPTE7XHJcbkRfU0NST0xMUklHSFQ9MjtcclxuRF9BTElHTkxFRlQ9MztcclxuRF9BTElHTlJJR0hUPTQ7XHJcbkRfU0VUUE9TPTU7XHJcbkRfU0NST0xMVE9QPTY7XHJcbkRfU0NST0xMQk9UVE9NPTc7XHJcbkRfQUxJR05UT1A9ODtcclxuRF9BTElHTkJPVFRPTT05O1xyXG52YXIgbW9kZT1EX0lETEU7XHJcbnZhciBmY289bnVsbDtcclxuXHJcbmZ1bmN0aW9uIHNjcm9sbEgoaSl7XHJcbiAgd2l0aChmY28pe1xyXG4gICAgdmFyIHBvcyA9IHNjcm9sbExlZnQraTtcclxuICAgIGlmKHBvczwwKSB7IHBvcz0wOyBtb2RlPURfSURMRTt9IGVsc2UgaWYocG9zPj1zY3JvbGxXaWR0aCl7IHBvcz1zY3JvbGxXaWR0aC0xOyBtb2RlPURfSURMRTt9IGVsc2Ugc2Nyb2xsTGVmdD1wb3M7XHJcbiAgICB9XHJcbiAgfVxyXG5mdW5jdGlvbiBzY3JvbGxWKGkpe1xyXG4gIHdpdGgoZmNvKXtcclxuICAgIHZhciBwb3N2ID0gc2Nyb2xsVG9wK2k7XHJcbiAgICBpZihwb3N2PDApIHsgcG9zdj0wOyBtb2RlPURfSURMRTt9IGVsc2UgaWYocG9zdj49c2Nyb2xsSGVpZ2h0KXsgcG9zdj1zY3JvbGxIZWlnaHQtMTsgbW9kZT1EX0lETEU7fSBlbHNlIHNjcm9sbFRvcD1wb3N2O1xyXG4gICAgfVxyXG4gIH1cclxuZnVuY3Rpb24gc3RvcEF1dG9TY3JvbGwoKXsgaWYobW9kZT09RF9TQ1JPTExMRUZUKSBtb2RlPURfQUxJR05MRUZUOyBlbHNlIGlmKG1vZGU9PURfU0NST0xMUklHSFQpIG1vZGU9RF9BTElHTlJJR0hUO31cclxuZnVuY3Rpb24gZ29MZWZ0KCl7IG1vZGU9RF9TQ1JPTExMRUZUOyB9XHJcbmZ1bmN0aW9uIGdvUmlnaHQoKXsgbW9kZT1EX1NDUk9MTFJJR0hUOyB9XHJcbmZ1bmN0aW9uIGdvVG9wKCl7IG1vZGU9RF9TQ1JPTExUT1A7IH1cclxuZnVuY3Rpb24gZ29Cb3R0b20oKXsgbW9kZT1EX1NDUk9MTEJPVFRPTTsgfVxyXG5mdW5jdGlvbiBnb1RvRlJDKCl7XHJcbiBtb2RlPURfU0VUUE9TOyB9IFxyXG5cclxuZnVuY3Rpb24gdG1EaXNwYXRjaCgpe1xyXG5zd2l0Y2gobW9kZSkge1xyXG4gY2FzZSBEX0lETEU6ICAgICAgICBzcGQ9MTA7IGJyZWFrO1xyXG4gY2FzZSBEX1NDUk9MTExFRlQ6ICBzY3JvbGxIKC1zcGQvMTApOyBzcGQrKzsgaWYoc3BkPjYwKSBzcGQ9NjA7IHVwZGF0ZUZvcmVjYXN0QmcoTWF0aC5yb3VuZChmY28uc2Nyb2xsTGVmdC9mY28uc2Nyb2xsV2lkdGgqNikpOyBicmVhaztcclxuIGNhc2UgRF9TQ1JPTExSSUdIVDogc2Nyb2xsSChzcGQvMTApOyBzcGQrKzsgaWYoc3BkPjYwKSBzcGQ9NjA7IHVwZGF0ZUZvcmVjYXN0QmcoTWF0aC5yb3VuZChmY28uc2Nyb2xsTGVmdC9mY28uc2Nyb2xsV2lkdGgqNikpOyBicmVhaztcclxuIGNhc2UgRF9BTElHTkxFRlQ6ICAgZD1mY28uc2Nyb2xsTGVmdCAlIDUxOyBpZihkPjEpIHNjcm9sbEgoLTEpOyBlbHNlIG1vZGU9RF9JRExFOyBicmVhaztcclxuIGNhc2UgRF9BTElHTlJJR0hUOiAgZD1mY28uc2Nyb2xsTGVmdCAlIDUxOyBpZihkPjEpIHNjcm9sbEgoMSk7IGVsc2UgbW9kZT1EX0lETEU7IGJyZWFrO1xyXG4gY2FzZSBEX1NFVFBPUzogICAgICBwb3M9bnVtRlJDKjUxMCsxOyBkPXBvcy1mY28uc2Nyb2xsTGVmdDsgaWYoTWF0aC5hYnMoZCk+NjAwKSBzcD04MDsgZWxzZSBpZihNYXRoLmFicyhkKT4yMDApIHNwPTQwOyBlbHNlIGlmKE1hdGguYWJzKGQpPjQwKSBzcD0yMDsgZWxzZSBzcD0xOyBpZihkPj0xKSBzY3JvbGxIKHNwKTsgZWxzZSAgaWYoZDw9LTEpIHNjcm9sbEgoLXNwKTsgZWxzZSBtb2RlPURfSURMRTsgYnJlYWs7XHJcbiBjYXNlIERfU0NST0xMVE9QOiAgIHNjcm9sbFYoLXNwZC8xMCk7IHNwZCsrOyBpZihzcGQ+NjApIHNwZD02MDsgYnJlYWs7XHJcbiBjYXNlIERfU0NST0xMQk9UVE9NOiBzY3JvbGxWKHNwZC8xMCk7IHNwZCsrOyBpZihzcGQ+NjApIHNwZD02MDsgYnJlYWs7XHJcbiBjYXNlIERfQUxJR05UT1A6ICAgIGQ9ZmNvLnNjcm9sbFRvcCAlIDE1OyBpZihkPjEpIHNjcm9sbFYoLTEpOyBlbHNlIG1vZGU9RF9JRExFOyBicmVhaztcclxuIGNhc2UgRF9BTElHTkJPVFRPTTogIGQ9ZmNvLnNjcm9sbFRvcCAlIDE1OyBpZihkPjEpIHNjcm9sbFYoMSk7IGVsc2UgbW9kZT1EX0lETEU7IGJyZWFrO1xyXG4gfVxyXG59XHJcblxyXG52YXIgYXJyRnJjRGF5PW5ldyBBcnJheShcIjBcIixcIjFcIixcIjJcIixcIjNcIixcIjRcIixcIjVcIik7XHJcbnZhciBudW1GUkM9MDtcclxuZnVuY3Rpb24gY2hlY2tGcmNUb3BMaW5rKCl7XHJcbiAgIGZvciAodmFyIGk9MDsgaTxhcnJGcmNEYXkubGVuZ3RoOyBpKyspXHJcbiAgICAgaWYgKG51bUZSQz49MCAmJiBudW1GUkM9PWFyckZyY0RheVtpXSkge1xyXG4gICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJmcmNfXCIrYXJyRnJjRGF5W2ldKS5zdHlsZS5jb2xvcj1cIiMzYjU1YzVcIjtcclxuICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZnJjX1wiK2FyckZyY0RheVtpXSkuc3R5bGUuZm9udFdlaWdodD1cImJvbGRcIjtcclxuICAgICB9XHJcbiAgICAgZWxzZSB7XHJcbiAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImZyY19cIithcnJGcmNEYXlbaV0pLnN0eWxlLmNvbG9yPVwiIzAwMDBlZVwiO1xyXG4gICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJmcmNfXCIrYXJyRnJjRGF5W2ldKS5zdHlsZS5mb250V2VpZ2h0PVwibm9ybWFsXCI7XHJcbiAgICAgfVxyXG4gfVxyXG5cclxuXHJcbmZ1bmN0aW9uIGluaXRTY3JvbGxDb250ZW50KG9iaikge1xyXG5cdCAgaWYob2JqKSB7XHJcblx0ICAgb2JqLnN0YXRlID0gMDtcclxuXHRcdCBvYmoubWF4VmVydCA9IG9iai5zY3JvbGxIZWlnaHQgLSBvYmoub2Zmc2V0SGVpZ2h0O1xyXG5cdCAgfVxyXG5cdH1cclxuXHJcbiAgZnVuY3Rpb24gc2Nyb2xsKHZhbCxjb250ZW50SWQpIHtcclxuICAgIHZhciBvYmo9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY29udGVudElkKTtcclxuICAgXHRpZiAob2JqKSB7XHJcbiAgIFx0XHRpbml0U2Nyb2xsQ29udGVudChvYmopO1xyXG4gICBcdFx0b2JqLnNjcm9sbFRvcD1vYmoubWF4VmVydCoodmFsLzEwMCk7XHJcbiAgICB9XHJcblx0fVxyXG5cclxuICBmdW5jdGlvbiBzY3JvbGwyKGVsLGNvbnRlbnRJZCwgdlNsaWRlcixzbGlkZUhhbmRsZSkge1xyXG4gIFx0dmFyIG9iaj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChjb250ZW50SWQpO1xyXG4gIFx0aWYgKG9iaikge1xyXG4gIFx0XHRpbml0U2Nyb2xsQ29udGVudChvYmopO1xyXG4gIFx0XHRpZiAoZWwuZ2V0QXR0cmlidXRlKFwiaWRcIikuaW5kZXhPZihcInNsaWRlQm90dG9tXCIpPi0xKSB7XHJcbiAgXHRcdFx0aWYgKG9iai5tYXhWZXJ0ID4gb2JqLnNjcm9sbFRvcCkgb2JqLnNjcm9sbFRvcD1vYmouc2Nyb2xsVG9wKzE2O1xyXG4gICAgICB9IGVsc2Ugb2JqLnNjcm9sbFRvcD1vYmouc2Nyb2xsVG9wLTE2O1xyXG4gICAgfVxyXG5cclxuICAgIHZhciBvYmoyPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHZTbGlkZXIpO1xyXG4gICAgdmFyIG9iajM9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoc2xpZGVIYW5kbGUpO1xyXG5cclxuICAgIGlmICgob2JqMikmJihvYmozKSlcclxuICAgIFx0b2JqMy5zdHlsZS50b3A9TWF0aC5jZWlsKG9iajIub2Zmc2V0SGVpZ2h0LTIyLSgob2JqMi5vZmZzZXRIZWlnaHQtMjIpKigob2JqLm1heFZlcnQtb2JqLnNjcm9sbFRvcCkvb2JqLm1heFZlcnQpKSkrXCJweFwiO1xyXG5cdH1cclxuXHJcbiAgZnVuY3Rpb24gc2Nyb2xsMyhjb250ZW50SWQsIHZTbGlkZXIsc2xpZGVIYW5kbGUsIGkpIHtcclxuICBcdHZhciBvYmo9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY29udGVudElkKTtcclxuICBcdGlmIChvYmopIHtcclxuICBcdFx0aW5pdFNjcm9sbENvbnRlbnQob2JqKTtcclxuICBcdCAgICBpZiAob2JqLm1heFZlcnQgPiBvYmouc2Nyb2xsVG9wKSBvYmouc2Nyb2xsVG9wPShvYmouc2Nyb2xsVG9wKzE2KSppO1xyXG4gICAgfVxyXG5cclxuICAgIHZhciBvYmoyPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHZTbGlkZXIpO1xyXG4gICAgdmFyIG9iajM9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoc2xpZGVIYW5kbGUpO1xyXG5cclxuICAgIGlmICgob2JqMikmJihvYmozKSlcclxuICAgIFx0b2JqMy5zdHlsZS50b3A9TWF0aC5jZWlsKG9iajIub2Zmc2V0SGVpZ2h0LTIyLSgob2JqMi5vZmZzZXRIZWlnaHQtMjIpKigob2JqLm1heFZlcnQtb2JqLnNjcm9sbFRvcCkvb2JqLm1heFZlcnQpKSkrXCJweFwiO1xyXG5cdH1cclxuXHJcblxyXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vIE1ha2UgU3RhcnQgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXHJcblxyXG5mdW5jdGlvbiBNYWtlU3RhcnRGRih1cmwpe1xyXG5hbGVydCgn0KfRgtC+0LHRiyDRgdC00LXQu9Cw0YLRjCDQnNC10YLQtdC+0L3QvtCy0YMg0JLQsNGI0LXQuSDRgdGC0LDRgNGC0L7QstC+0Lkg0YHRgtGA0LDQvdC40YbQtdC5LCDQv9C10YDQtdGC0LDRidC40YLQtSDRgdGB0YvQu9C60YMgXCLQodC00LXQu9Cw0YLRjCDRgdGC0LDRgNGC0L7QstC+0LlcIiDQvdCwINC40LrQvtC90LrRgyDRgSDQuNC30L7QsdGA0LDQttC10L3QuNC10Lwg0LTQvtC80LjQutCwINCyINC/0LDQvdC10LvQuCDQuNC90YHRgtGA0YPQvNC10L3RgtC+0LIg0LHRgNCw0YPQt9C10YDQsCcpO1xyXG59XHJcblxyXG5cclxuXHJcblxuZnVuY3Rpb24gbW5vdmFTdWdnZXN0KHN1Z2dlc3RPLCBpbnB1dE8pIHtcblx0dGhpcy5zdWdnZXN0ID0gc3VnZ2VzdE87XG5cdHRoaXMuaW5wdXQgPSBpbnB1dE87XG5cdHRoaXMuc2VhcmNoVGltZW91dCA9IDMwMDtcblx0dGhpcy50aW1lb3V0U2VhcmNoSG5kID0gbnVsbDtcdFxuXHR0aGlzLnRpbWVvdXRCbHVySG5kID0gbnVsbDtcdFxuXHR0aGlzLmNvdW50UmVxdWVzdCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqICgxMDAwMCAtIDEwMDAgKyAxKSkgKyAxMDAwO1xuXHR0aGlzLnVybCA9ICcvc2lucGwnO1xuXHR0aGlzLml0ZW1zID0gbnVsbDtcblx0dGhpcy5taW53aWR0aCA9IDA7XG5cdHRoaXMuaW5pdCgpO1xufVxuXG5tbm92YVN1Z2dlc3QucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbigpIHtcdFxuXHR0aGlzLnN1Z2dlc3QubyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuc3VnZ2VzdC5vKTtcblx0dGhpcy5pbnB1dC5wYXJlbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLmlucHV0LnBhcmVudCk7XG5cdHZhciBjb29yZHMgPSB0aGlzLmdldE9mZnNldCh0aGlzLmlucHV0LnBhcmVudCk7XG5cdHRoaXMuc3VnZ2VzdC5vLnN0eWxlLmxlZnQgPSBjb29yZHMubGVmdCsncHgnO1x0XG5cdHRoaXMuc3VnZ2VzdC5vLnN0eWxlLnRvcCA9IGNvb3Jkcy50b3ArdGhpcy5pbnB1dC5wYXJlbnQub2Zmc2V0SGVpZ2h0KydweCc7XG5cdHJlbW92ZUNsYXNzKHRoaXMuc3VnZ2VzdC5vLCAnb25mb2N1cycpO1xuXHR0aGlzLmlucHV0Lm8udmFsdWUgPSAnJztcblx0dGhpcy5pbnB1dC5sb2FkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLmlucHV0LmxvYWRlcik7XG5cdHZhciBwYXJlbnQgPSB0aGlzO1x0XG5cdHRoaXMuaW5wdXQuby5vbmJsdXIgPSBmdW5jdGlvbihldmVudCkge3BhcmVudC5ibHVyKHBhcmVudCl9O1xuXHR0aGlzLmlucHV0Lm8ub25jbGljayA9IGZ1bmN0aW9uKGV2ZW50KSB7cGFyZW50LmNsaWNrKHBhcmVudCl9O1xuXHR0aGlzLmlucHV0Lm8ub25rZXlkb3duID0gZnVuY3Rpb24oZXZlbnQpIHtwYXJlbnQua2V5ZG93bihldmVudCwgcGFyZW50KX07XHRcblx0dGhpcy5pbnB1dC5sb2FkZXIub25jbGljayA9IGZ1bmN0aW9uKCkge3BhcmVudC5sb2FkZXJDbGljayhwYXJlbnQpfTtcdFxufVxuXG5tbm92YVN1Z2dlc3QucHJvdG90eXBlLmNsaWNrID0gZnVuY3Rpb24ob2JqKSB7XG5cdGlmICh0aGlzLmlucHV0Lm8udmFsdWUgPT0gb2JqLmlucHV0LmRlZlZhbCkgdGhpcy5pbnB1dC5vLnZhbHVlID0gJyc7XG59XG5cbm1ub3ZhU3VnZ2VzdC5wcm90b3R5cGUuYmx1ciA9IGZ1bmN0aW9uKG9iaikge1xuXHR0aGlzLnRpbWVvdXRCbHVySG5kID0gc2V0VGltZW91dChmdW5jdGlvbigpIHtcblx0XHRpZiAob2JqLmlucHV0Lm8udmFsdWUubGVuZ3RoID09IDApIG9iai5pbnB1dC5vLnZhbHVlID0gb2JqLmlucHV0LmRlZlZhbDtcblx0XHRvYmouc3VnZ2VzdC5vLnN0eWxlLndpZHRoID0gMDtcblx0XHRyZW1vdmVDbGFzcyhvYmouc3VnZ2VzdC5vLCAnb25mb2N1cycpO1xuXHRcdHJlbW92ZUNsYXNzKG9iai5pbnB1dC5sb2FkZXIsICdzcGlubmVyJyk7XG5cdH0sIDIwMCk7XG59XG5cbm1ub3ZhU3VnZ2VzdC5wcm90b3R5cGUucmVkcmF3U3VnZ2VzdCA9IGZ1bmN0aW9uKCkge1xuXHRhZGRDbGFzcyh0aGlzLnN1Z2dlc3QubywgJ29uZm9jdXMnKTtcblx0dGhpcy5zdWdnZXN0Lm8uc3R5bGUud2lkdGggPSAnYXV0byc7XHRcblx0dGhpcy5taW53aWR0aCA9IHRoaXMuaW5wdXQucGFyZW50Lm9mZnNldFdpZHRoKydweCc7XG5cdGlmICh0aGlzLnN1Z2dlc3Quby5vZmZzZXRXaWR0aCA8IHBhcnNlSW50KHRoaXMubWlud2lkdGgucmVwbGFjZSgncHgnLCcnKSwgMTApKVxuXHRcdHRoaXMuc3VnZ2VzdC5vLnN0eWxlLndpZHRoID0gdGhpcy5taW53aWR0aDtcblx0ZWxzZSBcblx0XHR0aGlzLnN1Z2dlc3Quby5zdHlsZS53aWR0aCA9IHRoaXMuc3VnZ2VzdC5vLm9mZnNldFdpZHRoO1xuXHR0aGlzLnN1Z2dlc3Quby5zdHlsZS53aWR0aCA9IHBhcnNlSW50KHRoaXMuc3VnZ2VzdC5vLnN0eWxlLndpZHRoLnJlcGxhY2UoJ3B4JywgJycpLCAxMCkrJ3B4Jztcblx0dGhpcy5tb3VzZU92ZXIoMSk7IFxufVxuXG5tbm92YVN1Z2dlc3QucHJvdG90eXBlLmxvYWRlckNsaWNrID0gZnVuY3Rpb24ob2JqKXtcblx0Y2xlYXJUaW1lb3V0KG9iai50aW1lb3V0Qmx1ckhuZCk7XG5cdGlmIChvYmouaW5wdXQuby52YWx1ZS5sZW5ndGggPT0gMCB8fCBvYmouaW5wdXQuby52YWx1ZSA9PSBvYmouaW5wdXQuZGVmVmFsKSByZXR1cm47XG5cdGlmICghaGFzQ2xhc3Mob2JqLmlucHV0LmxvYWRlciwgJ3gnKSAmJiAhaGFzQ2xhc3Mob2JqLmlucHV0LmxvYWRlciwgJ3NwaW5uZXInKSlcblx0XHRvYmouZ2V0QWpheExpc3QoKTtcblx0ZWxzZSBpZiAoaGFzQ2xhc3Mob2JqLmlucHV0LmxvYWRlciwgJ3gnKSkge1xuXHRcdHJlbW92ZUNsYXNzKG9iai5pbnB1dC5sb2FkZXIsICdzcGlubmVyJyk7XHRcblx0XHRyZW1vdmVDbGFzcyhvYmouaW5wdXQubG9hZGVyLCAneCcpO1xuXHRcdG9iai5pbnB1dC5vLnZhbHVlID0gJyc7XG5cdFx0cmVtb3ZlQ2xhc3Mob2JqLnN1Z2dlc3QubywgJ29uZm9jdXMnKTtcblx0XHRvYmouaW5wdXQuby5mb2N1cygpO1xuXHR9XG59XG5cbm1ub3ZhU3VnZ2VzdC5wcm90b3R5cGUua2V5ZG93biA9IGZ1bmN0aW9uKGUsIG9iaikge1xuXHRlID0gZSB8fCBldmVudDtcblx0dmFyIGNvZGUgPSAoZS5jaGFyQ29kZSkgPyBlLmNoYXJDb2RlIDogZS5rZXlDb2RlO1xuXHRzd2l0Y2goY29kZSkge1xuICAgIGNhc2UgMTM6XG4gICAgXHRvYmoubW91c2VDbGljaygpO1x0XHRcbiAgICBicmVhazsgXHRcdFx0ICAgICAgXG4gICAgY2FzZSAzODpcbiAgICBcdG9iai5tb3VzZU92ZXIoLTEpO1x0XHRcbiAgICBicmVhazsgXG4gICAgY2FzZSA0MDpcbiAgICBcdG9iai5tb3VzZU92ZXIoMSk7XHRcdFxuICAgIGJyZWFrOyBcbiAgICBjYXNlIDE2OiBjYXNlIDE3OiBjYXNlIDIwOiBjYXNlIDk6IGNhc2UgMzc6IGNhc2UgMzk6IFxuICAgIGJyZWFrO1xuXHRcdGRlZmF1bHQ6XHRcblx0XHRcdGNsZWFyVGltZW91dChvYmoudGltZW91dFNlYXJjaEhuZCk7XHRcblx0XHRcdG9iai5nZXRBamF4TGlzdCgpO1x0XG4gICAgYnJlYWs7IFx0ICAgIFx0XHQgICAgICBcdCAgXHRcdFx0XHRcblx0fSBcdFxufVxuXG5tbm92YVN1Z2dlc3QucHJvdG90eXBlLmdldEFqYXhMaXN0ID0gZnVuY3Rpb24oKSB7XG5cdHJlbW92ZUNsYXNzKHRoaXMuc3VnZ2VzdC5vLCAnb25mb2N1cycpO1xuXHRyZW1vdmVDbGFzcyh0aGlzLmlucHV0LmxvYWRlciwgJ3gnKTtcdFx0XHRcblx0YWRkQ2xhc3ModGhpcy5pbnB1dC5sb2FkZXIsICdzcGlubmVyJyk7XHRcblx0dmFyIHBhcmVudCA9IHRoaXM7XHRcdFxuXHR0aGlzLnRpbWVvdXRTZWFyY2hIbmQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1x0XHRcblx0XHRpZiAocGFyZW50LmlucHV0Lm8udmFsdWUubGVuZ3RoPT0wKSB7IFxuXHRcdFx0cmVtb3ZlQ2xhc3MocGFyZW50LmlucHV0LmxvYWRlciwgJ3NwaW5uZXInKTtcdFx0XHRcdFx0XG5cdFx0XHRyZXR1cm47XHRcblx0XHR9XG5cdFx0cGFyZW50LmNvdW50UmVxdWVzdCsrO1x0XG5cdFx0dmFyIGxvYWREYXRhID0gbmV3IExvYWREYXRhU2VhcmNoKHBhcmVudCk7XG5cdFx0bG9hZERhdGEuZ2V0RGF0YShwYXJlbnQudXJsK1wiP2xhbmc9cnUmaWQ9XCIrcGFyZW50LmNvdW50UmVxdWVzdCtcIiZmY2hhcj1cIitlbmNvZGVVUklDb21wb25lbnQoKHBhcmVudC5pbnB1dC5vLnZhbHVlKSkpO1x0XHRcblx0fSwgdGhpcy5zZWFyY2hUaW1lb3V0KTtcdFxufVxuXG5tbm92YVN1Z2dlc3QucHJvdG90eXBlLm1vdXNlQ2xpY2sgPSBmdW5jdGlvbigpIHtcblx0Zm9yKHZhciBpPTA7IGk8dGhpcy5pdGVtcy5sZW5ndGg7IGkrKykge1xuXHRcdHZhciBvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5pdGVtc1tpXS5pZCk7XG5cdFx0aWYgKGhhc0NsYXNzKG8sICdvbmhvdmVyJykpIHtcblx0XHRcdGlmKHRoaXMuaXRlbXNbaV0udHlwZSA9PSAndCcpXG5cdFx0XHRcdGRvY3VtZW50LmxvY2F0aW9uID0gJy9mcmMvJyt0aGlzLml0ZW1zW2ldLmlkKycuaHRtJztcblx0XHRcdGlmKHRoaXMuaXRlbXNbaV0udHlwZSA9PSAnYScpIFxuXHRcdFx0XHRkb2N1bWVudC5sb2NhdGlvbiA9ICcvYXZpYS8nKygocGFyc2VJbnQodGhpcy5pdGVtc1tpXS5pZCwgMTApKzEwMDAwKSooLTEpKSsnLmh0bSc7XHRcdFx0XG5cdFx0XHRpZih0aGlzLml0ZW1zW2ldLnR5cGUgPT0gJ2MnKVxuXHRcdFx0XHRkb2N1bWVudC5sb2NhdGlvbiA9ICcvbGlzdC9jb3VudHJpZXMvJyt0aGlzLmVzY2FwZSh0aGlzLml0ZW1zW2ldLm5hbWUpO1xuXHRcdFx0aWYodGhpcy5pdGVtc1tpXS50eXBlID09ICdkJylcblx0XHRcdFx0ZG9jdW1lbnQubG9jYXRpb24gPSAnL2xpc3QvcmVnaW9ucy8nK3RoaXMuZXNjYXBlKHRoaXMuaXRlbXNbaV0uaWQpO1xuXHRcdFx0aWYodGhpcy5pdGVtc1tpXS50eXBlID09ICdtdScpXG5cdFx0XHRcdGRvY3VtZW50LmxvY2F0aW9uID0gJy9saXN0L211bmljaXBhbHMvJyt0aGlzLmVzY2FwZSh0aGlzLml0ZW1zW2ldLmlkKTtcdFx0XHRcblx0XHRcdHJldHVybjtcblx0XHR9XHRcdFx0XG5cdH1cblx0dmFyIG8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImVycl9hXCIpO1xuXHRpZiAobykgZG9jdW1lbnQubG9jYXRpb24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImVycl9hXCIpLmdldEF0dHJpYnV0ZSgnaHJlZicpO1xufVxuXG5tbm92YVN1Z2dlc3QucHJvdG90eXBlLm1vdXNlT3ZlciA9IGZ1bmN0aW9uKHN0ZXAsIG8pIHtcblx0aWYgKCF0aGlzLml0ZW1zKSByZXR1cm47XG5cdGlmICh0aGlzLml0ZW1zLmxlbmd0aCA9PSAwKSB7XG5cdFx0Ly9vID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Rpc2NyaXB0Jyk7XG5cdFx0Ly9pZiAobykgYWRkQ2xhc3MobywgJ29uaG92ZXInKTtcblx0XHRyZXR1cm47XG5cdH1cblx0dmFyIGUgPSBudWxsO1xuXHRpZiAoIW8pIHtcblx0XHRmb3IodmFyIGk9MDsgaTx0aGlzLml0ZW1zLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5pdGVtc1tpXS5pZCk7XG5cdFx0XHRpZiAoaGFzQ2xhc3MobywgJ29uaG92ZXInKSkge1xuXHRcdFx0XHRlID0gdGhpcy5pdGVtc1tpK3N0ZXBdIT11bmRlZmluZWQ/dGhpcy5pdGVtc1tpK3N0ZXBdOlxuXHRcdFx0XHRcdFx0XHRcdHN0ZXA9PTE/dGhpcy5pdGVtc1swXTp0aGlzLml0ZW1zW3RoaXMuaXRlbXMubGVuZ3RoLTFdO1xuXHRcdFx0XHR0aGlzLmlucHV0Lm8udmFsdWUgPSBlLm5hbWU7IFx0XHRcdFx0XHRcdFx0XHRcblx0XHRcdFx0YnJlYWs7XHRcdFx0XHRcdFx0XG5cdFx0XHR9XHRcdFx0XHRcdFx0XHRcblx0XHR9XG5cdFx0aWYgKCFlKSBcblx0XHRcdGUgPSBzdGVwPT0xP3RoaXMuaXRlbXNbMF06dGhpcy5pdGVtc1t0aGlzLml0ZW1zLmxlbmd0aC0xXTtcblx0XHRvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZS5pZCk7XHRcdFx0XG5cdH1cblx0dGhpcy5tb3VzZU91dCgpO1x0XG5cdGlmIChvKSBhZGRDbGFzcyhvLCAnb25ob3ZlcicpO1x0XG5cdGlmICghZSkgXG5cdFx0Zm9yKHZhciBpPTA7IGk8dGhpcy5pdGVtcy5sZW5ndGg7IGkrKykge1xuXHRcdFx0byA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuaXRlbXNbaV0uaWQpO1xuXHRcdFx0aWYgKGhhc0NsYXNzKG8sICdvbmhvdmVyJykpIHtcblx0XHRcdFx0ZSA9IHRoaXMuaXRlbXNbaV07IFx0XG5cdFx0XHR9XHRcblx0XHR9XHRcdFxuXHRpZiAoIWUpIHRoaXMuaXRlbXNbMF07XG5cdFx0XHRcdFxufVxuXG5tbm92YVN1Z2dlc3QucHJvdG90eXBlLm1vdXNlT3V0ID0gZnVuY3Rpb24oKSB7XG5cdHZhciBvID0gbnVsbDtcblx0Zm9yKHZhciBpPTA7IGk8dGhpcy5pdGVtcy5sZW5ndGg7IGkrKykge1x0XG5cdFx0byA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuaXRlbXNbaV0uaWQpOyBcblx0XHRpZiAobykgcmVtb3ZlQ2xhc3MobywgJ29uaG92ZXInKTsgXG5cdH1cbn1cblxubW5vdmFTdWdnZXN0LnByb3RvdHlwZS5nZXRTdWdnZXN0ID0gZnVuY3Rpb24oKSB7XG5cdHZhciBodG1sID0gJycsXG5cdFx0c3RyID0gJycsXG5cdFx0aXNDb3VudHJ5ID0gZmFsc2UsXG5cdFx0aXNDaXR5ID0gZmFsc2UsXG5cdFx0aXNBdmlhID0gZmFsc2UsXG5cdFx0aXNEaXN0cmljdCA9IGZhbHNlLFxuXHRcdGlzTXUgPSBmYWxzZSxcblx0XHRodG1sID0gdGhpcy5zdWdnZXN0Lm51bGx0cGw7XG5cdGFkZENsYXNzKHRoaXMuc3VnZ2VzdC5vLCAnZScpO1xuXHRmb3IodmFyIGk9MDsgaTx0aGlzLml0ZW1zLmxlbmd0aDsgaSsrKSB7XG5cdFx0aWYgKGk9PTApIGh0bWwgPSAnJztcblx0XHRpZiAodGhpcy5pdGVtc1tpXS50eXBlPT0nYycgJiYgaXNDb3VudHJ5ID09IGZhbHNlKSB7IFxuXHRcdFx0aHRtbCArPXRoaXMuc3VnZ2VzdC50cGxjO1xuXHRcdFx0aXNDb3VudHJ5ID0gdHJ1ZTtcblx0XHR9XHRcdFx0XHRcblx0XHRpZiAodGhpcy5pdGVtc1tpXS50eXBlPT0ndCcgJiYgaXNDaXR5ID09IGZhbHNlKSB7XG5cdFx0XHRodG1sICs9dGhpcy5zdWdnZXN0LnRwbHQ7XG5cdFx0XHRpc0NpdHkgPSB0cnVlO1xuXHRcdH1cblx0XHRpZiAodGhpcy5pdGVtc1tpXS50eXBlPT0nYScgJiYgaXNBdmlhID09IGZhbHNlKSB7XG5cdFx0XHRodG1sICs9dGhpcy5zdWdnZXN0LnRwbGE7XG5cdFx0XHRpc0F2aWEgPSB0cnVlO1xuXHRcdH1cdFx0XHRcdFxuXHRcdGlmICh0aGlzLml0ZW1zW2ldLnR5cGU9PSdkJyAmJiBpc0Rpc3RyaWN0ID09IGZhbHNlKSB7XG5cdFx0XHRodG1sICs9dGhpcy5zdWdnZXN0LnRwbGQ7XG5cdFx0XHRpc0Rpc3RyaWN0ID0gdHJ1ZTtcblx0XHR9XG5cdFx0aWYgKHRoaXMuaXRlbXNbaV0udHlwZT09J211JyAmJiBpc011ID09IGZhbHNlKSB7XG5cdFx0XHRodG1sICs9dGhpcy5zdWdnZXN0LnRwbG11O1xuXHRcdFx0aXNNdSA9IHRydWU7XG5cdFx0fVx0XHRcblx0XG5cdFx0aHRtbCArPSB0aGlzLnN1Z2dlc3QudHBsO1xuXHRcdFxuXHQgIGRve1xuXHQgIFx0aWYgKCEoc3RyID0gaHRtbC5tYXRjaCgvJShbXFx3XFxkLl0rKSUvZ2ltKSkpXG5cdCAgICBcdGJyZWFrO1xuXHQgICAgZm9yICh2YXIgaiBpbiBzdHIpe1xuXHQgICAgXHRpZiAocGFyc2VJbnQoaiwgMTApICE9IGopIGNvbnRpbnVlO1xuXHQgICAgXHR0cnkge1xuXHQgICAgIFx0XHR2YXIgdHA9c3RyW2pdLnJlcGxhY2UoLyUvZ2ksJycpO1xuXHQgICAgIFx0XHRpZiAodGhpcy5pdGVtc1tpXVt0cF0pIHtcblx0ICAgICBcdFx0IFx0aHRtbCA9IGh0bWwucmVwbGFjZShzdHJbal0sICh0cD09J2RfbmFtZScgfHwgdHA9PSdtdW5fbmFtZScpP3RoaXMuaXRlbXNbaV1bdHBdLnJlcGxhY2UoLyAvZ2ksJyZuYnNwOycpKycsJm5ic3A7Jzp0aGlzLml0ZW1zW2ldW3RwXS5yZXBsYWNlKC8gL2dpLCcmbmJzcDsnKSk7ICAgICBcdFx0XHQgICAgIFx0XHR9XG5cdCAgICAgXHRcdGVsc2UgXG5cdCAgICAgIFx0XHRcdGh0bWwgPSBodG1sLnJlcGxhY2Uoc3RyW2pdLCAnJyk7XG5cdCAgICAgIH1cblx0ICAgICAgY2F0Y2goZXJyKSB7fSAgICAgXG5cdCAgICB9XG5cdCAgfXdoaWxlKDEpO1x0XHRcblx0fVxuXHRpZiAodGhpcy5pdGVtcy5sZW5ndGg+MCkge1xuXHRcdGh0bWwgKz0gJzxkaXYgY2xhc3M9XCJkaXNjcmlwdFwiPjxzcGFuIGNsYXNzPVwiYWxsX3NlYXJjaFwiPjxhIGhyZWY9XCIvc2VhcmNoLycrdGhpcy5lc2NhcGUodGhpcy5pbnB1dC5vLnZhbHVlKSsnXCI+Jyt0aGlzLnN1Z2dlc3QudHBsX2FsbHNlYXJjaCsnPC9hPjwvc3Bhbj48L2Rpdj4nO1xuXHRcdGh0bWwgKz0gJzxkaXYgY2xhc3M9XCJkaXNjcmlwdFwiPjxzcGFuIGNsYXNzPVwiYWxsX3NlYXJjaFwiPjxhIGhyZWY9XCIvbWdmaW5kLmh0bVwiPtCd0LXRgiDQvdGD0LbQvdC+0LPQviDQv9GD0L3QutGC0LA/INCY0YHQv9C+0LvRjNC30YPQudGC0LUg0JzQtdCz0LDQv9C+0LjRgdC6PC9hPjwvc3Bhbj48L2Rpdj4nO1x0XG5cdFx0cmVtb3ZlQ2xhc3ModGhpcy5zdWdnZXN0Lm8sICdlJyk7XG5cdH1cblx0cmV0dXJuIGh0bWw7XG59XG5cbmZ1bmN0aW9uIExvYWREYXRhU2VhcmNoKHBhcmVudCkge1xuXHR0aGlzLnBhcmVudCA9IHBhcmVudDsgXG4gIHRoaXMuWE1MT2JqID0gbnVsbDtcbiAgdGhpcy5nZXREYXRhID0gZnVuY3Rpb24odXJsKSB7XG5cdCAgdHJ5IHtcblx0ICBcdHRoaXMuWE1MT2JqID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG5cdCAgfSBjYXRjaChlcnIpIHtcblx0ICBcdHRoaXMuWE1MT2JqID0gbmV3IEFjdGl2ZVhPYmplY3QoXCJNaWNyb3NvZnQuWE1MSHR0cFwiKTtcblx0ICB9XG4gICAgaWYgKHRoaXMuWE1MT2JqKSB7XG4gICAgICB0aGlzLlhNTE9iai5vbnJlYWR5c3RhdGVjaGFuZ2UgPSB0aGlzLkxvYWREYXRhQ2FsbGJhY2tGdW5jdGlvbiAodGhpcy5YTUxPYmosIHRoaXMucGFyZW50KTsgICAgXG4gICAgICB0aGlzLlhNTE9iai5vcGVuKFwiR0VUXCIsIHVybCsnJnI9JytNYXRoLnJhbmRvbSgpLCB0cnVlKTtcbiAgICBcdHRoaXMuWE1MT2JqLnNlbmQobnVsbCk7XG4gICAgfVxuICB9XG5cbiAgdGhpcy5Mb2FkRGF0YUNhbGxiYWNrRnVuY3Rpb24gPSBmdW5jdGlvbihYTUxPYmosIHBhcmVudCkge1xuICBcdHJldHVybiBmdW5jdGlvbigpIHtcbiAgXHRcdHBhcmVudC5pdGVtcyA9IHt9O1xuICAgIFx0aWYgKFhNTE9iai5yZWFkeVN0YXRlID09IDQpIHtcbiAgICBcdFx0aWYgKFhNTE9iai5zdGF0dXMgPT0gMjAwKSB7XG4gICAgXHRcdFx0dHJ5IHsgXG5cdCAgICBcdFx0XHR2YXIgZGF0YSA9IEpTT04ucGFyc2UoWE1MT2JqLnJlc3BvbnNlVGV4dCk7XG5cdCAgICBcdFx0XHRwYXJlbnQuaXRlbXMgPSBkYXRhLml0ZW1zO1xuXHRcdFx0XHRcdHBhcmVudC5zdWdnZXN0Lm8uaW5uZXJIVE1MID0gcGFyZW50LmdldFN1Z2dlc3QoKS5yZXBsYWNlKCclaW5wdXQudmFsJScsIHBhcmVudC5lc2NhcGUocGFyZW50LmlucHV0Lm8udmFsdWUpKS5yZXBsYWNlKCclaW5wdXQudmFsJScsIHBhcmVudC5pbnB1dC5vLnZhbHVlKTtcblx0XHRcdFx0XHRwYXJlbnQucmVkcmF3U3VnZ2VzdCgpO1x0XHRcdFx0XG5cdFx0XHRcdFx0YWRkQ2xhc3MocGFyZW50LmlucHV0LmxvYWRlciwgJ3gnKTtcblx0XHRcdFx0fVxuXHRcdFx0XHRjYXRjaChlcnIpIHt9XG5cdCAgICAgIFx0XHRYTUxPYmo9IG51bGw7XG5cdCAgICAgIFx0fVxuXHRcdH1cbiAgIFx0fVxuICB9XG59XG5cbm1ub3ZhU3VnZ2VzdC5wcm90b3R5cGUuZ2V0T2Zmc2V0ID0gZnVuY3Rpb24oZWxlbSkge1xuXHRmdW5jdGlvbiBnZXRPZmZzZXRTdW0oZWxlbSkge1xuXHQgXHR2YXIgdG9wPTAsIGxlZnQ9MFxuXHQgXHR3aGlsZShlbGVtKSB7XG5cdCBcdFx0dG9wID0gdG9wICsgcGFyc2VJbnQoZWxlbS5vZmZzZXRUb3ApXG5cdCBcdFx0bGVmdCA9IGxlZnQgKyBwYXJzZUludChlbGVtLm9mZnNldExlZnQpXG5cdCBcdFx0ZWxlbSA9IGVsZW0ub2Zmc2V0UGFyZW50XG5cdFx0fVxuXHQgXHRyZXR1cm4ge3RvcDogdG9wLCBsZWZ0OiBsZWZ0fVxuXHR9XG5cdFxuXHRmdW5jdGlvbiBnZXRPZmZzZXRSZWN0KGVsZW0pIHtcbiBcdCB2YXIgYm94ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuIFx0IHZhciBib2R5ID0gZG9jdW1lbnQuYm9keVxuIFx0IHZhciBkb2NFbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50XG4gXHQgdmFyIHNjcm9sbFRvcCA9IHdpbmRvdy5wYWdlWU9mZnNldCB8fCBkb2NFbGVtLnNjcm9sbFRvcCB8fCBib2R5LnNjcm9sbFRvcFxuIFx0IHZhciBzY3JvbGxMZWZ0ID0gd2luZG93LnBhZ2VYT2Zmc2V0IHx8IGRvY0VsZW0uc2Nyb2xsTGVmdCB8fCBib2R5LnNjcm9sbExlZnRcbiBcdCB2YXIgY2xpZW50VG9wID0gZG9jRWxlbS5jbGllbnRUb3AgfHwgYm9keS5jbGllbnRUb3AgfHwgMFxuIFx0IHZhciBjbGllbnRMZWZ0ID0gZG9jRWxlbS5jbGllbnRMZWZ0IHx8IGJvZHkuY2xpZW50TGVmdCB8fCAwXG4gXHQgdmFyIHRvcCA9IGJveC50b3AgKyBzY3JvbGxUb3AgLSBjbGllbnRUb3BcbiBcdCB2YXIgbGVmdCA9IGJveC5sZWZ0ICsgc2Nyb2xsTGVmdCAtIGNsaWVudExlZnRcbiBcdCByZXR1cm4geyB0b3A6IE1hdGgucm91bmQodG9wKSwgbGVmdDogTWF0aC5yb3VuZChsZWZ0KSB9XG5cdH1cdFxuXHRcblx0aWYgKGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KVxuXHRcdHJldHVybiBnZXRPZmZzZXRSZWN0KGVsZW0pXG5cdGVsc2Vcblx0IFx0cmV0dXJuIGdldE9mZnNldFN1bShlbGVtKVxufVxuXG5mdW5jdGlvbiBnZXROYXZpZ2F0b3JOYW1lKCkge1xuXHR2YXIgdXNlcmFnZW50PW5hdmlnYXRvci51c2VyQWdlbnQ7XG5cdHZhciBuYXZpZ2F0b3JuYW1lO1xuXHRpZiAodXNlcmFnZW50LmluZGV4T2YoJ01TSUUnKSE9IC0xKSB7XG5cdCAgICBuYXZpZ2F0b3JuYW1lPVwiTVNJRVwiO1xuXHR9XG5cdGVsc2UgaWYgKHVzZXJhZ2VudC5pbmRleE9mKCdHZWNrbycpIT0gLTEpIHtcblx0ICAgIGlmICh1c2VyYWdlbnQuaW5kZXhPZignQ2hyb21lJykhPSAtMSlcblx0ICAgIG5hdmlnYXRvcm5hbWU9XCJDaHJvbWVcIjtcblx0ICAgIGVsc2UgbmF2aWdhdG9ybmFtZT1cIk1vemlsbGFcIjtcblx0fVxuXHRlbHNlIGlmICh1c2VyYWdlbnQuaW5kZXhPZignTW96aWxsYScpIT0gLTEpIHtcblx0ICAgIG5hdmlnYXRvcm5hbWU9XCJvbGQgTmV0c2NhcGUgb3IgTW96aWxsYVwiO1xuXHR9XG5cdGVsc2UgaWYgKHVzZXJhZ2VudC5pbmRleE9mKCdPcGVyYScpIT0gLTEpIHtcblx0ICAgIG5hdmlnYXRvcm5hbWU9XCJPcGVyYVwiO1xuXHR9XG5cdHJldHVybiBuYXZpZ2F0b3JuYW1lLnRvTG93ZXJDYXNlKCk7XG59XG5cbmZ1bmN0aW9uIGFkZENsYXNzKG8sIGMpe1xuXHRpZiAoIW8pIHJldHVybjtcblx0dmFyIHJlID0gbmV3IFJlZ0V4cChcIihefFxcXFxzKVwiICsgYyArIFwiKFxcXFxzfCQpXCIsIFwiZ1wiKTtcblx0aWYgKHJlLnRlc3Qoby5jbGFzc05hbWUpKSByZXR1cm5cblx0by5jbGFzc05hbWUgPSAoby5jbGFzc05hbWUgKyBcIiBcIiArIGMpLnJlcGxhY2UoL1xccysvZywgXCIgXCIpLnJlcGxhY2UoLyheIHwgJCkvZywgXCJcIik7XG59XG4gIFxuZnVuY3Rpb24gcmVtb3ZlQ2xhc3MobywgYyl7XG5cdGlmICghbykgcmV0dXJuO1x0XG5cdHZhciByZSA9IG5ldyBSZWdFeHAoXCIoXnxcXFxccylcIiArIGMgKyBcIihcXFxcc3wkKVwiLCBcImdcIik7XG5cdG8uY2xhc3NOYW1lID0gby5jbGFzc05hbWUucmVwbGFjZShyZSwgXCIkMVwiKS5yZXBsYWNlKC9cXHMrL2csIFwiIFwiKS5yZXBsYWNlKC8oXiB8ICQpL2csIFwiXCIpO1xufVxuXG5mdW5jdGlvbiBoYXNDbGFzcyhvLCBjKSB7XG5cdGlmICghbykgcmV0dXJuICcnO1x0XG5cdHJldHVybiBvLmNsYXNzTmFtZS5tYXRjaChuZXcgUmVnRXhwKCcoXFxcXHN8XiknK2MrJyhcXFxcc3wkKScpKTtcbn1cblxubW5vdmFTdWdnZXN0LnByb3RvdHlwZS5lc2NhcGUgPSBmdW5jdGlvbihzdHIpIHtcblx0dmFyIHRyYW5zID0gW107XG5cdGZvciAodmFyIGkgPSAweDQxMDsgaSA8PSAweDQ0RjsgaSsrKSB0cmFuc1tpXSA9IGkgLSAweDM1MDsgLy8gQS0/YS15XG5cdHRyYW5zWzB4NDAxXSA9IDB4QTg7ICAgIC8vID9cblx0dHJhbnNbMHg0NTFdID0gMHhCODsgICAgLy8gP1xuXHR0cmFuc1sweDQ1N10gPSAweEJGOyAgICAvLyA/XG5cdHRyYW5zWzB4NDA3XSA9IDB4QUY7ICAgIC8vID9cblx0dHJhbnNbMHg0NTZdID0gMHhCMzsgICAgLy8gP1xuXHR0cmFuc1sweDQwNl0gPSAweEIyOyAgICAvLyA/XG5cdHRyYW5zWzB4NDA0XSA9IDB4QkE7ICAgIC8vID9cblx0dHJhbnNbMHg0NTRdID0gMHhBQTsgICAgLy8gP1xuXHRcbiAgdmFyIHJlcz0nJztcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpKyspIHtcbiAgICB2YXIgbiA9IHN0ci5jaGFyQ29kZUF0KGkpO1xuICAgIGlmICh0eXBlb2YgdHJhbnNbbl0gIT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIG4gPSB0cmFuc1tuXTtcbiAgICAgIHJlcz1yZXMrZXNjYXBlKFN0cmluZy5mcm9tQ2hhckNvZGUobikpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIG4gPSBzdHIuY2hhckF0KGkpO1xuICAgICAgcmVzPXJlcytuO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcmVzO1xufVxudmFyIFNjcm9sbCA9IGZ1bmN0aW9uKHBhcikge1xuXHR0aGlzLnNjcm9sbE9iaiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHBhci5zY3JvbGxPYmpJZCk7XG5cdHRoaXMuZGVsdGEgPSBwYXIuZGVsdGE7XG5cdHRoaXMubWluX2RlbHRhID0gcGFyLmRlbHRhO1xuXHR0aGlzLnN0ZXAgPSBwYXIuc3RlcDtcblx0dGhpcy5yZXF1ZXN0SWQgPSAwO1xuXHR0aGlzLmluaXQgPSBmdW5jdGlvbihwYXIpIHtcblx0XHR2YXIgX3RoaXMgPSB0aGlzO1xuXHRcdGlmICggIXdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgKSB7XG5cdFx0ICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gKCBmdW5jdGlvbigpIHtcblx0XHQgICAgcmV0dXJuIHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHxcblx0XHQgICAgd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZSB8fFxuXHRcdCAgICB3aW5kb3cub1JlcXVlc3RBbmltYXRpb25GcmFtZSB8fFxuXHRcdCAgICB3aW5kb3cubXNSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHxcblx0XHQgICAgZnVuY3Rpb24oIC8qIGZ1bmN0aW9uIEZyYW1lUmVxdWVzdENhbGxiYWNrICovIGNhbGxiYWNrLCAvKiBET01FbGVtZW50IEVsZW1lbnQgKi8gZWxlbWVudCApIHtcblx0XHQgICAgICB2YXIgcmVxdWVzdElkID0gd2luZG93LnNldFRpbWVvdXQoY2FsbGJhY2ssIDEwMDAvNjApO1xuXHRcdCAgICAgIHJldHVybiByZXF1ZXN0SWQ7XG5cdFx0ICAgIH07XG5cdFx0ICB9KSgpO1xuICAgIFx0aWYgKCF3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUpXG4gICAgICAgIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IGZ1bmN0aW9uKGlkKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQoaWQpO1xuICAgICAgICB9O1x0XHQgIFxuXHRcdH1cblx0XHR0aGlzLmlzVG91Y2ggPSB0aGlzLmRldGVjdFRvdWNoKCk7XG5cdFx0aWYgKHRoaXMuaXNUb3VjaCkgdGhpcy5zdGVwID0gdGhpcy5zdGVwLnRvdWNoO1xuXHRcdGVsc2UgdGhpcy5zdGVwID0gdGhpcy5zdGVwLm5vcm1hbDsgXG5cdFx0dGhpcy5jYWxsYmFja3MgPSB7bGVmdDogcGFyLmRvTGVmdCwgcmlnaHQ6IHBhci5kb1JpZ2h0LCB0b3A6IHBhci5kb1RvcCwgYm90dG9tOiBwYXIuZG9Cb3R0b219O1x0XG5cdFx0dGhpcy5iaW5kRXZlbnRzKHBhci5sZWZ0QnRucywgcGFyLmRvTGVmdCwgMCk7XG5cdFx0dGhpcy5iaW5kRXZlbnRzKHBhci5yaWdodEJ0bnMsIHBhci5kb1JpZ2h0LCAxKTtcblx0XHR0aGlzLmJpbmRFdmVudHMocGFyLnRvcEJ0bnMsIHBhci5kb1RvcCwgMCk7XG5cdFx0dGhpcy5iaW5kRXZlbnRzKHBhci5ib3R0b21CdG5zLCBwYXIuZG9Cb3R0b20sIDEpO1xuXHRcdHRoaXMuYmluZEV2ZW50U2Nyb2xsT2JqKHtsZWZ0OiBwYXIuZG9MZWZ0LCByaWdodDogcGFyLmRvUmlnaHQsIHRvcDogcGFyLmRvVG9wLCBib3R0b206IHBhci5kb0JvdHRvbX0pO1xuXHR9XHRcdFxuXHR0aGlzLmJpbmRFdmVudHMgPSBmdW5jdGlvbihidG5zLCBjYWxsYmFjaywgX2ZvcndhcmQpIHtcblx0XHR2YXIgX3RoaXMgPSB0aGlzO1xuXHRcdGJ0bnMgPSB0aGlzLmdldEJudHMoYnRucyk7XG5cdFx0Zm9yICh2YXIgaT0wOyBpIDwgYnRucy5sZW5ndGg7IGkrKykge1xuXHRcdFx0aWYgKHRoaXMuaXNUb3VjaCkge1xuXHRcdFx0XHRidG5zW2ldLm9uY2xpY2sgPSBmdW5jdGlvbihldnQpIHtcblx0XHRcdFx0XHQvL2V2dC5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0XHRcdGNhbmNlbEFuaW1hdGlvbkZyYW1lKF90aGlzLnJlcXVlc3RJZCk7XG5cdFx0XHRcdFx0X3RoaXMuZGVsdGEgPSBwYXIuZG9MZWZ0IHx8IHBhci5kb1JpZ2g/KF90aGlzLnNjcm9sbE9iai5vZmZzZXRXaWR0aC0xKTpfdGhpcy5zY3JvbGxPYmoub2Zmc2V0SGVpZ2h0O1xuXHRcdFx0XHRcdHZhciBkZWx0YSA9IDA7XG5cdFx0XHRcdFx0X3RoaXMuYW5pbWF0ZShkZWx0YSwgX3RoaXMuc3RlcCwgY2FsbGJhY2spO1x0XHRcdFx0XG5cdFx0XHRcdH07XHRcdFx0XHRcdFx0XHRcblx0XHRcdH1cdFxuXHRcdFx0ZWxzZSB7XG5cdFx0XHRcdGJ0bnNbaV0ub25tb3VzZW92ZXIgPSBmdW5jdGlvbigpIHtcblx0XHRcdFx0XHRjYW5jZWxBbmltYXRpb25GcmFtZShfdGhpcy5yZXF1ZXN0SWQpO1xuXHRcdFx0XHRcdHZhciBwb3MgPSBwYXIuZG9MZWZ0IHx8IHBhci5kb1JpZ2g/X3RoaXMuc2Nyb2xsT2JqLnNjcm9sbExlZnQ6X3RoaXMuc2Nyb2xsT2JqLnNjcm9sbFRvcDtcblx0XHRcdFx0XHR2YXIgbCA9IHBhci5kb0xlZnQgfHwgcGFyLmRvUmlnaD9fdGhpcy5zY3JvbGxPYmouc2Nyb2xsV2lkdGg6X3RoaXMuc2Nyb2xsT2JqLnNjcm9sbEhlaWdodDtcblx0XHRcdFx0XHRfdGhpcy5kZWx0YSA9IF9mb3J3YXJkID09IDA/cG9zOihsIC0gcG9zKTtcblx0XHRcdFx0XHRfdGhpcy5hbmltYXRlKDAsIF90aGlzLnN0ZXAsIGNhbGxiYWNrKTtcblx0XHRcdFx0fTtcblx0XHRcdFx0YnRuc1tpXS5vbm1vdXNlb3V0ID0gZnVuY3Rpb24oKSB7XG5cdFx0XHRcdFx0Y2FuY2VsQW5pbWF0aW9uRnJhbWUoX3RoaXMucmVxdWVzdElkKTtcblx0XHRcdFx0XHRfdGhpcy5kZWx0YSA9IF90aGlzLm1pbl9kZWx0YTtcblx0XHRcdFx0XHR2YXIgcG9zID0gcGFyLmRvTGVmdCB8fCBwYXIuZG9SaWdoP190aGlzLnNjcm9sbE9iai5zY3JvbGxMZWZ0Ol90aGlzLnNjcm9sbE9iai5zY3JvbGxUb3A7XG5cdFx0XHRcdFx0dmFyIGRlbHRhID0gKF9mb3J3YXJkID09IDE/cG9zICUgX3RoaXMuZGVsdGE6KF90aGlzLmRlbHRhIC0gcG9zICUgX3RoaXMuZGVsdGEpKTtcblx0XHRcdFx0XHRfdGhpcy5hbmltYXRlKGRlbHRhLCBfdGhpcy5zdGVwLCBjYWxsYmFjayk7XG5cdFx0XHRcdH1cblx0XHRcdH1cdFx0XG5cdFx0fVx0XHRcblx0fVxuXHR0aGlzLmJpbmRFdmVudFNjcm9sbE9iaiA9IGZ1bmN0aW9uKGFjdGlvbnMpIHtcblx0XHR2YXIgX3RoaXMgPSB0aGlzO1xuXHRcdHZhciB0b3VjaFBvcyA9IHtcblx0XHRcdHRvdWNoc3RhcnQ6IHt4OiAwLCB5OiAwLCBfc2Nyb2xsOiB7X2xlZnQ6IDB9fSxcblx0XHRcdHRvdWNobW92ZToge3g6IDAsIHk6IDB9XG5cdFx0fTtcblx0XHRpZiAodGhpcy5pc1RvdWNoKSB7XG5cdFx0XHR0aGlzLnNjcm9sbE9iai5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hzdGFydFwiLCAgZnVuY3Rpb24oZXZ0KSB7XG5cdFx0XHRcdC8vZXZ0LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRcdGNhbmNlbEFuaW1hdGlvbkZyYW1lKF90aGlzLnJlcXVlc3RJZCk7XHRcdFx0XHRcblx0XHRcdFx0dmFyIHRvdWNoID0gZXZ0LnRvdWNoZXNbMF07XG5cdFx0XHRcdHRvdWNoUG9zLnRvdWNoc3RhcnQgPSB7eDogdG91Y2gucGFnZVgsIHk6IHRvdWNoLnBhZ2VZLCBfc2Nyb2xsOntfbGVmdDogX3RoaXMuc2Nyb2xsT2JqLnNjcm9sbExlZnR9fTtcblx0XHRcdFx0dG91Y2hQb3MudG91Y2htb3ZlID0ge3g6IDAsIHk6IDB9O1xuXHRcdFx0fSwgZmFsc2UpO1xuXHRcdFx0XG5cdFx0XHR0aGlzLnNjcm9sbE9iai5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBmdW5jdGlvbihldnQpIHtcblx0XHRcdFx0ZXZ0LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRcdGNhbmNlbEFuaW1hdGlvbkZyYW1lKF90aGlzLnJlcXVlc3RJZCk7XHRcdFx0XG5cdFx0XHRcdHZhciB0b3VjaCA9IGV2dC50b3VjaGVzWzBdO1xuXHRcdFx0XHRpZiAodG91Y2hQb3MudG91Y2htb3ZlLnggIT0gMCkge1xuXHRcdFx0XHRcdHZhciBjYWxsYmFjayA9IHRvdWNoLnBhZ2VYIDwgdG91Y2hQb3MudG91Y2htb3ZlLng/YWN0aW9ucy5yaWdodDphY3Rpb25zLmxlZnQ7XG5cdFx0XHRcdFx0dmFyIGRlbHRhID0gTWF0aC5hYnModG91Y2gucGFnZVgtdG91Y2hQb3MudG91Y2htb3ZlLngpO1xuXHRcdFx0XHRcdHRvdWNoUG9zLnRvdWNobW92ZSA9IHt4OiB0b3VjaC5wYWdlWCwgeTogdG91Y2gucGFnZVl9O1xuXHRcdFx0XHRcdF90aGlzLmRlbHRhID0gX3RoaXMubWluX2RlbHRhO1xuXHRcdFx0XHRcdGNhbGxiYWNrKF90aGlzLnNjcm9sbE9iaiwgZGVsdGEpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGVsc2UgdG91Y2hQb3MudG91Y2htb3ZlID0ge3g6IHRvdWNoLnBhZ2VYLCB5OiB0b3VjaC5wYWdlWX07XHRcdFx0XHRcblx0XHRcdH0sIGZhbHNlKTtcblx0XHRcdFxuXHRcdFx0dGhpcy5zY3JvbGxPYmouYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBmdW5jdGlvbihldnQpIHtcblx0XHRcdFx0ZXZ0LnByZXZlbnREZWZhdWx0KCk7XHRcblx0XHRcdFx0Y2FuY2VsQW5pbWF0aW9uRnJhbWUoX3RoaXMucmVxdWVzdElkKTtcblx0XHRcdFx0dmFyIF9mb3J3YXJkID0gdG91Y2hQb3MudG91Y2htb3ZlLnggPCB0b3VjaFBvcy50b3VjaHN0YXJ0Lng/MTowOyBcdFx0XHRcdFx0XHRcdFxuXHRcdFx0XHR2YXIgY2FsbGJhY2sgPSB0b3VjaFBvcy50b3VjaG1vdmUueCA8IHRvdWNoUG9zLnRvdWNoc3RhcnQueD9hY3Rpb25zLnJpZ2h0OmFjdGlvbnMubGVmdDtcblx0XHRcdFx0dmFyIGRlbHRhID0gTWF0aC5hYnModG91Y2hQb3MudG91Y2hzdGFydC5fc2Nyb2xsLl9sZWZ0IC0gX3RoaXMuc2Nyb2xsT2JqLnNjcm9sbExlZnQpO1xuXHRcdFx0XHR2YXIgbW9kID0gZGVsdGE8X3RoaXMuZGVsdGE/ZGVsdGE6ZGVsdGElX3RoaXMuZGVsdGE7ICAgXG5cdFx0XHRcdF90aGlzLmFuaW1hdGUobW9kLCBfdGhpcy5zdGVwKjIsIGNhbGxiYWNrKTtcblx0XHRcdH0sIGZhbHNlKTtcblx0XHR9XG5cdFx0ZWxzZSB7XG4gIFx0XHRfdGhpcy5hZGRIYW5kbGVyKF90aGlzLnNjcm9sbE9iaiwgJ0RPTU1vdXNlU2Nyb2xsJywgX3RoaXMud2hlZWwpO1xuICBcdFx0X3RoaXMuYWRkSGFuZGxlcihfdGhpcy5zY3JvbGxPYmosICdtb3VzZXdoZWVsJywgX3RoaXMud2hlZWwpO1x0XHRcdFx0XHRcblx0XHR9XG5cdH1cblx0dGhpcy53aGVlbCA9IGZ1bmN0aW9uKGV2dCwgY29udGV4dCkge1xuXHRcdGV2dCA9IGV2dCB8fCB3aW5kb3cuZXZlbnQ7XG4gICAgaWYgKGV2dC5wcmV2ZW50RGVmYXVsdCkgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG4gICAgZXZ0LnJldHVyblZhbHVlID0gZmFsc2U7XG4gICAgdmFyIGRlbHRhO1xuICAgIGlmIChldnQud2hlZWxEZWx0YSkgeyAvLyDQkiBPcGVyYSDQuCBJRVxuICAgICAgZGVsdGEgPSBldnQud2hlZWxEZWx0YSAvIDEyMDtcbiAgICAgIC8vaWYgKHdpbmRvdy5vcGVyYSkgZGVsdGEgPSAtZGVsdGE7IC8vINCU0L7Qv9C+0LvQvdC40YLQtdC70YzQvdC+INC00LvRjyBPcGVyYVxuICAgIH1cbiAgICBlbHNlIGlmIChldnQuZGV0YWlsKSB7IC8vINCU0LvRjyBHZWNrb1xuICAgICAgZGVsdGEgPSAtZXZ0LmRldGFpbCAvIDM7XG4gICAgfVxuICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKGNvbnRleHQucmVxdWVzdElkKTtcbiAgICBpZiAoY29udGV4dC5jYWxsYmFja3MubGVmdCB8fCBjb250ZXh0LmNhbGxiYWNrcy5yaWdodCkgdmFyIGNhbGxiYWNrID0gKGRlbHRhPj0wP2NvbnRleHQuY2FsbGJhY2tzLmxlZnQ6Y29udGV4dC5jYWxsYmFja3MucmlnaHQpO1xuICAgIGlmIChjb250ZXh0LmNhbGxiYWNrcy5ib3R0b20gfHwgY29udGV4dC5jYWxsYmFja3MudG9wKSB2YXIgY2FsbGJhY2sgPSAoZGVsdGE+PTA/Y29udGV4dC5jYWxsYmFja3MudG9wOmNvbnRleHQuY2FsbGJhY2tzLmJvdHRvbSk7XG5cdFx0Y2FsbGJhY2soY29udGV4dC5zY3JvbGxPYmosIGNvbnRleHQubWluX2RlbHRhKTtcblx0fVxuXHR0aGlzLmp1bXAgPSBmdW5jdGlvbihjdXJTZWdtZW50LCBuZXdTZWdtZW50KSB7XG5cdFx0aWYgKGN1clNlZ21lbnQgPT0gbmV3U2VnbWVudCkgcmV0dXJuO1xuXHRcdGNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMucmVxdWVzdElkKTtcblx0XHR2YXIgY2FsbGJhY2sgPSBwYXIuZG9SaWdodDtcblx0XHR0aGlzLmRlbHRhID0gTWF0aC5hYnMobmV3U2VnbWVudCp0aGlzLnNjcm9sbE9iai5vZmZzZXRXaWR0aCAtIHRoaXMuc2Nyb2xsT2JqLnNjcm9sbExlZnQpO1xuXHRcdGlmIChuZXdTZWdtZW50IDwgY3VyU2VnbWVudCkgY2FsbGJhY2sgPSBwYXIuZG9MZWZ0O1xuXHRcdHZhciBzdGVwID0gMjUqTWF0aC5hYnMobmV3U2VnbWVudCAtIGN1clNlZ21lbnQpO1xuXHRcdHRoaXMuYW5pbWF0ZSgwLCBzdGVwLCBjYWxsYmFjayk7XG5cdH1cblx0dGhpcy5nZXRCbnRzID0gZnVuY3Rpb24oYnRucykge1xuXHRcdHZhciBhID0gW107XG5cdFx0aWYgKGJ0bnMpXG5cdFx0XHRmb3IgKHZhciBpID0gMDsgaTxidG5zLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRcdGFbaV0gPSBcdGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGJ0bnNbaV0pO1xuXHRcdFx0fVxuXHRcdHJldHVybiBhO1xuXHR9XG5cdHRoaXMuYW5pbWF0ZSA9IGZ1bmN0aW9uKGRlbHRhLCBkZWZTdGVwLCBjYWxsYmFjaykge1xuXHRcdHZhciBfdGhpcyA9IHRoaXM7XG5cdFx0aWYgKGRlbHRhPHRoaXMuZGVsdGEpIHtcblx0XHRcdHZhciBzdGVwID0gZGVmU3RlcDtcbiBcdFx0XHRpZiAoZGVsdGEgKyBkZWZTdGVwPj10aGlzLmRlbHRhKSBzdGVwID0gdGhpcy5kZWx0YSAtXHRkZWx0YTtcbiBcdFx0XHRjYWxsYmFjayh0aGlzLnNjcm9sbE9iaiwgc3RlcCk7XG4gXHRcdFx0ZGVsdGEgKz0gZGVmU3RlcDtcbiBcdFx0XHR0aGlzLnJlcXVlc3RJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpe190aGlzLmFuaW1hdGUoZGVsdGEsIGRlZlN0ZXAsIGNhbGxiYWNrKX0pO1xuXHRcdH1cblx0fVxuXHR0aGlzLmRldGVjdFRvdWNoID0gZnVuY3Rpb24oKSB7XG5cdFx0dmFyIGlzVG91Y2ggPSBmYWxzZTtcblx0XHRpZiAoXCJvbnRvdWNoc3RhcnRcIiBpbiB3aW5kb3cgfHwgbmF2aWdhdG9yLm1zTWF4VG91Y2hQb2ludHMpIGlzVG91Y2ggPSB0cnVlO1xuXHRcdHJldHVybiBpc1RvdWNoO1xuXHR9XG5cdHRoaXMuYWRkSGFuZGxlciA9IGZ1bmN0aW9uKG9iamVjdCwgZXZlbnQsIGhhbmRsZXIpIHtcblx0XHR2YXIgX3RoaXMgPSB0aGlzO1xuICAgIGlmIChvYmplY3QuYWRkRXZlbnRMaXN0ZW5lcikge1xuICAgICAgb2JqZWN0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIGZ1bmN0aW9uKGV2ZW50KXtoYW5kbGVyKGV2ZW50LCBfdGhpcyl9LCBmYWxzZSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKG9iamVjdC5hdHRhY2hFdmVudCkge1xuICAgICAgb2JqZWN0LmF0dGFjaEV2ZW50KCdvbicgKyBldmVudCwgaGFuZGxlcik7XG4gICAgfVxuXHR9XG5cdHRoaXMuYWRkSGFuZGxlciA9IGZ1bmN0aW9uKG9iamVjdCwgZXZlbnQsIGhhbmRsZXIpIHtcblx0XHR2YXIgX3RoaXMgPSB0aGlzO1xuICAgIGlmIChvYmplY3QuYWRkRXZlbnRMaXN0ZW5lcikge1xuICAgICAgb2JqZWN0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIGZ1bmN0aW9uKGV2ZW50KXtoYW5kbGVyKGV2ZW50LCBfdGhpcyl9LCBmYWxzZSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKG9iamVjdC5hdHRhY2hFdmVudCkge1xuICAgICAgb2JqZWN0LmF0dGFjaEV2ZW50KCdvbicgKyBldmVudCwgaGFuZGxlcik7XG4gICAgfSBcblx0fVx0XG5cdHRoaXMuaW5pdChwYXIpO1xufSJdLCJmaWxlIjoibWV0ZW9ub3ZhLm1vbnRoLm1pbi5qcyJ9
