////Graphics///

function setPreloaderPict(parentId,preloaderId,preloaderStyle){
  var div = document.createElement("div");
  div.setAttribute('id', preloaderId);
  var s = div.style;
  s.position = "absolute";
  s.zIndex=12;
  document.getElementById(parentId).appendChild(div);
  if (preloaderStyle=="mini")
  	div.innerHTML="<img src=\"/images/ajax-miniloader.gif\" width=\"16\" height=\"16\" />";
  else div.innerHTML="<img src=\"/images/ajax-loader.gif\" width=\"93\" height=\"26\" />";
  return div;
}

function getPos(el,sProp) {
	var iPos = 0;
	while (el!=null) {
		iPos+=el["offset" + sProp]
		el = el.offsetParent;
	}
	return iPos
}

function getOffset(elem) {
 if (elem.getBoundingClientRect) {
 return getOffsetRect(elem)
 } else {
 return getOffsetSum(elem)
 }
}

function getOffsetSum(elem) {
 var top=0, left=0
 while(elem) {
 top = top + parseInt(elem.offsetTop)
 left = left + parseInt(elem.offsetLeft)
 elem = elem.offsetParent
 }
 
 return {top: top, left: left}
}
 

function getOffsetRect(elem) {
 var box = elem.getBoundingClientRect()
 var body = document.body
 var docElem = document.documentElement
 
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 
 var top = box.top + scrollTop - clientTop
 var left = box.left + scrollLeft - clientLeft
 
 return { top: Math.round(top), left: Math.round(left) }
}

function setPreloaderStyle(parentDiv,preloaderDiv){
	var div=document.getElementById(preloaderDiv);
	var pdiv=document.getElementById(parentDiv);
	div.style.left=Math.round(pdiv.offsetWidth/2)-Math.round(div.offsetWidth/2)+"px";

	if ((parentDiv=="townsContainer") && (pdiv.className=="townsContainerMain"))
		div.style.top=Math.round(pdiv.offsetHeight/2)-Math.round(div.offsetHeight/2)+"px";
	else
		div.style.top=Math.round(pdiv.offsetHeight/2)+15-Math.round(div.offsetHeight/2)+"px";
}

function initPreloader(parentId, preloaderId,preloaderStyle) {
	var pobj=document.getElementById(parentId);

	var obj=document.getElementById(preloaderId);
	if (!obj) {

		obj=setPreloaderPict(parentId,preloaderId,preloaderStyle);
		setPreloaderStyle(parentId,preloaderId);

	}

	obj.style.visibility="visible";
}

function GraphObj(townindex,geosuffix) {

	var graph = this;
	graph._townindex=townindex;
	graph._arrGraphName=new Array("P","T","R","W");
	graph._n=graph._arrGraphName.length;
	graph._arrGraphPic=new Array();
	graph._lastShowGraphic=0;
	graph._graphicTimer=null;

	graph.preloadGraph=function() {
		var k=0;
		for (var i=numFRC*graph._n; i<(numFRC+1)*graph._n; i++){
			if (graph._arrGraphPic[i]==null) {
				graph._arrGraphPic[i]=new Image();
				graph._arrGraphPic[i].src="http://www.meteonova.ru/images/graphics/"+graph._arrGraphName[k]+"G"+graph._townindex+"_1"+numFRC+".png"+geosuffix;
				graph._arrGraphPic[i].onLoad=graph.initGraphic(i);
		  }
		  k++;
		}
	}

	graph.preloadGraphic=function(k) {
		var i=numFRC*graph._n+k;
		if (graph._arrGraphPic[i]==null) {
			graph._arrGraphPic[i]=new Image();
			graph._arrGraphPic[i].src="http://www.meteonova.ru/images/graphics/"+graph._arrGraphName[k]+"G"+graph._townindex+"_1"+numFRC+".png"+geosuffix;
			graph._arrGraphPic[i].onLoad=graph.initGraphic(i);
		  }
	}

	graph.initGraphic=function(i) {
		if (!document.getElementById("graph"+i)) {
	  		var img= document.createElement("img");
				img.setAttribute("id", "graph"+i);
	  		img.src=graph._arrGraphPic[i].src;
				var s = img.style;
				s.top=0;
	  		s.left=0;
	  		s.visibility = "hidden";
	  		s.position = "absolute";
	  		s.zIndex=12;
			document.getElementById('graphic').appendChild(img);
	  }
	}

	graph.showGraphic=function(el,graph_num) {
		clearTimeout(graph._graphicTimer);
 		var obj=document.getElementById("graphic");
   		if (obj) {
//    		obj.style.left = getPos(document.getElementById("td2"),"Left");
//     		obj.style.top =  getPos(el,"Top")+el.offsetHeight+"px";
		obj.style.left = getOffset(document.getElementById("frc_cont")).left+"px";
		obj.style.top =  getOffset(el).top+el.offsetHeight+"px";
     		obj.style.visibility = "visible";
    	}

    var div=document.getElementById("graph"+graph._lastShowGraphic);
    if (div) div.style.visibility="hidden";

    div=document.getElementById("graph"+graph_num);
   	if (div) {
   		div.style.visibility="visible";
   		graph._lastShowGraphic=graph_num;
   	}
  }

  graph.hideGraphic=function(){
	clearTimeout(graph._graphicTimer);
    var div=document.getElementById("graph"+graph._lastShowGraphic);
    if (div) div.style.visibility="hidden";
    div=document.getElementById("graphic");
    if (div) div.style.visibility = "hidden";
  }

  graph.timerHideGraphic=function() {
  	graph._graphicTimer=setTimeout(function(){graph.hideGraphic();},1000);
  }

}

//// Hints /////

var hintTimeouts = new Array();

function showHint(parentObj, id, bVisible, width) {
	id = id.toString();
	var obj = document.getElementById("hint_content_"+id);
	if (!obj) initHint(id, width);

	var hintObj = document.getElementById(id);
	if (hintObj) {
    hintObj.style.left=getPos(parentObj,"Left")+2+"px";
    hintObj.style.top =  getPos(parentObj,"Top")+parentObj.offsetHeight+2+"px";
    setTimeoutHint(hintObj, bVisible);
  }
}

function setTimeoutHint(hintObj, bVisible) {
	var id = hintObj.getAttribute("id").toString();
	var hintTimeout = hintTimeouts[id];
	clearTimeout(hintTimeout);
  hintTimeouts[id] = setTimeout(function() {
  		if (bVisible) hintObj.style.visibility="visible";
  		else hintObj.style.visibility="hidden";
    },
    500
  );
}

function initModalWnd(id, width, bVisible, callbackfunction) {
	var obj = document.getElementById("hint_content_"+id);
	if (!obj) initHint(id, width, callbackfunction);
	var ovStyle = document.getElementById("overlay").style;
	modalWndStyle = document.getElementById(id).style;
	if (bVisible) {
		ovStyle.display = "block";
		modalWndStyle.visibility = "visible";
		updateModalWnd();
		if (bIE) window.attachEvent('onscroll', updateModalWnd);
	}
	else {
		ovStyle.display = "none";
		modalWndStyle.visibility = "hidden";
		window.detachEvent('onscroll', updateModalWnd);
	}
}

function updateModalWnd() {
	var dtop = -100;
	var ddtop = 0;
	var clientWidth = window.innerWidth || (document.documentElement && document.documentElement.clientWidth) || document.body.clientWidth;	
	var clientHeight = window.innerHeight || (document.documentElement && document.documentElement.clientHeight) || document.body.clientHeight;
	var ovStyle = document.getElementById("overlay").style;
	var modalWndStyle = document.getElementById('modalWnd').style;
	if (bIE)
		ddtop = window.pageYOffset || (document.documentElement && document.documentElement.scrollTop) || document.body.scrollTop; 
  modalWndStyle.left = clientWidth/2-parseInt(modalWndStyle.width, 10)/2;
  modalWndStyle.top = Math.round(clientHeight/2-parseInt(modalWndStyle.height, 10)/2)+ddtop+dtop;
	ovStyle.top = ddtop;
}

function initHint(id, width, callbackfunction) {
	var imgUrl = "/images/hints";
	var hintObj = document.getElementById(id);
	if (hintObj) {
		var content = hintObj.innerHTML;
		var hintBlock = "<div>";
		hintBlock+="<div class='hint_top_left'><img src='"+imgUrl+"/hint_top_left.png' width='15' height='18' class='corner' onLoad='transparent(this)'></div>";
		hintBlock+="<div class='hint_top_center' style='width: "+width+"px;'></div>";
		hintBlock+="<div class='hint_top_right'><img src='"+imgUrl+"/hint_top_right.png' width='23' height='18' class='corner' onLoad='transparent(this)'></div>";
		hintBlock+="</div>";
    hintBlock+="<div>";
		hintBlock+="<div class='hint_body_left' id='hint_body_left"+id+"'><img src='"+imgUrl+"/hint_body_left.png' id='img_hint_body_left"+id+"' width=15 onLoad='transparent(this)'></div>";
		var el = document.getElementById('modalWnd');	
		if (callbackfunction && el) hintBlock+="<div class='hint_body_center' id='hint_content_"+id+"' style='width: "+width+"px; background-color: #f8f9fd'>"+content+"<div class='btn-close'><a href='javascript:document.getElementById(\"ModalWndBtnCansel\").onclick()'></a></div></div>";
		else hintBlock+="<div class='hint_body_center' id='hint_content_"+id+"' style='width: "+width+"px; background-color: #f8f9fd'>"+content+"</div>"; 
		hintBlock+="<div class='hint_body_right'  id='hint_body_right"+id+"'><img src='"+imgUrl+"/hint_body_right.png' id='img_hint_body_right"+id+"' width=23 onLoad='transparent(this)'></div>";
		hintBlock+="</div>";
    hintBlock+= "<div style=\"margin-top: -2px;\">";
		hintBlock+="<div class='hint_bottom_left'><img src='"+imgUrl+"/hint_bottom_left.png' width='15' height='18' class='corner' onLoad='transparent(this)'></div>";
		hintBlock+="<div class='hint_bottom_center' style='width: "+width+"px;'></div>";
		hintBlock+="<div class='hint_bottom_right'><img src='"+imgUrl+"/hint_bottom_right.png' width='23' height='18' class='corner' onLoad='transparent(this)'></div>";
		hintBlock+="</div>";
		hintObj.innerHTML = hintBlock;
		var content_height = document.getElementById("hint_content_"+id).offsetHeight;
		document.getElementById("img_hint_body_left"+id).style.height = content_height+'px';
		document.getElementById("img_hint_body_right"+id).style.height = content_height+'px';
		document.getElementById("hint_body_left"+id).style.height = content_height+'px';
		document.getElementById("hint_body_right"+id).style.height = content_height+'px';		
		hintObj.style.width = width+40+'px';
		hintObj.style.height = content_height+'px';
		el = document.getElementById('ModalWndBtnOk');
		if (callbackfunction && el) el.onclick = callbackfunction;
	}
}

//// Scroll Forecasts /////

/////////////////////// прокрутка прогноза///////////////////////////////////////

var tm=null;
var spd=10;
var tleft=-999;
D_IDLE=0;
D_SCROLLLEFT=1;
D_SCROLLRIGHT=2;
D_ALIGNLEFT=3;
D_ALIGNRIGHT=4;
D_SETPOS=5;
D_SCROLLTOP=6;
D_SCROLLBOTTOM=7;
D_ALIGNTOP=8;
D_ALIGNBOTTOM=9;
var mode=D_IDLE;
var fco=null;

function scrollH(i){
  with(fco){
    var pos = scrollLeft+i;
    if(pos<0) { pos=0; mode=D_IDLE;} else if(pos>=scrollWidth){ pos=scrollWidth-1; mode=D_IDLE;} else scrollLeft=pos;
    }
  }
function scrollV(i){
  with(fco){
    var posv = scrollTop+i;
    if(posv<0) { posv=0; mode=D_IDLE;} else if(posv>=scrollHeight){ posv=scrollHeight-1; mode=D_IDLE;} else scrollTop=posv;
    }
  }
function stopAutoScroll(){ if(mode==D_SCROLLLEFT) mode=D_ALIGNLEFT; else if(mode==D_SCROLLRIGHT) mode=D_ALIGNRIGHT;}
function goLeft(){ mode=D_SCROLLLEFT; }
function goRight(){ mode=D_SCROLLRIGHT; }
function goTop(){ mode=D_SCROLLTOP; }
function goBottom(){ mode=D_SCROLLBOTTOM; }
function goToFRC(){
 mode=D_SETPOS; } 

function tmDispatch(){
switch(mode) {
 case D_IDLE:        spd=10; break;
 case D_SCROLLLEFT:  scrollH(-spd/10); spd++; if(spd>60) spd=60; updateForecastBg(Math.round(fco.scrollLeft/fco.scrollWidth*6)); break;
 case D_SCROLLRIGHT: scrollH(spd/10); spd++; if(spd>60) spd=60; updateForecastBg(Math.round(fco.scrollLeft/fco.scrollWidth*6)); break;
 case D_ALIGNLEFT:   d=fco.scrollLeft % 51; if(d>1) scrollH(-1); else mode=D_IDLE; break;
 case D_ALIGNRIGHT:  d=fco.scrollLeft % 51; if(d>1) scrollH(1); else mode=D_IDLE; break;
 case D_SETPOS:      pos=numFRC*510+1; d=pos-fco.scrollLeft; if(Math.abs(d)>600) sp=80; else if(Math.abs(d)>200) sp=40; else if(Math.abs(d)>40) sp=20; else sp=1; if(d>=1) scrollH(sp); else  if(d<=-1) scrollH(-sp); else mode=D_IDLE; break;
 case D_SCROLLTOP:   scrollV(-spd/10); spd++; if(spd>60) spd=60; break;
 case D_SCROLLBOTTOM: scrollV(spd/10); spd++; if(spd>60) spd=60; break;
 case D_ALIGNTOP:    d=fco.scrollTop % 15; if(d>1) scrollV(-1); else mode=D_IDLE; break;
 case D_ALIGNBOTTOM:  d=fco.scrollTop % 15; if(d>1) scrollV(1); else mode=D_IDLE; break;
 }
}

var arrFrcDay=new Array("0","1","2","3","4","5");
var numFRC=0;
function checkFrcTopLink(){
   for (var i=0; i<arrFrcDay.length; i++)
     if (numFRC>=0 && numFRC==arrFrcDay[i]) {
       document.getElementById("frc_"+arrFrcDay[i]).style.color="#3b55c5";
       document.getElementById("frc_"+arrFrcDay[i]).style.fontWeight="bold";
     }
     else {
       document.getElementById("frc_"+arrFrcDay[i]).style.color="#0000ee";
       document.getElementById("frc_"+arrFrcDay[i]).style.fontWeight="normal";
     }
 }


function initScrollContent(obj) {
	  if(obj) {
	   obj.state = 0;
		 obj.maxVert = obj.scrollHeight - obj.offsetHeight;
	  }
	}

  function scroll(val,contentId) {
    var obj=document.getElementById(contentId);
   	if (obj) {
   		initScrollContent(obj);
   		obj.scrollTop=obj.maxVert*(val/100);
    }
	}

  function scroll2(el,contentId, vSlider,slideHandle) {
  	var obj=document.getElementById(contentId);
  	if (obj) {
  		initScrollContent(obj);
  		if (el.getAttribute("id").indexOf("slideBottom")>-1) {
  			if (obj.maxVert > obj.scrollTop) obj.scrollTop=obj.scrollTop+16;
      } else obj.scrollTop=obj.scrollTop-16;
    }

    var obj2=document.getElementById(vSlider);
    var obj3=document.getElementById(slideHandle);

    if ((obj2)&&(obj3))
    	obj3.style.top=Math.ceil(obj2.offsetHeight-22-((obj2.offsetHeight-22)*((obj.maxVert-obj.scrollTop)/obj.maxVert)))+"px";
	}

  function scroll3(contentId, vSlider,slideHandle, i) {
  	var obj=document.getElementById(contentId);
  	if (obj) {
  		initScrollContent(obj);
  	    if (obj.maxVert > obj.scrollTop) obj.scrollTop=(obj.scrollTop+16)*i;
    }

    var obj2=document.getElementById(vSlider);
    var obj3=document.getElementById(slideHandle);

    if ((obj2)&&(obj3))
    	obj3.style.top=Math.ceil(obj2.offsetHeight-22-((obj2.offsetHeight-22)*((obj.maxVert-obj.scrollTop)/obj.maxVert)))+"px";
	}


///////////////////////// Make Start /////////////////////////////////////////////////////////

function MakeStartFF(url){
alert('Чтобы сделать Метеонову Вашей стартовой страницей, перетащите ссылку "Сделать стартовой" на иконку с изображением домика в панели инструментов браузера');
}




function mnovaSuggest(suggestO, inputO) {
	this.suggest = suggestO;
	this.input = inputO;
	this.searchTimeout = 300;
	this.timeoutSearchHnd = null;	
	this.timeoutBlurHnd = null;	
	this.countRequest = Math.floor(Math.random() * (10000 - 1000 + 1)) + 1000;
	this.url = '/sinpl';
	this.items = null;
	this.minwidth = 0;
	this.init();
}

mnovaSuggest.prototype.init = function() {	
	this.suggest.o = document.getElementById(this.suggest.o);
	this.input.parent = document.getElementById(this.input.parent);
	var coords = this.getOffset(this.input.parent);
	this.suggest.o.style.left = coords.left+'px';	
	this.suggest.o.style.top = coords.top+this.input.parent.offsetHeight+'px';
	removeClass(this.suggest.o, 'onfocus');
	this.input.o.value = '';
	this.input.loader = document.getElementById(this.input.loader);
	var parent = this;	
	this.input.o.onblur = function(event) {parent.blur(parent)};
	this.input.o.onclick = function(event) {parent.click(parent)};
	this.input.o.onkeydown = function(event) {parent.keydown(event, parent)};	
	this.input.loader.onclick = function() {parent.loaderClick(parent)};	
}

mnovaSuggest.prototype.click = function(obj) {
	if (this.input.o.value == obj.input.defVal) this.input.o.value = '';
}

mnovaSuggest.prototype.blur = function(obj) {
	this.timeoutBlurHnd = setTimeout(function() {
		if (obj.input.o.value.length == 0) obj.input.o.value = obj.input.defVal;
		obj.suggest.o.style.width = 0;
		removeClass(obj.suggest.o, 'onfocus');
		removeClass(obj.input.loader, 'spinner');
	}, 200);
}

mnovaSuggest.prototype.redrawSuggest = function() {
	addClass(this.suggest.o, 'onfocus');
	this.suggest.o.style.width = 'auto';	
	this.minwidth = this.input.parent.offsetWidth+'px';
	if (this.suggest.o.offsetWidth < parseInt(this.minwidth.replace('px',''), 10))
		this.suggest.o.style.width = this.minwidth;
	else 
		this.suggest.o.style.width = this.suggest.o.offsetWidth;
	this.suggest.o.style.width = parseInt(this.suggest.o.style.width.replace('px', ''), 10)+'px';
	this.mouseOver(1); 
}

mnovaSuggest.prototype.loaderClick = function(obj){
	clearTimeout(obj.timeoutBlurHnd);
	if (obj.input.o.value.length == 0 || obj.input.o.value == obj.input.defVal) return;
	if (!hasClass(obj.input.loader, 'x') && !hasClass(obj.input.loader, 'spinner'))
		obj.getAjaxList();
	else if (hasClass(obj.input.loader, 'x')) {
		removeClass(obj.input.loader, 'spinner');	
		removeClass(obj.input.loader, 'x');
		obj.input.o.value = '';
		removeClass(obj.suggest.o, 'onfocus');
		obj.input.o.focus();
	}
}

mnovaSuggest.prototype.keydown = function(e, obj) {
	e = e || event;
	var code = (e.charCode) ? e.charCode : e.keyCode;
	switch(code) {
    case 13:
    	obj.mouseClick();		
    break; 			      
    case 38:
    	obj.mouseOver(-1);		
    break; 
    case 40:
    	obj.mouseOver(1);		
    break; 
    case 16: case 17: case 20: case 9: case 37: case 39: 
    break;
		default:	
			clearTimeout(obj.timeoutSearchHnd);	
			obj.getAjaxList();	
    break; 	    		      	  				
	} 	
}

mnovaSuggest.prototype.getAjaxList = function() {
	removeClass(this.suggest.o, 'onfocus');
	removeClass(this.input.loader, 'x');			
	addClass(this.input.loader, 'spinner');	
	var parent = this;		
	this.timeoutSearchHnd = setTimeout(function() {		
		if (parent.input.o.value.length==0) { 
			removeClass(parent.input.loader, 'spinner');					
			return;	
		}
		parent.countRequest++;	
		var loadData = new LoadDataSearch(parent);
		loadData.getData(parent.url+"?lang=ru&id="+parent.countRequest+"&fchar="+encodeURIComponent((parent.input.o.value)));		
	}, this.searchTimeout);	
}

mnovaSuggest.prototype.mouseClick = function() {
	for(var i=0; i<this.items.length; i++) {
		var o = document.getElementById(this.items[i].id);
		if (hasClass(o, 'onhover')) {
			if(this.items[i].type == 't')
				document.location = '/frc/'+this.items[i].id+'.htm';
			if(this.items[i].type == 'a') 
				document.location = '/avia/'+((parseInt(this.items[i].id, 10)+10000)*(-1))+'.htm';			
			if(this.items[i].type == 'c')
				document.location = '/list/countries/'+this.escape(this.items[i].name);
			if(this.items[i].type == 'd')
				document.location = '/list/regions/'+this.escape(this.items[i].id);
			if(this.items[i].type == 'mu')
				document.location = '/list/municipals/'+this.escape(this.items[i].id);			
			return;
		}			
	}
	var o = document.getElementById("err_a");
	if (o) document.location = document.getElementById("err_a").getAttribute('href');
}

mnovaSuggest.prototype.mouseOver = function(step, o) {
	if (!this.items) return;
	if (this.items.length == 0) {
		//o = document.getElementById('discript');
		//if (o) addClass(o, 'onhover');
		return;
	}
	var e = null;
	if (!o) {
		for(var i=0; i<this.items.length; i++) {
			o = document.getElementById(this.items[i].id);
			if (hasClass(o, 'onhover')) {
				e = this.items[i+step]!=undefined?this.items[i+step]:
								step==1?this.items[0]:this.items[this.items.length-1];
				this.input.o.value = e.name; 								
				break;						
			}							
		}
		if (!e) 
			e = step==1?this.items[0]:this.items[this.items.length-1];
		o = document.getElementById(e.id);			
	}
	this.mouseOut();	
	if (o) addClass(o, 'onhover');	
	if (!e) 
		for(var i=0; i<this.items.length; i++) {
			o = document.getElementById(this.items[i].id);
			if (hasClass(o, 'onhover')) {
				e = this.items[i]; 	
			}	
		}		
	if (!e) this.items[0];
				
}

mnovaSuggest.prototype.mouseOut = function() {
	var o = null;
	for(var i=0; i<this.items.length; i++) {	
		o = document.getElementById(this.items[i].id); 
		if (o) removeClass(o, 'onhover'); 
	}
}

mnovaSuggest.prototype.getSuggest = function() {
	var html = '',
		str = '',
		isCountry = false,
		isCity = false,
		isAvia = false,
		isDistrict = false,
		isMu = false,
		html = this.suggest.nulltpl;
	addClass(this.suggest.o, 'e');
	for(var i=0; i<this.items.length; i++) {
		if (i==0) html = '';
		if (this.items[i].type=='c' && isCountry == false) { 
			html +=this.suggest.tplc;
			isCountry = true;
		}				
		if (this.items[i].type=='t' && isCity == false) {
			html +=this.suggest.tplt;
			isCity = true;
		}
		if (this.items[i].type=='a' && isAvia == false) {
			html +=this.suggest.tpla;
			isAvia = true;
		}				
		if (this.items[i].type=='d' && isDistrict == false) {
			html +=this.suggest.tpld;
			isDistrict = true;
		}
		if (this.items[i].type=='mu' && isMu == false) {
			html +=this.suggest.tplmu;
			isMu = true;
		}		
	
		html += this.suggest.tpl;
		
	  do{
	  	if (!(str = html.match(/%([\w\d.]+)%/gim)))
	    	break;
	    for (var j in str){
	    	if (parseInt(j, 10) != j) continue;
	    	try {
	     		var tp=str[j].replace(/%/gi,'');
	     		if (this.items[i][tp]) {
	     		 	html = html.replace(str[j], (tp=='d_name' || tp=='mun_name')?this.items[i][tp].replace(/ /gi,'&nbsp;')+',&nbsp;':this.items[i][tp].replace(/ /gi,'&nbsp;'));     			     		}
	     		else 
	      			html = html.replace(str[j], '');
	      }
	      catch(err) {}     
	    }
	  }while(1);		
	}
	if (this.items.length>0) {
		html += '<div class="discript"><span class="all_search"><a href="/search/'+this.escape(this.input.o.value)+'">'+this.suggest.tpl_allsearch+'</a></span></div>';
		html += '<div class="discript"><span class="all_search"><a href="/mgfind.htm">Нет нужного пункта? Используйте Мегапоиск</a></span></div>';	
		removeClass(this.suggest.o, 'e');
	}
	return html;
}

function LoadDataSearch(parent) {
	this.parent = parent; 
  this.XMLObj = null;
  this.getData = function(url) {
	  try {
	  	this.XMLObj = new XMLHttpRequest();
	  } catch(err) {
	  	this.XMLObj = new ActiveXObject("Microsoft.XMLHttp");
	  }
    if (this.XMLObj) {
      this.XMLObj.onreadystatechange = this.LoadDataCallbackFunction (this.XMLObj, this.parent);    
      this.XMLObj.open("GET", url+'&r='+Math.random(), true);
    	this.XMLObj.send(null);
    }
  }

  this.LoadDataCallbackFunction = function(XMLObj, parent) {
  	return function() {
  		parent.items = {};
    	if (XMLObj.readyState == 4) {
    		if (XMLObj.status == 200) {
    			try { 
	    			var data = JSON.parse(XMLObj.responseText);
	    			parent.items = data.items;
					parent.suggest.o.innerHTML = parent.getSuggest().replace('%input.val%', parent.escape(parent.input.o.value)).replace('%input.val%', parent.input.o.value);
					parent.redrawSuggest();				
					addClass(parent.input.loader, 'x');
				}
				catch(err) {}
	      		XMLObj= null;
	      	}
		}
   	}
  }
}

mnovaSuggest.prototype.getOffset = function(elem) {
	function getOffsetSum(elem) {
	 	var top=0, left=0
	 	while(elem) {
	 		top = top + parseInt(elem.offsetTop)
	 		left = left + parseInt(elem.offsetLeft)
	 		elem = elem.offsetParent
		}
	 	return {top: top, left: left}
	}
	
	function getOffsetRect(elem) {
 	 var box = elem.getBoundingClientRect()
 	 var body = document.body
 	 var docElem = document.documentElement
 	 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 	 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 	 var clientTop = docElem.clientTop || body.clientTop || 0
 	 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 	 var top = box.top + scrollTop - clientTop
 	 var left = box.left + scrollLeft - clientLeft
 	 return { top: Math.round(top), left: Math.round(left) }
	}	
	
	if (elem.getBoundingClientRect)
		return getOffsetRect(elem)
	else
	 	return getOffsetSum(elem)
}

function getNavigatorName() {
	var useragent=navigator.userAgent;
	var navigatorname;
	if (useragent.indexOf('MSIE')!= -1) {
	    navigatorname="MSIE";
	}
	else if (useragent.indexOf('Gecko')!= -1) {
	    if (useragent.indexOf('Chrome')!= -1)
	    navigatorname="Chrome";
	    else navigatorname="Mozilla";
	}
	else if (useragent.indexOf('Mozilla')!= -1) {
	    navigatorname="old Netscape or Mozilla";
	}
	else if (useragent.indexOf('Opera')!= -1) {
	    navigatorname="Opera";
	}
	return navigatorname.toLowerCase();
}

function addClass(o, c){
	if (!o) return;
	var re = new RegExp("(^|\\s)" + c + "(\\s|$)", "g");
	if (re.test(o.className)) return
	o.className = (o.className + " " + c).replace(/\s+/g, " ").replace(/(^ | $)/g, "");
}
  
function removeClass(o, c){
	if (!o) return;	
	var re = new RegExp("(^|\\s)" + c + "(\\s|$)", "g");
	o.className = o.className.replace(re, "$1").replace(/\s+/g, " ").replace(/(^ | $)/g, "");
}

function hasClass(o, c) {
	if (!o) return '';	
	return o.className.match(new RegExp('(\\s|^)'+c+'(\\s|$)'));
}

mnovaSuggest.prototype.escape = function(str) {
	var trans = [];
	for (var i = 0x410; i <= 0x44F; i++) trans[i] = i - 0x350; // A-?a-y
	trans[0x401] = 0xA8;    // ?
	trans[0x451] = 0xB8;    // ?
	trans[0x457] = 0xBF;    // ?
	trans[0x407] = 0xAF;    // ?
	trans[0x456] = 0xB3;    // ?
	trans[0x406] = 0xB2;    // ?
	trans[0x404] = 0xBA;    // ?
	trans[0x454] = 0xAA;    // ?
	
  var res='';
  for (var i = 0; i < str.length; i++) {
    var n = str.charCodeAt(i);
    if (typeof trans[n] != 'undefined') {
      n = trans[n];
      res=res+escape(String.fromCharCode(n));
    }
    else {
      n = str.charAt(i);
      res=res+n;
    }
  }
  return res;
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJtZXRlb25vdmEuYXZpYS5taW4uanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8vL0dyYXBoaWNzLy8vXHJcblxyXG5mdW5jdGlvbiBzZXRQcmVsb2FkZXJQaWN0KHBhcmVudElkLHByZWxvYWRlcklkLHByZWxvYWRlclN0eWxlKXtcclxuICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICBkaXYuc2V0QXR0cmlidXRlKCdpZCcsIHByZWxvYWRlcklkKTtcclxuICB2YXIgcyA9IGRpdi5zdHlsZTtcclxuICBzLnBvc2l0aW9uID0gXCJhYnNvbHV0ZVwiO1xyXG4gIHMuekluZGV4PTEyO1xyXG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHBhcmVudElkKS5hcHBlbmRDaGlsZChkaXYpO1xyXG4gIGlmIChwcmVsb2FkZXJTdHlsZT09XCJtaW5pXCIpXHJcbiAgXHRkaXYuaW5uZXJIVE1MPVwiPGltZyBzcmM9XFxcIi9pbWFnZXMvYWpheC1taW5pbG9hZGVyLmdpZlxcXCIgd2lkdGg9XFxcIjE2XFxcIiBoZWlnaHQ9XFxcIjE2XFxcIiAvPlwiO1xyXG4gIGVsc2UgZGl2LmlubmVySFRNTD1cIjxpbWcgc3JjPVxcXCIvaW1hZ2VzL2FqYXgtbG9hZGVyLmdpZlxcXCIgd2lkdGg9XFxcIjkzXFxcIiBoZWlnaHQ9XFxcIjI2XFxcIiAvPlwiO1xyXG4gIHJldHVybiBkaXY7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFBvcyhlbCxzUHJvcCkge1xyXG5cdHZhciBpUG9zID0gMDtcclxuXHR3aGlsZSAoZWwhPW51bGwpIHtcclxuXHRcdGlQb3MrPWVsW1wib2Zmc2V0XCIgKyBzUHJvcF1cclxuXHRcdGVsID0gZWwub2Zmc2V0UGFyZW50O1xyXG5cdH1cclxuXHRyZXR1cm4gaVBvc1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRPZmZzZXQoZWxlbSkge1xyXG4gaWYgKGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KSB7XHJcbiByZXR1cm4gZ2V0T2Zmc2V0UmVjdChlbGVtKVxyXG4gfSBlbHNlIHtcclxuIHJldHVybiBnZXRPZmZzZXRTdW0oZWxlbSlcclxuIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0T2Zmc2V0U3VtKGVsZW0pIHtcclxuIHZhciB0b3A9MCwgbGVmdD0wXHJcbiB3aGlsZShlbGVtKSB7XHJcbiB0b3AgPSB0b3AgKyBwYXJzZUludChlbGVtLm9mZnNldFRvcClcclxuIGxlZnQgPSBsZWZ0ICsgcGFyc2VJbnQoZWxlbS5vZmZzZXRMZWZ0KVxyXG4gZWxlbSA9IGVsZW0ub2Zmc2V0UGFyZW50XHJcbiB9XHJcbiBcclxuIHJldHVybiB7dG9wOiB0b3AsIGxlZnQ6IGxlZnR9XHJcbn1cclxuIFxyXG5cclxuZnVuY3Rpb24gZ2V0T2Zmc2V0UmVjdChlbGVtKSB7XHJcbiB2YXIgYm94ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxyXG4gdmFyIGJvZHkgPSBkb2N1bWVudC5ib2R5XHJcbiB2YXIgZG9jRWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudFxyXG4gXHJcbiB2YXIgc2Nyb2xsVG9wID0gd2luZG93LnBhZ2VZT2Zmc2V0IHx8IGRvY0VsZW0uc2Nyb2xsVG9wIHx8IGJvZHkuc2Nyb2xsVG9wXHJcbiB2YXIgc2Nyb2xsTGVmdCA9IHdpbmRvdy5wYWdlWE9mZnNldCB8fCBkb2NFbGVtLnNjcm9sbExlZnQgfHwgYm9keS5zY3JvbGxMZWZ0XHJcbiBcclxuIHZhciBjbGllbnRUb3AgPSBkb2NFbGVtLmNsaWVudFRvcCB8fCBib2R5LmNsaWVudFRvcCB8fCAwXHJcbiB2YXIgY2xpZW50TGVmdCA9IGRvY0VsZW0uY2xpZW50TGVmdCB8fCBib2R5LmNsaWVudExlZnQgfHwgMFxyXG4gXHJcbiB2YXIgdG9wID0gYm94LnRvcCArIHNjcm9sbFRvcCAtIGNsaWVudFRvcFxyXG4gdmFyIGxlZnQgPSBib3gubGVmdCArIHNjcm9sbExlZnQgLSBjbGllbnRMZWZ0XHJcbiBcclxuIHJldHVybiB7IHRvcDogTWF0aC5yb3VuZCh0b3ApLCBsZWZ0OiBNYXRoLnJvdW5kKGxlZnQpIH1cclxufVxyXG5cclxuZnVuY3Rpb24gc2V0UHJlbG9hZGVyU3R5bGUocGFyZW50RGl2LHByZWxvYWRlckRpdil7XHJcblx0dmFyIGRpdj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChwcmVsb2FkZXJEaXYpO1xyXG5cdHZhciBwZGl2PWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHBhcmVudERpdik7XHJcblx0ZGl2LnN0eWxlLmxlZnQ9TWF0aC5yb3VuZChwZGl2Lm9mZnNldFdpZHRoLzIpLU1hdGgucm91bmQoZGl2Lm9mZnNldFdpZHRoLzIpK1wicHhcIjtcclxuXHJcblx0aWYgKChwYXJlbnREaXY9PVwidG93bnNDb250YWluZXJcIikgJiYgKHBkaXYuY2xhc3NOYW1lPT1cInRvd25zQ29udGFpbmVyTWFpblwiKSlcclxuXHRcdGRpdi5zdHlsZS50b3A9TWF0aC5yb3VuZChwZGl2Lm9mZnNldEhlaWdodC8yKS1NYXRoLnJvdW5kKGRpdi5vZmZzZXRIZWlnaHQvMikrXCJweFwiO1xyXG5cdGVsc2VcclxuXHRcdGRpdi5zdHlsZS50b3A9TWF0aC5yb3VuZChwZGl2Lm9mZnNldEhlaWdodC8yKSsxNS1NYXRoLnJvdW5kKGRpdi5vZmZzZXRIZWlnaHQvMikrXCJweFwiO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpbml0UHJlbG9hZGVyKHBhcmVudElkLCBwcmVsb2FkZXJJZCxwcmVsb2FkZXJTdHlsZSkge1xyXG5cdHZhciBwb2JqPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHBhcmVudElkKTtcclxuXHJcblx0dmFyIG9iaj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChwcmVsb2FkZXJJZCk7XHJcblx0aWYgKCFvYmopIHtcclxuXHJcblx0XHRvYmo9c2V0UHJlbG9hZGVyUGljdChwYXJlbnRJZCxwcmVsb2FkZXJJZCxwcmVsb2FkZXJTdHlsZSk7XHJcblx0XHRzZXRQcmVsb2FkZXJTdHlsZShwYXJlbnRJZCxwcmVsb2FkZXJJZCk7XHJcblxyXG5cdH1cclxuXHJcblx0b2JqLnN0eWxlLnZpc2liaWxpdHk9XCJ2aXNpYmxlXCI7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIEdyYXBoT2JqKHRvd25pbmRleCxnZW9zdWZmaXgpIHtcclxuXHJcblx0dmFyIGdyYXBoID0gdGhpcztcclxuXHRncmFwaC5fdG93bmluZGV4PXRvd25pbmRleDtcclxuXHRncmFwaC5fYXJyR3JhcGhOYW1lPW5ldyBBcnJheShcIlBcIixcIlRcIixcIlJcIixcIldcIik7XHJcblx0Z3JhcGguX249Z3JhcGguX2FyckdyYXBoTmFtZS5sZW5ndGg7XHJcblx0Z3JhcGguX2FyckdyYXBoUGljPW5ldyBBcnJheSgpO1xyXG5cdGdyYXBoLl9sYXN0U2hvd0dyYXBoaWM9MDtcclxuXHRncmFwaC5fZ3JhcGhpY1RpbWVyPW51bGw7XHJcblxyXG5cdGdyYXBoLnByZWxvYWRHcmFwaD1mdW5jdGlvbigpIHtcclxuXHRcdHZhciBrPTA7XHJcblx0XHRmb3IgKHZhciBpPW51bUZSQypncmFwaC5fbjsgaTwobnVtRlJDKzEpKmdyYXBoLl9uOyBpKyspe1xyXG5cdFx0XHRpZiAoZ3JhcGguX2FyckdyYXBoUGljW2ldPT1udWxsKSB7XHJcblx0XHRcdFx0Z3JhcGguX2FyckdyYXBoUGljW2ldPW5ldyBJbWFnZSgpO1xyXG5cdFx0XHRcdGdyYXBoLl9hcnJHcmFwaFBpY1tpXS5zcmM9XCJodHRwOi8vd3d3Lm1ldGVvbm92YS5ydS9pbWFnZXMvZ3JhcGhpY3MvXCIrZ3JhcGguX2FyckdyYXBoTmFtZVtrXStcIkdcIitncmFwaC5fdG93bmluZGV4K1wiXzFcIitudW1GUkMrXCIucG5nXCIrZ2Vvc3VmZml4O1xyXG5cdFx0XHRcdGdyYXBoLl9hcnJHcmFwaFBpY1tpXS5vbkxvYWQ9Z3JhcGguaW5pdEdyYXBoaWMoaSk7XHJcblx0XHQgIH1cclxuXHRcdCAgaysrO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0Z3JhcGgucHJlbG9hZEdyYXBoaWM9ZnVuY3Rpb24oaykge1xyXG5cdFx0dmFyIGk9bnVtRlJDKmdyYXBoLl9uK2s7XHJcblx0XHRpZiAoZ3JhcGguX2FyckdyYXBoUGljW2ldPT1udWxsKSB7XHJcblx0XHRcdGdyYXBoLl9hcnJHcmFwaFBpY1tpXT1uZXcgSW1hZ2UoKTtcclxuXHRcdFx0Z3JhcGguX2FyckdyYXBoUGljW2ldLnNyYz1cImh0dHA6Ly93d3cubWV0ZW9ub3ZhLnJ1L2ltYWdlcy9ncmFwaGljcy9cIitncmFwaC5fYXJyR3JhcGhOYW1lW2tdK1wiR1wiK2dyYXBoLl90b3duaW5kZXgrXCJfMVwiK251bUZSQytcIi5wbmdcIitnZW9zdWZmaXg7XHJcblx0XHRcdGdyYXBoLl9hcnJHcmFwaFBpY1tpXS5vbkxvYWQ9Z3JhcGguaW5pdEdyYXBoaWMoaSk7XHJcblx0XHQgIH1cclxuXHR9XHJcblxyXG5cdGdyYXBoLmluaXRHcmFwaGljPWZ1bmN0aW9uKGkpIHtcclxuXHRcdGlmICghZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJncmFwaFwiK2kpKSB7XHJcblx0ICBcdFx0dmFyIGltZz0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImltZ1wiKTtcclxuXHRcdFx0XHRpbWcuc2V0QXR0cmlidXRlKFwiaWRcIiwgXCJncmFwaFwiK2kpO1xyXG5cdCAgXHRcdGltZy5zcmM9Z3JhcGguX2FyckdyYXBoUGljW2ldLnNyYztcclxuXHRcdFx0XHR2YXIgcyA9IGltZy5zdHlsZTtcclxuXHRcdFx0XHRzLnRvcD0wO1xyXG5cdCAgXHRcdHMubGVmdD0wO1xyXG5cdCAgXHRcdHMudmlzaWJpbGl0eSA9IFwiaGlkZGVuXCI7XHJcblx0ICBcdFx0cy5wb3NpdGlvbiA9IFwiYWJzb2x1dGVcIjtcclxuXHQgIFx0XHRzLnpJbmRleD0xMjtcclxuXHRcdFx0ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dyYXBoaWMnKS5hcHBlbmRDaGlsZChpbWcpO1xyXG5cdCAgfVxyXG5cdH1cclxuXHJcblx0Z3JhcGguc2hvd0dyYXBoaWM9ZnVuY3Rpb24oZWwsZ3JhcGhfbnVtKSB7XHJcblx0XHRjbGVhclRpbWVvdXQoZ3JhcGguX2dyYXBoaWNUaW1lcik7XHJcbiBcdFx0dmFyIG9iaj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImdyYXBoaWNcIik7XHJcbiAgIFx0XHRpZiAob2JqKSB7XHJcbi8vICAgIFx0XHRvYmouc3R5bGUubGVmdCA9IGdldFBvcyhkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInRkMlwiKSxcIkxlZnRcIik7XHJcbi8vICAgICBcdFx0b2JqLnN0eWxlLnRvcCA9ICBnZXRQb3MoZWwsXCJUb3BcIikrZWwub2Zmc2V0SGVpZ2h0K1wicHhcIjtcclxuXHRcdG9iai5zdHlsZS5sZWZ0ID0gZ2V0T2Zmc2V0KGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZnJjX2NvbnRcIikpLmxlZnQrXCJweFwiO1xyXG5cdFx0b2JqLnN0eWxlLnRvcCA9ICBnZXRPZmZzZXQoZWwpLnRvcCtlbC5vZmZzZXRIZWlnaHQrXCJweFwiO1xyXG4gICAgIFx0XHRvYmouc3R5bGUudmlzaWJpbGl0eSA9IFwidmlzaWJsZVwiO1xyXG4gICAgXHR9XHJcblxyXG4gICAgdmFyIGRpdj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImdyYXBoXCIrZ3JhcGguX2xhc3RTaG93R3JhcGhpYyk7XHJcbiAgICBpZiAoZGl2KSBkaXYuc3R5bGUudmlzaWJpbGl0eT1cImhpZGRlblwiO1xyXG5cclxuICAgIGRpdj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImdyYXBoXCIrZ3JhcGhfbnVtKTtcclxuICAgXHRpZiAoZGl2KSB7XHJcbiAgIFx0XHRkaXYuc3R5bGUudmlzaWJpbGl0eT1cInZpc2libGVcIjtcclxuICAgXHRcdGdyYXBoLl9sYXN0U2hvd0dyYXBoaWM9Z3JhcGhfbnVtO1xyXG4gICBcdH1cclxuICB9XHJcblxyXG4gIGdyYXBoLmhpZGVHcmFwaGljPWZ1bmN0aW9uKCl7XHJcblx0Y2xlYXJUaW1lb3V0KGdyYXBoLl9ncmFwaGljVGltZXIpO1xyXG4gICAgdmFyIGRpdj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImdyYXBoXCIrZ3JhcGguX2xhc3RTaG93R3JhcGhpYyk7XHJcbiAgICBpZiAoZGl2KSBkaXYuc3R5bGUudmlzaWJpbGl0eT1cImhpZGRlblwiO1xyXG4gICAgZGl2PWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZ3JhcGhpY1wiKTtcclxuICAgIGlmIChkaXYpIGRpdi5zdHlsZS52aXNpYmlsaXR5ID0gXCJoaWRkZW5cIjtcclxuICB9XHJcblxyXG4gIGdyYXBoLnRpbWVySGlkZUdyYXBoaWM9ZnVuY3Rpb24oKSB7XHJcbiAgXHRncmFwaC5fZ3JhcGhpY1RpbWVyPXNldFRpbWVvdXQoZnVuY3Rpb24oKXtncmFwaC5oaWRlR3JhcGhpYygpO30sMTAwMCk7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuLy8vLyBIaW50cyAvLy8vL1xyXG5cclxudmFyIGhpbnRUaW1lb3V0cyA9IG5ldyBBcnJheSgpO1xyXG5cclxuZnVuY3Rpb24gc2hvd0hpbnQocGFyZW50T2JqLCBpZCwgYlZpc2libGUsIHdpZHRoKSB7XHJcblx0aWQgPSBpZC50b1N0cmluZygpO1xyXG5cdHZhciBvYmogPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImhpbnRfY29udGVudF9cIitpZCk7XHJcblx0aWYgKCFvYmopIGluaXRIaW50KGlkLCB3aWR0aCk7XHJcblxyXG5cdHZhciBoaW50T2JqID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpO1xyXG5cdGlmIChoaW50T2JqKSB7XHJcbiAgICBoaW50T2JqLnN0eWxlLmxlZnQ9Z2V0UG9zKHBhcmVudE9iaixcIkxlZnRcIikrMitcInB4XCI7XHJcbiAgICBoaW50T2JqLnN0eWxlLnRvcCA9ICBnZXRQb3MocGFyZW50T2JqLFwiVG9wXCIpK3BhcmVudE9iai5vZmZzZXRIZWlnaHQrMitcInB4XCI7XHJcbiAgICBzZXRUaW1lb3V0SGludChoaW50T2JqLCBiVmlzaWJsZSk7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBzZXRUaW1lb3V0SGludChoaW50T2JqLCBiVmlzaWJsZSkge1xyXG5cdHZhciBpZCA9IGhpbnRPYmouZ2V0QXR0cmlidXRlKFwiaWRcIikudG9TdHJpbmcoKTtcclxuXHR2YXIgaGludFRpbWVvdXQgPSBoaW50VGltZW91dHNbaWRdO1xyXG5cdGNsZWFyVGltZW91dChoaW50VGltZW91dCk7XHJcbiAgaGludFRpbWVvdXRzW2lkXSA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XHJcbiAgXHRcdGlmIChiVmlzaWJsZSkgaGludE9iai5zdHlsZS52aXNpYmlsaXR5PVwidmlzaWJsZVwiO1xyXG4gIFx0XHRlbHNlIGhpbnRPYmouc3R5bGUudmlzaWJpbGl0eT1cImhpZGRlblwiO1xyXG4gICAgfSxcclxuICAgIDUwMFxyXG4gICk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGluaXRNb2RhbFduZChpZCwgd2lkdGgsIGJWaXNpYmxlLCBjYWxsYmFja2Z1bmN0aW9uKSB7XHJcblx0dmFyIG9iaiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiaGludF9jb250ZW50X1wiK2lkKTtcclxuXHRpZiAoIW9iaikgaW5pdEhpbnQoaWQsIHdpZHRoLCBjYWxsYmFja2Z1bmN0aW9uKTtcclxuXHR2YXIgb3ZTdHlsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwib3ZlcmxheVwiKS5zdHlsZTtcclxuXHRtb2RhbFduZFN0eWxlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpLnN0eWxlO1xyXG5cdGlmIChiVmlzaWJsZSkge1xyXG5cdFx0b3ZTdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xyXG5cdFx0bW9kYWxXbmRTdHlsZS52aXNpYmlsaXR5ID0gXCJ2aXNpYmxlXCI7XHJcblx0XHR1cGRhdGVNb2RhbFduZCgpO1xyXG5cdFx0aWYgKGJJRSkgd2luZG93LmF0dGFjaEV2ZW50KCdvbnNjcm9sbCcsIHVwZGF0ZU1vZGFsV25kKTtcclxuXHR9XHJcblx0ZWxzZSB7XHJcblx0XHRvdlN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcclxuXHRcdG1vZGFsV25kU3R5bGUudmlzaWJpbGl0eSA9IFwiaGlkZGVuXCI7XHJcblx0XHR3aW5kb3cuZGV0YWNoRXZlbnQoJ29uc2Nyb2xsJywgdXBkYXRlTW9kYWxXbmQpO1xyXG5cdH1cclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlTW9kYWxXbmQoKSB7XHJcblx0dmFyIGR0b3AgPSAtMTAwO1xyXG5cdHZhciBkZHRvcCA9IDA7XHJcblx0dmFyIGNsaWVudFdpZHRoID0gd2luZG93LmlubmVyV2lkdGggfHwgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGgpIHx8IGRvY3VtZW50LmJvZHkuY2xpZW50V2lkdGg7XHRcclxuXHR2YXIgY2xpZW50SGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0IHx8IChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkgfHwgZG9jdW1lbnQuYm9keS5jbGllbnRIZWlnaHQ7XHJcblx0dmFyIG92U3R5bGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIm92ZXJsYXlcIikuc3R5bGU7XHJcblx0dmFyIG1vZGFsV25kU3R5bGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbW9kYWxXbmQnKS5zdHlsZTtcclxuXHRpZiAoYklFKVxyXG5cdFx0ZGR0b3AgPSB3aW5kb3cucGFnZVlPZmZzZXQgfHwgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wKSB8fCBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcDsgXHJcbiAgbW9kYWxXbmRTdHlsZS5sZWZ0ID0gY2xpZW50V2lkdGgvMi1wYXJzZUludChtb2RhbFduZFN0eWxlLndpZHRoLCAxMCkvMjtcclxuICBtb2RhbFduZFN0eWxlLnRvcCA9IE1hdGgucm91bmQoY2xpZW50SGVpZ2h0LzItcGFyc2VJbnQobW9kYWxXbmRTdHlsZS5oZWlnaHQsIDEwKS8yKStkZHRvcCtkdG9wO1xyXG5cdG92U3R5bGUudG9wID0gZGR0b3A7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGluaXRIaW50KGlkLCB3aWR0aCwgY2FsbGJhY2tmdW5jdGlvbikge1xyXG5cdHZhciBpbWdVcmwgPSBcIi9pbWFnZXMvaGludHNcIjtcclxuXHR2YXIgaGludE9iaiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTtcclxuXHRpZiAoaGludE9iaikge1xyXG5cdFx0dmFyIGNvbnRlbnQgPSBoaW50T2JqLmlubmVySFRNTDtcclxuXHRcdHZhciBoaW50QmxvY2sgPSBcIjxkaXY+XCI7XHJcblx0XHRoaW50QmxvY2srPVwiPGRpdiBjbGFzcz0naGludF90b3BfbGVmdCc+PGltZyBzcmM9J1wiK2ltZ1VybCtcIi9oaW50X3RvcF9sZWZ0LnBuZycgd2lkdGg9JzE1JyBoZWlnaHQ9JzE4JyBjbGFzcz0nY29ybmVyJyBvbkxvYWQ9J3RyYW5zcGFyZW50KHRoaXMpJz48L2Rpdj5cIjtcclxuXHRcdGhpbnRCbG9jays9XCI8ZGl2IGNsYXNzPSdoaW50X3RvcF9jZW50ZXInIHN0eWxlPSd3aWR0aDogXCIrd2lkdGgrXCJweDsnPjwvZGl2PlwiO1xyXG5cdFx0aGludEJsb2NrKz1cIjxkaXYgY2xhc3M9J2hpbnRfdG9wX3JpZ2h0Jz48aW1nIHNyYz0nXCIraW1nVXJsK1wiL2hpbnRfdG9wX3JpZ2h0LnBuZycgd2lkdGg9JzIzJyBoZWlnaHQ9JzE4JyBjbGFzcz0nY29ybmVyJyBvbkxvYWQ9J3RyYW5zcGFyZW50KHRoaXMpJz48L2Rpdj5cIjtcclxuXHRcdGhpbnRCbG9jays9XCI8L2Rpdj5cIjtcclxuICAgIGhpbnRCbG9jays9XCI8ZGl2PlwiO1xyXG5cdFx0aGludEJsb2NrKz1cIjxkaXYgY2xhc3M9J2hpbnRfYm9keV9sZWZ0JyBpZD0naGludF9ib2R5X2xlZnRcIitpZCtcIic+PGltZyBzcmM9J1wiK2ltZ1VybCtcIi9oaW50X2JvZHlfbGVmdC5wbmcnIGlkPSdpbWdfaGludF9ib2R5X2xlZnRcIitpZCtcIicgd2lkdGg9MTUgb25Mb2FkPSd0cmFuc3BhcmVudCh0aGlzKSc+PC9kaXY+XCI7XHJcblx0XHR2YXIgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbW9kYWxXbmQnKTtcdFxyXG5cdFx0aWYgKGNhbGxiYWNrZnVuY3Rpb24gJiYgZWwpIGhpbnRCbG9jays9XCI8ZGl2IGNsYXNzPSdoaW50X2JvZHlfY2VudGVyJyBpZD0naGludF9jb250ZW50X1wiK2lkK1wiJyBzdHlsZT0nd2lkdGg6IFwiK3dpZHRoK1wicHg7IGJhY2tncm91bmQtY29sb3I6ICNmOGY5ZmQnPlwiK2NvbnRlbnQrXCI8ZGl2IGNsYXNzPSdidG4tY2xvc2UnPjxhIGhyZWY9J2phdmFzY3JpcHQ6ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXFxcIk1vZGFsV25kQnRuQ2Fuc2VsXFxcIikub25jbGljaygpJz48L2E+PC9kaXY+PC9kaXY+XCI7XHJcblx0XHRlbHNlIGhpbnRCbG9jays9XCI8ZGl2IGNsYXNzPSdoaW50X2JvZHlfY2VudGVyJyBpZD0naGludF9jb250ZW50X1wiK2lkK1wiJyBzdHlsZT0nd2lkdGg6IFwiK3dpZHRoK1wicHg7IGJhY2tncm91bmQtY29sb3I6ICNmOGY5ZmQnPlwiK2NvbnRlbnQrXCI8L2Rpdj5cIjsgXHJcblx0XHRoaW50QmxvY2srPVwiPGRpdiBjbGFzcz0naGludF9ib2R5X3JpZ2h0JyAgaWQ9J2hpbnRfYm9keV9yaWdodFwiK2lkK1wiJz48aW1nIHNyYz0nXCIraW1nVXJsK1wiL2hpbnRfYm9keV9yaWdodC5wbmcnIGlkPSdpbWdfaGludF9ib2R5X3JpZ2h0XCIraWQrXCInIHdpZHRoPTIzIG9uTG9hZD0ndHJhbnNwYXJlbnQodGhpcyknPjwvZGl2PlwiO1xyXG5cdFx0aGludEJsb2NrKz1cIjwvZGl2PlwiO1xyXG4gICAgaGludEJsb2NrKz0gXCI8ZGl2IHN0eWxlPVxcXCJtYXJnaW4tdG9wOiAtMnB4O1xcXCI+XCI7XHJcblx0XHRoaW50QmxvY2srPVwiPGRpdiBjbGFzcz0naGludF9ib3R0b21fbGVmdCc+PGltZyBzcmM9J1wiK2ltZ1VybCtcIi9oaW50X2JvdHRvbV9sZWZ0LnBuZycgd2lkdGg9JzE1JyBoZWlnaHQ9JzE4JyBjbGFzcz0nY29ybmVyJyBvbkxvYWQ9J3RyYW5zcGFyZW50KHRoaXMpJz48L2Rpdj5cIjtcclxuXHRcdGhpbnRCbG9jays9XCI8ZGl2IGNsYXNzPSdoaW50X2JvdHRvbV9jZW50ZXInIHN0eWxlPSd3aWR0aDogXCIrd2lkdGgrXCJweDsnPjwvZGl2PlwiO1xyXG5cdFx0aGludEJsb2NrKz1cIjxkaXYgY2xhc3M9J2hpbnRfYm90dG9tX3JpZ2h0Jz48aW1nIHNyYz0nXCIraW1nVXJsK1wiL2hpbnRfYm90dG9tX3JpZ2h0LnBuZycgd2lkdGg9JzIzJyBoZWlnaHQ9JzE4JyBjbGFzcz0nY29ybmVyJyBvbkxvYWQ9J3RyYW5zcGFyZW50KHRoaXMpJz48L2Rpdj5cIjtcclxuXHRcdGhpbnRCbG9jays9XCI8L2Rpdj5cIjtcclxuXHRcdGhpbnRPYmouaW5uZXJIVE1MID0gaGludEJsb2NrO1xyXG5cdFx0dmFyIGNvbnRlbnRfaGVpZ2h0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJoaW50X2NvbnRlbnRfXCIraWQpLm9mZnNldEhlaWdodDtcclxuXHRcdGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiaW1nX2hpbnRfYm9keV9sZWZ0XCIraWQpLnN0eWxlLmhlaWdodCA9IGNvbnRlbnRfaGVpZ2h0KydweCc7XHJcblx0XHRkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImltZ19oaW50X2JvZHlfcmlnaHRcIitpZCkuc3R5bGUuaGVpZ2h0ID0gY29udGVudF9oZWlnaHQrJ3B4JztcclxuXHRcdGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiaGludF9ib2R5X2xlZnRcIitpZCkuc3R5bGUuaGVpZ2h0ID0gY29udGVudF9oZWlnaHQrJ3B4JztcclxuXHRcdGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiaGludF9ib2R5X3JpZ2h0XCIraWQpLnN0eWxlLmhlaWdodCA9IGNvbnRlbnRfaGVpZ2h0KydweCc7XHRcdFxyXG5cdFx0aGludE9iai5zdHlsZS53aWR0aCA9IHdpZHRoKzQwKydweCc7XHJcblx0XHRoaW50T2JqLnN0eWxlLmhlaWdodCA9IGNvbnRlbnRfaGVpZ2h0KydweCc7XHJcblx0XHRlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdNb2RhbFduZEJ0bk9rJyk7XHJcblx0XHRpZiAoY2FsbGJhY2tmdW5jdGlvbiAmJiBlbCkgZWwub25jbGljayA9IGNhbGxiYWNrZnVuY3Rpb247XHJcblx0fVxyXG59XHJcblxyXG4vLy8vIFNjcm9sbCBGb3JlY2FzdHMgLy8vLy9cclxuXHJcbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vINC/0YDQvtC60YDRg9GC0LrQsCDQv9GA0L7Qs9C90L7Qt9CwLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXHJcblxyXG52YXIgdG09bnVsbDtcclxudmFyIHNwZD0xMDtcclxudmFyIHRsZWZ0PS05OTk7XHJcbkRfSURMRT0wO1xyXG5EX1NDUk9MTExFRlQ9MTtcclxuRF9TQ1JPTExSSUdIVD0yO1xyXG5EX0FMSUdOTEVGVD0zO1xyXG5EX0FMSUdOUklHSFQ9NDtcclxuRF9TRVRQT1M9NTtcclxuRF9TQ1JPTExUT1A9NjtcclxuRF9TQ1JPTExCT1RUT009NztcclxuRF9BTElHTlRPUD04O1xyXG5EX0FMSUdOQk9UVE9NPTk7XHJcbnZhciBtb2RlPURfSURMRTtcclxudmFyIGZjbz1udWxsO1xyXG5cclxuZnVuY3Rpb24gc2Nyb2xsSChpKXtcclxuICB3aXRoKGZjbyl7XHJcbiAgICB2YXIgcG9zID0gc2Nyb2xsTGVmdCtpO1xyXG4gICAgaWYocG9zPDApIHsgcG9zPTA7IG1vZGU9RF9JRExFO30gZWxzZSBpZihwb3M+PXNjcm9sbFdpZHRoKXsgcG9zPXNjcm9sbFdpZHRoLTE7IG1vZGU9RF9JRExFO30gZWxzZSBzY3JvbGxMZWZ0PXBvcztcclxuICAgIH1cclxuICB9XHJcbmZ1bmN0aW9uIHNjcm9sbFYoaSl7XHJcbiAgd2l0aChmY28pe1xyXG4gICAgdmFyIHBvc3YgPSBzY3JvbGxUb3AraTtcclxuICAgIGlmKHBvc3Y8MCkgeyBwb3N2PTA7IG1vZGU9RF9JRExFO30gZWxzZSBpZihwb3N2Pj1zY3JvbGxIZWlnaHQpeyBwb3N2PXNjcm9sbEhlaWdodC0xOyBtb2RlPURfSURMRTt9IGVsc2Ugc2Nyb2xsVG9wPXBvc3Y7XHJcbiAgICB9XHJcbiAgfVxyXG5mdW5jdGlvbiBzdG9wQXV0b1Njcm9sbCgpeyBpZihtb2RlPT1EX1NDUk9MTExFRlQpIG1vZGU9RF9BTElHTkxFRlQ7IGVsc2UgaWYobW9kZT09RF9TQ1JPTExSSUdIVCkgbW9kZT1EX0FMSUdOUklHSFQ7fVxyXG5mdW5jdGlvbiBnb0xlZnQoKXsgbW9kZT1EX1NDUk9MTExFRlQ7IH1cclxuZnVuY3Rpb24gZ29SaWdodCgpeyBtb2RlPURfU0NST0xMUklHSFQ7IH1cclxuZnVuY3Rpb24gZ29Ub3AoKXsgbW9kZT1EX1NDUk9MTFRPUDsgfVxyXG5mdW5jdGlvbiBnb0JvdHRvbSgpeyBtb2RlPURfU0NST0xMQk9UVE9NOyB9XHJcbmZ1bmN0aW9uIGdvVG9GUkMoKXtcclxuIG1vZGU9RF9TRVRQT1M7IH0gXHJcblxyXG5mdW5jdGlvbiB0bURpc3BhdGNoKCl7XHJcbnN3aXRjaChtb2RlKSB7XHJcbiBjYXNlIERfSURMRTogICAgICAgIHNwZD0xMDsgYnJlYWs7XHJcbiBjYXNlIERfU0NST0xMTEVGVDogIHNjcm9sbEgoLXNwZC8xMCk7IHNwZCsrOyBpZihzcGQ+NjApIHNwZD02MDsgdXBkYXRlRm9yZWNhc3RCZyhNYXRoLnJvdW5kKGZjby5zY3JvbGxMZWZ0L2Zjby5zY3JvbGxXaWR0aCo2KSk7IGJyZWFrO1xyXG4gY2FzZSBEX1NDUk9MTFJJR0hUOiBzY3JvbGxIKHNwZC8xMCk7IHNwZCsrOyBpZihzcGQ+NjApIHNwZD02MDsgdXBkYXRlRm9yZWNhc3RCZyhNYXRoLnJvdW5kKGZjby5zY3JvbGxMZWZ0L2Zjby5zY3JvbGxXaWR0aCo2KSk7IGJyZWFrO1xyXG4gY2FzZSBEX0FMSUdOTEVGVDogICBkPWZjby5zY3JvbGxMZWZ0ICUgNTE7IGlmKGQ+MSkgc2Nyb2xsSCgtMSk7IGVsc2UgbW9kZT1EX0lETEU7IGJyZWFrO1xyXG4gY2FzZSBEX0FMSUdOUklHSFQ6ICBkPWZjby5zY3JvbGxMZWZ0ICUgNTE7IGlmKGQ+MSkgc2Nyb2xsSCgxKTsgZWxzZSBtb2RlPURfSURMRTsgYnJlYWs7XHJcbiBjYXNlIERfU0VUUE9TOiAgICAgIHBvcz1udW1GUkMqNTEwKzE7IGQ9cG9zLWZjby5zY3JvbGxMZWZ0OyBpZihNYXRoLmFicyhkKT42MDApIHNwPTgwOyBlbHNlIGlmKE1hdGguYWJzKGQpPjIwMCkgc3A9NDA7IGVsc2UgaWYoTWF0aC5hYnMoZCk+NDApIHNwPTIwOyBlbHNlIHNwPTE7IGlmKGQ+PTEpIHNjcm9sbEgoc3ApOyBlbHNlICBpZihkPD0tMSkgc2Nyb2xsSCgtc3ApOyBlbHNlIG1vZGU9RF9JRExFOyBicmVhaztcclxuIGNhc2UgRF9TQ1JPTExUT1A6ICAgc2Nyb2xsVigtc3BkLzEwKTsgc3BkKys7IGlmKHNwZD42MCkgc3BkPTYwOyBicmVhaztcclxuIGNhc2UgRF9TQ1JPTExCT1RUT006IHNjcm9sbFYoc3BkLzEwKTsgc3BkKys7IGlmKHNwZD42MCkgc3BkPTYwOyBicmVhaztcclxuIGNhc2UgRF9BTElHTlRPUDogICAgZD1mY28uc2Nyb2xsVG9wICUgMTU7IGlmKGQ+MSkgc2Nyb2xsVigtMSk7IGVsc2UgbW9kZT1EX0lETEU7IGJyZWFrO1xyXG4gY2FzZSBEX0FMSUdOQk9UVE9NOiAgZD1mY28uc2Nyb2xsVG9wICUgMTU7IGlmKGQ+MSkgc2Nyb2xsVigxKTsgZWxzZSBtb2RlPURfSURMRTsgYnJlYWs7XHJcbiB9XHJcbn1cclxuXHJcbnZhciBhcnJGcmNEYXk9bmV3IEFycmF5KFwiMFwiLFwiMVwiLFwiMlwiLFwiM1wiLFwiNFwiLFwiNVwiKTtcclxudmFyIG51bUZSQz0wO1xyXG5mdW5jdGlvbiBjaGVja0ZyY1RvcExpbmsoKXtcclxuICAgZm9yICh2YXIgaT0wOyBpPGFyckZyY0RheS5sZW5ndGg7IGkrKylcclxuICAgICBpZiAobnVtRlJDPj0wICYmIG51bUZSQz09YXJyRnJjRGF5W2ldKSB7XHJcbiAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImZyY19cIithcnJGcmNEYXlbaV0pLnN0eWxlLmNvbG9yPVwiIzNiNTVjNVwiO1xyXG4gICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJmcmNfXCIrYXJyRnJjRGF5W2ldKS5zdHlsZS5mb250V2VpZ2h0PVwiYm9sZFwiO1xyXG4gICAgIH1cclxuICAgICBlbHNlIHtcclxuICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZnJjX1wiK2FyckZyY0RheVtpXSkuc3R5bGUuY29sb3I9XCIjMDAwMGVlXCI7XHJcbiAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImZyY19cIithcnJGcmNEYXlbaV0pLnN0eWxlLmZvbnRXZWlnaHQ9XCJub3JtYWxcIjtcclxuICAgICB9XHJcbiB9XHJcblxyXG5cclxuZnVuY3Rpb24gaW5pdFNjcm9sbENvbnRlbnQob2JqKSB7XHJcblx0ICBpZihvYmopIHtcclxuXHQgICBvYmouc3RhdGUgPSAwO1xyXG5cdFx0IG9iai5tYXhWZXJ0ID0gb2JqLnNjcm9sbEhlaWdodCAtIG9iai5vZmZzZXRIZWlnaHQ7XHJcblx0ICB9XHJcblx0fVxyXG5cclxuICBmdW5jdGlvbiBzY3JvbGwodmFsLGNvbnRlbnRJZCkge1xyXG4gICAgdmFyIG9iaj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChjb250ZW50SWQpO1xyXG4gICBcdGlmIChvYmopIHtcclxuICAgXHRcdGluaXRTY3JvbGxDb250ZW50KG9iaik7XHJcbiAgIFx0XHRvYmouc2Nyb2xsVG9wPW9iai5tYXhWZXJ0Kih2YWwvMTAwKTtcclxuICAgIH1cclxuXHR9XHJcblxyXG4gIGZ1bmN0aW9uIHNjcm9sbDIoZWwsY29udGVudElkLCB2U2xpZGVyLHNsaWRlSGFuZGxlKSB7XHJcbiAgXHR2YXIgb2JqPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRlbnRJZCk7XHJcbiAgXHRpZiAob2JqKSB7XHJcbiAgXHRcdGluaXRTY3JvbGxDb250ZW50KG9iaik7XHJcbiAgXHRcdGlmIChlbC5nZXRBdHRyaWJ1dGUoXCJpZFwiKS5pbmRleE9mKFwic2xpZGVCb3R0b21cIik+LTEpIHtcclxuICBcdFx0XHRpZiAob2JqLm1heFZlcnQgPiBvYmouc2Nyb2xsVG9wKSBvYmouc2Nyb2xsVG9wPW9iai5zY3JvbGxUb3ArMTY7XHJcbiAgICAgIH0gZWxzZSBvYmouc2Nyb2xsVG9wPW9iai5zY3JvbGxUb3AtMTY7XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIG9iajI9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodlNsaWRlcik7XHJcbiAgICB2YXIgb2JqMz1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChzbGlkZUhhbmRsZSk7XHJcblxyXG4gICAgaWYgKChvYmoyKSYmKG9iajMpKVxyXG4gICAgXHRvYmozLnN0eWxlLnRvcD1NYXRoLmNlaWwob2JqMi5vZmZzZXRIZWlnaHQtMjItKChvYmoyLm9mZnNldEhlaWdodC0yMikqKChvYmoubWF4VmVydC1vYmouc2Nyb2xsVG9wKS9vYmoubWF4VmVydCkpKStcInB4XCI7XHJcblx0fVxyXG5cclxuICBmdW5jdGlvbiBzY3JvbGwzKGNvbnRlbnRJZCwgdlNsaWRlcixzbGlkZUhhbmRsZSwgaSkge1xyXG4gIFx0dmFyIG9iaj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChjb250ZW50SWQpO1xyXG4gIFx0aWYgKG9iaikge1xyXG4gIFx0XHRpbml0U2Nyb2xsQ29udGVudChvYmopO1xyXG4gIFx0ICAgIGlmIChvYmoubWF4VmVydCA+IG9iai5zY3JvbGxUb3ApIG9iai5zY3JvbGxUb3A9KG9iai5zY3JvbGxUb3ArMTYpKmk7XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIG9iajI9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodlNsaWRlcik7XHJcbiAgICB2YXIgb2JqMz1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChzbGlkZUhhbmRsZSk7XHJcblxyXG4gICAgaWYgKChvYmoyKSYmKG9iajMpKVxyXG4gICAgXHRvYmozLnN0eWxlLnRvcD1NYXRoLmNlaWwob2JqMi5vZmZzZXRIZWlnaHQtMjItKChvYmoyLm9mZnNldEhlaWdodC0yMikqKChvYmoubWF4VmVydC1vYmouc2Nyb2xsVG9wKS9vYmoubWF4VmVydCkpKStcInB4XCI7XHJcblx0fVxyXG5cclxuXHJcbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8gTWFrZSBTdGFydCAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cclxuXHJcbmZ1bmN0aW9uIE1ha2VTdGFydEZGKHVybCl7XHJcbmFsZXJ0KCfQp9GC0L7QsdGLINGB0LTQtdC70LDRgtGMINCc0LXRgtC10L7QvdC+0LLRgyDQktCw0YjQtdC5INGB0YLQsNGA0YLQvtCy0L7QuSDRgdGC0YDQsNC90LjRhtC10LksINC/0LXRgNC10YLQsNGJ0LjRgtC1INGB0YHRi9C70LrRgyBcItCh0LTQtdC70LDRgtGMINGB0YLQsNGA0YLQvtCy0L7QuVwiINC90LAg0LjQutC+0L3QutGDINGBINC40LfQvtCx0YDQsNC20LXQvdC40LXQvCDQtNC+0LzQuNC60LAg0LIg0L/QsNC90LXQu9C4INC40L3RgdGC0YDRg9C80LXQvdGC0L7QsiDQsdGA0LDRg9C30LXRgNCwJyk7XHJcbn1cclxuXHJcblxyXG5cclxuXG5mdW5jdGlvbiBtbm92YVN1Z2dlc3Qoc3VnZ2VzdE8sIGlucHV0Tykge1xuXHR0aGlzLnN1Z2dlc3QgPSBzdWdnZXN0Tztcblx0dGhpcy5pbnB1dCA9IGlucHV0Tztcblx0dGhpcy5zZWFyY2hUaW1lb3V0ID0gMzAwO1xuXHR0aGlzLnRpbWVvdXRTZWFyY2hIbmQgPSBudWxsO1x0XG5cdHRoaXMudGltZW91dEJsdXJIbmQgPSBudWxsO1x0XG5cdHRoaXMuY291bnRSZXF1ZXN0ID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKDEwMDAwIC0gMTAwMCArIDEpKSArIDEwMDA7XG5cdHRoaXMudXJsID0gJy9zaW5wbCc7XG5cdHRoaXMuaXRlbXMgPSBudWxsO1xuXHR0aGlzLm1pbndpZHRoID0gMDtcblx0dGhpcy5pbml0KCk7XG59XG5cbm1ub3ZhU3VnZ2VzdC5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uKCkge1x0XG5cdHRoaXMuc3VnZ2VzdC5vID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5zdWdnZXN0Lm8pO1xuXHR0aGlzLmlucHV0LnBhcmVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuaW5wdXQucGFyZW50KTtcblx0dmFyIGNvb3JkcyA9IHRoaXMuZ2V0T2Zmc2V0KHRoaXMuaW5wdXQucGFyZW50KTtcblx0dGhpcy5zdWdnZXN0Lm8uc3R5bGUubGVmdCA9IGNvb3Jkcy5sZWZ0KydweCc7XHRcblx0dGhpcy5zdWdnZXN0Lm8uc3R5bGUudG9wID0gY29vcmRzLnRvcCt0aGlzLmlucHV0LnBhcmVudC5vZmZzZXRIZWlnaHQrJ3B4Jztcblx0cmVtb3ZlQ2xhc3ModGhpcy5zdWdnZXN0Lm8sICdvbmZvY3VzJyk7XG5cdHRoaXMuaW5wdXQuby52YWx1ZSA9ICcnO1xuXHR0aGlzLmlucHV0LmxvYWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuaW5wdXQubG9hZGVyKTtcblx0dmFyIHBhcmVudCA9IHRoaXM7XHRcblx0dGhpcy5pbnB1dC5vLm9uYmx1ciA9IGZ1bmN0aW9uKGV2ZW50KSB7cGFyZW50LmJsdXIocGFyZW50KX07XG5cdHRoaXMuaW5wdXQuby5vbmNsaWNrID0gZnVuY3Rpb24oZXZlbnQpIHtwYXJlbnQuY2xpY2socGFyZW50KX07XG5cdHRoaXMuaW5wdXQuby5vbmtleWRvd24gPSBmdW5jdGlvbihldmVudCkge3BhcmVudC5rZXlkb3duKGV2ZW50LCBwYXJlbnQpfTtcdFxuXHR0aGlzLmlucHV0LmxvYWRlci5vbmNsaWNrID0gZnVuY3Rpb24oKSB7cGFyZW50LmxvYWRlckNsaWNrKHBhcmVudCl9O1x0XG59XG5cbm1ub3ZhU3VnZ2VzdC5wcm90b3R5cGUuY2xpY2sgPSBmdW5jdGlvbihvYmopIHtcblx0aWYgKHRoaXMuaW5wdXQuby52YWx1ZSA9PSBvYmouaW5wdXQuZGVmVmFsKSB0aGlzLmlucHV0Lm8udmFsdWUgPSAnJztcbn1cblxubW5vdmFTdWdnZXN0LnByb3RvdHlwZS5ibHVyID0gZnVuY3Rpb24ob2JqKSB7XG5cdHRoaXMudGltZW91dEJsdXJIbmQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuXHRcdGlmIChvYmouaW5wdXQuby52YWx1ZS5sZW5ndGggPT0gMCkgb2JqLmlucHV0Lm8udmFsdWUgPSBvYmouaW5wdXQuZGVmVmFsO1xuXHRcdG9iai5zdWdnZXN0Lm8uc3R5bGUud2lkdGggPSAwO1xuXHRcdHJlbW92ZUNsYXNzKG9iai5zdWdnZXN0Lm8sICdvbmZvY3VzJyk7XG5cdFx0cmVtb3ZlQ2xhc3Mob2JqLmlucHV0LmxvYWRlciwgJ3NwaW5uZXInKTtcblx0fSwgMjAwKTtcbn1cblxubW5vdmFTdWdnZXN0LnByb3RvdHlwZS5yZWRyYXdTdWdnZXN0ID0gZnVuY3Rpb24oKSB7XG5cdGFkZENsYXNzKHRoaXMuc3VnZ2VzdC5vLCAnb25mb2N1cycpO1xuXHR0aGlzLnN1Z2dlc3Quby5zdHlsZS53aWR0aCA9ICdhdXRvJztcdFxuXHR0aGlzLm1pbndpZHRoID0gdGhpcy5pbnB1dC5wYXJlbnQub2Zmc2V0V2lkdGgrJ3B4Jztcblx0aWYgKHRoaXMuc3VnZ2VzdC5vLm9mZnNldFdpZHRoIDwgcGFyc2VJbnQodGhpcy5taW53aWR0aC5yZXBsYWNlKCdweCcsJycpLCAxMCkpXG5cdFx0dGhpcy5zdWdnZXN0Lm8uc3R5bGUud2lkdGggPSB0aGlzLm1pbndpZHRoO1xuXHRlbHNlIFxuXHRcdHRoaXMuc3VnZ2VzdC5vLnN0eWxlLndpZHRoID0gdGhpcy5zdWdnZXN0Lm8ub2Zmc2V0V2lkdGg7XG5cdHRoaXMuc3VnZ2VzdC5vLnN0eWxlLndpZHRoID0gcGFyc2VJbnQodGhpcy5zdWdnZXN0Lm8uc3R5bGUud2lkdGgucmVwbGFjZSgncHgnLCAnJyksIDEwKSsncHgnO1xuXHR0aGlzLm1vdXNlT3ZlcigxKTsgXG59XG5cbm1ub3ZhU3VnZ2VzdC5wcm90b3R5cGUubG9hZGVyQ2xpY2sgPSBmdW5jdGlvbihvYmope1xuXHRjbGVhclRpbWVvdXQob2JqLnRpbWVvdXRCbHVySG5kKTtcblx0aWYgKG9iai5pbnB1dC5vLnZhbHVlLmxlbmd0aCA9PSAwIHx8IG9iai5pbnB1dC5vLnZhbHVlID09IG9iai5pbnB1dC5kZWZWYWwpIHJldHVybjtcblx0aWYgKCFoYXNDbGFzcyhvYmouaW5wdXQubG9hZGVyLCAneCcpICYmICFoYXNDbGFzcyhvYmouaW5wdXQubG9hZGVyLCAnc3Bpbm5lcicpKVxuXHRcdG9iai5nZXRBamF4TGlzdCgpO1xuXHRlbHNlIGlmIChoYXNDbGFzcyhvYmouaW5wdXQubG9hZGVyLCAneCcpKSB7XG5cdFx0cmVtb3ZlQ2xhc3Mob2JqLmlucHV0LmxvYWRlciwgJ3NwaW5uZXInKTtcdFxuXHRcdHJlbW92ZUNsYXNzKG9iai5pbnB1dC5sb2FkZXIsICd4Jyk7XG5cdFx0b2JqLmlucHV0Lm8udmFsdWUgPSAnJztcblx0XHRyZW1vdmVDbGFzcyhvYmouc3VnZ2VzdC5vLCAnb25mb2N1cycpO1xuXHRcdG9iai5pbnB1dC5vLmZvY3VzKCk7XG5cdH1cbn1cblxubW5vdmFTdWdnZXN0LnByb3RvdHlwZS5rZXlkb3duID0gZnVuY3Rpb24oZSwgb2JqKSB7XG5cdGUgPSBlIHx8IGV2ZW50O1xuXHR2YXIgY29kZSA9IChlLmNoYXJDb2RlKSA/IGUuY2hhckNvZGUgOiBlLmtleUNvZGU7XG5cdHN3aXRjaChjb2RlKSB7XG4gICAgY2FzZSAxMzpcbiAgICBcdG9iai5tb3VzZUNsaWNrKCk7XHRcdFxuICAgIGJyZWFrOyBcdFx0XHQgICAgICBcbiAgICBjYXNlIDM4OlxuICAgIFx0b2JqLm1vdXNlT3ZlcigtMSk7XHRcdFxuICAgIGJyZWFrOyBcbiAgICBjYXNlIDQwOlxuICAgIFx0b2JqLm1vdXNlT3ZlcigxKTtcdFx0XG4gICAgYnJlYWs7IFxuICAgIGNhc2UgMTY6IGNhc2UgMTc6IGNhc2UgMjA6IGNhc2UgOTogY2FzZSAzNzogY2FzZSAzOTogXG4gICAgYnJlYWs7XG5cdFx0ZGVmYXVsdDpcdFxuXHRcdFx0Y2xlYXJUaW1lb3V0KG9iai50aW1lb3V0U2VhcmNoSG5kKTtcdFxuXHRcdFx0b2JqLmdldEFqYXhMaXN0KCk7XHRcbiAgICBicmVhazsgXHQgICAgXHRcdCAgICAgIFx0ICBcdFx0XHRcdFxuXHR9IFx0XG59XG5cbm1ub3ZhU3VnZ2VzdC5wcm90b3R5cGUuZ2V0QWpheExpc3QgPSBmdW5jdGlvbigpIHtcblx0cmVtb3ZlQ2xhc3ModGhpcy5zdWdnZXN0Lm8sICdvbmZvY3VzJyk7XG5cdHJlbW92ZUNsYXNzKHRoaXMuaW5wdXQubG9hZGVyLCAneCcpO1x0XHRcdFxuXHRhZGRDbGFzcyh0aGlzLmlucHV0LmxvYWRlciwgJ3NwaW5uZXInKTtcdFxuXHR2YXIgcGFyZW50ID0gdGhpcztcdFx0XG5cdHRoaXMudGltZW91dFNlYXJjaEhuZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XHRcdFxuXHRcdGlmIChwYXJlbnQuaW5wdXQuby52YWx1ZS5sZW5ndGg9PTApIHsgXG5cdFx0XHRyZW1vdmVDbGFzcyhwYXJlbnQuaW5wdXQubG9hZGVyLCAnc3Bpbm5lcicpO1x0XHRcdFx0XHRcblx0XHRcdHJldHVybjtcdFxuXHRcdH1cblx0XHRwYXJlbnQuY291bnRSZXF1ZXN0Kys7XHRcblx0XHR2YXIgbG9hZERhdGEgPSBuZXcgTG9hZERhdGFTZWFyY2gocGFyZW50KTtcblx0XHRsb2FkRGF0YS5nZXREYXRhKHBhcmVudC51cmwrXCI/bGFuZz1ydSZpZD1cIitwYXJlbnQuY291bnRSZXF1ZXN0K1wiJmZjaGFyPVwiK2VuY29kZVVSSUNvbXBvbmVudCgocGFyZW50LmlucHV0Lm8udmFsdWUpKSk7XHRcdFxuXHR9LCB0aGlzLnNlYXJjaFRpbWVvdXQpO1x0XG59XG5cbm1ub3ZhU3VnZ2VzdC5wcm90b3R5cGUubW91c2VDbGljayA9IGZ1bmN0aW9uKCkge1xuXHRmb3IodmFyIGk9MDsgaTx0aGlzLml0ZW1zLmxlbmd0aDsgaSsrKSB7XG5cdFx0dmFyIG8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLml0ZW1zW2ldLmlkKTtcblx0XHRpZiAoaGFzQ2xhc3MobywgJ29uaG92ZXInKSkge1xuXHRcdFx0aWYodGhpcy5pdGVtc1tpXS50eXBlID09ICd0Jylcblx0XHRcdFx0ZG9jdW1lbnQubG9jYXRpb24gPSAnL2ZyYy8nK3RoaXMuaXRlbXNbaV0uaWQrJy5odG0nO1xuXHRcdFx0aWYodGhpcy5pdGVtc1tpXS50eXBlID09ICdhJykgXG5cdFx0XHRcdGRvY3VtZW50LmxvY2F0aW9uID0gJy9hdmlhLycrKChwYXJzZUludCh0aGlzLml0ZW1zW2ldLmlkLCAxMCkrMTAwMDApKigtMSkpKycuaHRtJztcdFx0XHRcblx0XHRcdGlmKHRoaXMuaXRlbXNbaV0udHlwZSA9PSAnYycpXG5cdFx0XHRcdGRvY3VtZW50LmxvY2F0aW9uID0gJy9saXN0L2NvdW50cmllcy8nK3RoaXMuZXNjYXBlKHRoaXMuaXRlbXNbaV0ubmFtZSk7XG5cdFx0XHRpZih0aGlzLml0ZW1zW2ldLnR5cGUgPT0gJ2QnKVxuXHRcdFx0XHRkb2N1bWVudC5sb2NhdGlvbiA9ICcvbGlzdC9yZWdpb25zLycrdGhpcy5lc2NhcGUodGhpcy5pdGVtc1tpXS5pZCk7XG5cdFx0XHRpZih0aGlzLml0ZW1zW2ldLnR5cGUgPT0gJ211Jylcblx0XHRcdFx0ZG9jdW1lbnQubG9jYXRpb24gPSAnL2xpc3QvbXVuaWNpcGFscy8nK3RoaXMuZXNjYXBlKHRoaXMuaXRlbXNbaV0uaWQpO1x0XHRcdFxuXHRcdFx0cmV0dXJuO1xuXHRcdH1cdFx0XHRcblx0fVxuXHR2YXIgbyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZXJyX2FcIik7XG5cdGlmIChvKSBkb2N1bWVudC5sb2NhdGlvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZXJyX2FcIikuZ2V0QXR0cmlidXRlKCdocmVmJyk7XG59XG5cbm1ub3ZhU3VnZ2VzdC5wcm90b3R5cGUubW91c2VPdmVyID0gZnVuY3Rpb24oc3RlcCwgbykge1xuXHRpZiAoIXRoaXMuaXRlbXMpIHJldHVybjtcblx0aWYgKHRoaXMuaXRlbXMubGVuZ3RoID09IDApIHtcblx0XHQvL28gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGlzY3JpcHQnKTtcblx0XHQvL2lmIChvKSBhZGRDbGFzcyhvLCAnb25ob3ZlcicpO1xuXHRcdHJldHVybjtcblx0fVxuXHR2YXIgZSA9IG51bGw7XG5cdGlmICghbykge1xuXHRcdGZvcih2YXIgaT0wOyBpPHRoaXMuaXRlbXMubGVuZ3RoOyBpKyspIHtcblx0XHRcdG8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLml0ZW1zW2ldLmlkKTtcblx0XHRcdGlmIChoYXNDbGFzcyhvLCAnb25ob3ZlcicpKSB7XG5cdFx0XHRcdGUgPSB0aGlzLml0ZW1zW2krc3RlcF0hPXVuZGVmaW5lZD90aGlzLml0ZW1zW2krc3RlcF06XG5cdFx0XHRcdFx0XHRcdFx0c3RlcD09MT90aGlzLml0ZW1zWzBdOnRoaXMuaXRlbXNbdGhpcy5pdGVtcy5sZW5ndGgtMV07XG5cdFx0XHRcdHRoaXMuaW5wdXQuby52YWx1ZSA9IGUubmFtZTsgXHRcdFx0XHRcdFx0XHRcdFxuXHRcdFx0XHRicmVhaztcdFx0XHRcdFx0XHRcblx0XHRcdH1cdFx0XHRcdFx0XHRcdFxuXHRcdH1cblx0XHRpZiAoIWUpIFxuXHRcdFx0ZSA9IHN0ZXA9PTE/dGhpcy5pdGVtc1swXTp0aGlzLml0ZW1zW3RoaXMuaXRlbXMubGVuZ3RoLTFdO1xuXHRcdG8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChlLmlkKTtcdFx0XHRcblx0fVxuXHR0aGlzLm1vdXNlT3V0KCk7XHRcblx0aWYgKG8pIGFkZENsYXNzKG8sICdvbmhvdmVyJyk7XHRcblx0aWYgKCFlKSBcblx0XHRmb3IodmFyIGk9MDsgaTx0aGlzLml0ZW1zLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5pdGVtc1tpXS5pZCk7XG5cdFx0XHRpZiAoaGFzQ2xhc3MobywgJ29uaG92ZXInKSkge1xuXHRcdFx0XHRlID0gdGhpcy5pdGVtc1tpXTsgXHRcblx0XHRcdH1cdFxuXHRcdH1cdFx0XG5cdGlmICghZSkgdGhpcy5pdGVtc1swXTtcblx0XHRcdFx0XG59XG5cbm1ub3ZhU3VnZ2VzdC5wcm90b3R5cGUubW91c2VPdXQgPSBmdW5jdGlvbigpIHtcblx0dmFyIG8gPSBudWxsO1xuXHRmb3IodmFyIGk9MDsgaTx0aGlzLml0ZW1zLmxlbmd0aDsgaSsrKSB7XHRcblx0XHRvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5pdGVtc1tpXS5pZCk7IFxuXHRcdGlmIChvKSByZW1vdmVDbGFzcyhvLCAnb25ob3ZlcicpOyBcblx0fVxufVxuXG5tbm92YVN1Z2dlc3QucHJvdG90eXBlLmdldFN1Z2dlc3QgPSBmdW5jdGlvbigpIHtcblx0dmFyIGh0bWwgPSAnJyxcblx0XHRzdHIgPSAnJyxcblx0XHRpc0NvdW50cnkgPSBmYWxzZSxcblx0XHRpc0NpdHkgPSBmYWxzZSxcblx0XHRpc0F2aWEgPSBmYWxzZSxcblx0XHRpc0Rpc3RyaWN0ID0gZmFsc2UsXG5cdFx0aXNNdSA9IGZhbHNlLFxuXHRcdGh0bWwgPSB0aGlzLnN1Z2dlc3QubnVsbHRwbDtcblx0YWRkQ2xhc3ModGhpcy5zdWdnZXN0Lm8sICdlJyk7XG5cdGZvcih2YXIgaT0wOyBpPHRoaXMuaXRlbXMubGVuZ3RoOyBpKyspIHtcblx0XHRpZiAoaT09MCkgaHRtbCA9ICcnO1xuXHRcdGlmICh0aGlzLml0ZW1zW2ldLnR5cGU9PSdjJyAmJiBpc0NvdW50cnkgPT0gZmFsc2UpIHsgXG5cdFx0XHRodG1sICs9dGhpcy5zdWdnZXN0LnRwbGM7XG5cdFx0XHRpc0NvdW50cnkgPSB0cnVlO1xuXHRcdH1cdFx0XHRcdFxuXHRcdGlmICh0aGlzLml0ZW1zW2ldLnR5cGU9PSd0JyAmJiBpc0NpdHkgPT0gZmFsc2UpIHtcblx0XHRcdGh0bWwgKz10aGlzLnN1Z2dlc3QudHBsdDtcblx0XHRcdGlzQ2l0eSA9IHRydWU7XG5cdFx0fVxuXHRcdGlmICh0aGlzLml0ZW1zW2ldLnR5cGU9PSdhJyAmJiBpc0F2aWEgPT0gZmFsc2UpIHtcblx0XHRcdGh0bWwgKz10aGlzLnN1Z2dlc3QudHBsYTtcblx0XHRcdGlzQXZpYSA9IHRydWU7XG5cdFx0fVx0XHRcdFx0XG5cdFx0aWYgKHRoaXMuaXRlbXNbaV0udHlwZT09J2QnICYmIGlzRGlzdHJpY3QgPT0gZmFsc2UpIHtcblx0XHRcdGh0bWwgKz10aGlzLnN1Z2dlc3QudHBsZDtcblx0XHRcdGlzRGlzdHJpY3QgPSB0cnVlO1xuXHRcdH1cblx0XHRpZiAodGhpcy5pdGVtc1tpXS50eXBlPT0nbXUnICYmIGlzTXUgPT0gZmFsc2UpIHtcblx0XHRcdGh0bWwgKz10aGlzLnN1Z2dlc3QudHBsbXU7XG5cdFx0XHRpc011ID0gdHJ1ZTtcblx0XHR9XHRcdFxuXHRcblx0XHRodG1sICs9IHRoaXMuc3VnZ2VzdC50cGw7XG5cdFx0XG5cdCAgZG97XG5cdCAgXHRpZiAoIShzdHIgPSBodG1sLm1hdGNoKC8lKFtcXHdcXGQuXSspJS9naW0pKSlcblx0ICAgIFx0YnJlYWs7XG5cdCAgICBmb3IgKHZhciBqIGluIHN0cil7XG5cdCAgICBcdGlmIChwYXJzZUludChqLCAxMCkgIT0gaikgY29udGludWU7XG5cdCAgICBcdHRyeSB7XG5cdCAgICAgXHRcdHZhciB0cD1zdHJbal0ucmVwbGFjZSgvJS9naSwnJyk7XG5cdCAgICAgXHRcdGlmICh0aGlzLml0ZW1zW2ldW3RwXSkge1xuXHQgICAgIFx0XHQgXHRodG1sID0gaHRtbC5yZXBsYWNlKHN0cltqXSwgKHRwPT0nZF9uYW1lJyB8fCB0cD09J211bl9uYW1lJyk/dGhpcy5pdGVtc1tpXVt0cF0ucmVwbGFjZSgvIC9naSwnJm5ic3A7JykrJywmbmJzcDsnOnRoaXMuaXRlbXNbaV1bdHBdLnJlcGxhY2UoLyAvZ2ksJyZuYnNwOycpKTsgICAgIFx0XHRcdCAgICAgXHRcdH1cblx0ICAgICBcdFx0ZWxzZSBcblx0ICAgICAgXHRcdFx0aHRtbCA9IGh0bWwucmVwbGFjZShzdHJbal0sICcnKTtcblx0ICAgICAgfVxuXHQgICAgICBjYXRjaChlcnIpIHt9ICAgICBcblx0ICAgIH1cblx0ICB9d2hpbGUoMSk7XHRcdFxuXHR9XG5cdGlmICh0aGlzLml0ZW1zLmxlbmd0aD4wKSB7XG5cdFx0aHRtbCArPSAnPGRpdiBjbGFzcz1cImRpc2NyaXB0XCI+PHNwYW4gY2xhc3M9XCJhbGxfc2VhcmNoXCI+PGEgaHJlZj1cIi9zZWFyY2gvJyt0aGlzLmVzY2FwZSh0aGlzLmlucHV0Lm8udmFsdWUpKydcIj4nK3RoaXMuc3VnZ2VzdC50cGxfYWxsc2VhcmNoKyc8L2E+PC9zcGFuPjwvZGl2Pic7XG5cdFx0aHRtbCArPSAnPGRpdiBjbGFzcz1cImRpc2NyaXB0XCI+PHNwYW4gY2xhc3M9XCJhbGxfc2VhcmNoXCI+PGEgaHJlZj1cIi9tZ2ZpbmQuaHRtXCI+0J3QtdGCINC90YPQttC90L7Qs9C+INC/0YPQvdC60YLQsD8g0JjRgdC/0L7Qu9GM0LfRg9C50YLQtSDQnNC10LPQsNC/0L7QuNGB0Lo8L2E+PC9zcGFuPjwvZGl2Pic7XHRcblx0XHRyZW1vdmVDbGFzcyh0aGlzLnN1Z2dlc3QubywgJ2UnKTtcblx0fVxuXHRyZXR1cm4gaHRtbDtcbn1cblxuZnVuY3Rpb24gTG9hZERhdGFTZWFyY2gocGFyZW50KSB7XG5cdHRoaXMucGFyZW50ID0gcGFyZW50OyBcbiAgdGhpcy5YTUxPYmogPSBudWxsO1xuICB0aGlzLmdldERhdGEgPSBmdW5jdGlvbih1cmwpIHtcblx0ICB0cnkge1xuXHQgIFx0dGhpcy5YTUxPYmogPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcblx0ICB9IGNhdGNoKGVycikge1xuXHQgIFx0dGhpcy5YTUxPYmogPSBuZXcgQWN0aXZlWE9iamVjdChcIk1pY3Jvc29mdC5YTUxIdHRwXCIpO1xuXHQgIH1cbiAgICBpZiAodGhpcy5YTUxPYmopIHtcbiAgICAgIHRoaXMuWE1MT2JqLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHRoaXMuTG9hZERhdGFDYWxsYmFja0Z1bmN0aW9uICh0aGlzLlhNTE9iaiwgdGhpcy5wYXJlbnQpOyAgICBcbiAgICAgIHRoaXMuWE1MT2JqLm9wZW4oXCJHRVRcIiwgdXJsKycmcj0nK01hdGgucmFuZG9tKCksIHRydWUpO1xuICAgIFx0dGhpcy5YTUxPYmouc2VuZChudWxsKTtcbiAgICB9XG4gIH1cblxuICB0aGlzLkxvYWREYXRhQ2FsbGJhY2tGdW5jdGlvbiA9IGZ1bmN0aW9uKFhNTE9iaiwgcGFyZW50KSB7XG4gIFx0cmV0dXJuIGZ1bmN0aW9uKCkge1xuICBcdFx0cGFyZW50Lml0ZW1zID0ge307XG4gICAgXHRpZiAoWE1MT2JqLnJlYWR5U3RhdGUgPT0gNCkge1xuICAgIFx0XHRpZiAoWE1MT2JqLnN0YXR1cyA9PSAyMDApIHtcbiAgICBcdFx0XHR0cnkgeyBcblx0ICAgIFx0XHRcdHZhciBkYXRhID0gSlNPTi5wYXJzZShYTUxPYmoucmVzcG9uc2VUZXh0KTtcblx0ICAgIFx0XHRcdHBhcmVudC5pdGVtcyA9IGRhdGEuaXRlbXM7XG5cdFx0XHRcdFx0cGFyZW50LnN1Z2dlc3Quby5pbm5lckhUTUwgPSBwYXJlbnQuZ2V0U3VnZ2VzdCgpLnJlcGxhY2UoJyVpbnB1dC52YWwlJywgcGFyZW50LmVzY2FwZShwYXJlbnQuaW5wdXQuby52YWx1ZSkpLnJlcGxhY2UoJyVpbnB1dC52YWwlJywgcGFyZW50LmlucHV0Lm8udmFsdWUpO1xuXHRcdFx0XHRcdHBhcmVudC5yZWRyYXdTdWdnZXN0KCk7XHRcdFx0XHRcblx0XHRcdFx0XHRhZGRDbGFzcyhwYXJlbnQuaW5wdXQubG9hZGVyLCAneCcpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGNhdGNoKGVycikge31cblx0ICAgICAgXHRcdFhNTE9iaj0gbnVsbDtcblx0ICAgICAgXHR9XG5cdFx0fVxuICAgXHR9XG4gIH1cbn1cblxubW5vdmFTdWdnZXN0LnByb3RvdHlwZS5nZXRPZmZzZXQgPSBmdW5jdGlvbihlbGVtKSB7XG5cdGZ1bmN0aW9uIGdldE9mZnNldFN1bShlbGVtKSB7XG5cdCBcdHZhciB0b3A9MCwgbGVmdD0wXG5cdCBcdHdoaWxlKGVsZW0pIHtcblx0IFx0XHR0b3AgPSB0b3AgKyBwYXJzZUludChlbGVtLm9mZnNldFRvcClcblx0IFx0XHRsZWZ0ID0gbGVmdCArIHBhcnNlSW50KGVsZW0ub2Zmc2V0TGVmdClcblx0IFx0XHRlbGVtID0gZWxlbS5vZmZzZXRQYXJlbnRcblx0XHR9XG5cdCBcdHJldHVybiB7dG9wOiB0b3AsIGxlZnQ6IGxlZnR9XG5cdH1cblx0XG5cdGZ1bmN0aW9uIGdldE9mZnNldFJlY3QoZWxlbSkge1xuIFx0IHZhciBib3ggPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gXHQgdmFyIGJvZHkgPSBkb2N1bWVudC5ib2R5XG4gXHQgdmFyIGRvY0VsZW0gPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnRcbiBcdCB2YXIgc2Nyb2xsVG9wID0gd2luZG93LnBhZ2VZT2Zmc2V0IHx8IGRvY0VsZW0uc2Nyb2xsVG9wIHx8IGJvZHkuc2Nyb2xsVG9wXG4gXHQgdmFyIHNjcm9sbExlZnQgPSB3aW5kb3cucGFnZVhPZmZzZXQgfHwgZG9jRWxlbS5zY3JvbGxMZWZ0IHx8IGJvZHkuc2Nyb2xsTGVmdFxuIFx0IHZhciBjbGllbnRUb3AgPSBkb2NFbGVtLmNsaWVudFRvcCB8fCBib2R5LmNsaWVudFRvcCB8fCAwXG4gXHQgdmFyIGNsaWVudExlZnQgPSBkb2NFbGVtLmNsaWVudExlZnQgfHwgYm9keS5jbGllbnRMZWZ0IHx8IDBcbiBcdCB2YXIgdG9wID0gYm94LnRvcCArIHNjcm9sbFRvcCAtIGNsaWVudFRvcFxuIFx0IHZhciBsZWZ0ID0gYm94LmxlZnQgKyBzY3JvbGxMZWZ0IC0gY2xpZW50TGVmdFxuIFx0IHJldHVybiB7IHRvcDogTWF0aC5yb3VuZCh0b3ApLCBsZWZ0OiBNYXRoLnJvdW5kKGxlZnQpIH1cblx0fVx0XG5cdFxuXHRpZiAoZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QpXG5cdFx0cmV0dXJuIGdldE9mZnNldFJlY3QoZWxlbSlcblx0ZWxzZVxuXHQgXHRyZXR1cm4gZ2V0T2Zmc2V0U3VtKGVsZW0pXG59XG5cbmZ1bmN0aW9uIGdldE5hdmlnYXRvck5hbWUoKSB7XG5cdHZhciB1c2VyYWdlbnQ9bmF2aWdhdG9yLnVzZXJBZ2VudDtcblx0dmFyIG5hdmlnYXRvcm5hbWU7XG5cdGlmICh1c2VyYWdlbnQuaW5kZXhPZignTVNJRScpIT0gLTEpIHtcblx0ICAgIG5hdmlnYXRvcm5hbWU9XCJNU0lFXCI7XG5cdH1cblx0ZWxzZSBpZiAodXNlcmFnZW50LmluZGV4T2YoJ0dlY2tvJykhPSAtMSkge1xuXHQgICAgaWYgKHVzZXJhZ2VudC5pbmRleE9mKCdDaHJvbWUnKSE9IC0xKVxuXHQgICAgbmF2aWdhdG9ybmFtZT1cIkNocm9tZVwiO1xuXHQgICAgZWxzZSBuYXZpZ2F0b3JuYW1lPVwiTW96aWxsYVwiO1xuXHR9XG5cdGVsc2UgaWYgKHVzZXJhZ2VudC5pbmRleE9mKCdNb3ppbGxhJykhPSAtMSkge1xuXHQgICAgbmF2aWdhdG9ybmFtZT1cIm9sZCBOZXRzY2FwZSBvciBNb3ppbGxhXCI7XG5cdH1cblx0ZWxzZSBpZiAodXNlcmFnZW50LmluZGV4T2YoJ09wZXJhJykhPSAtMSkge1xuXHQgICAgbmF2aWdhdG9ybmFtZT1cIk9wZXJhXCI7XG5cdH1cblx0cmV0dXJuIG5hdmlnYXRvcm5hbWUudG9Mb3dlckNhc2UoKTtcbn1cblxuZnVuY3Rpb24gYWRkQ2xhc3MobywgYyl7XG5cdGlmICghbykgcmV0dXJuO1xuXHR2YXIgcmUgPSBuZXcgUmVnRXhwKFwiKF58XFxcXHMpXCIgKyBjICsgXCIoXFxcXHN8JClcIiwgXCJnXCIpO1xuXHRpZiAocmUudGVzdChvLmNsYXNzTmFtZSkpIHJldHVyblxuXHRvLmNsYXNzTmFtZSA9IChvLmNsYXNzTmFtZSArIFwiIFwiICsgYykucmVwbGFjZSgvXFxzKy9nLCBcIiBcIikucmVwbGFjZSgvKF4gfCAkKS9nLCBcIlwiKTtcbn1cbiAgXG5mdW5jdGlvbiByZW1vdmVDbGFzcyhvLCBjKXtcblx0aWYgKCFvKSByZXR1cm47XHRcblx0dmFyIHJlID0gbmV3IFJlZ0V4cChcIihefFxcXFxzKVwiICsgYyArIFwiKFxcXFxzfCQpXCIsIFwiZ1wiKTtcblx0by5jbGFzc05hbWUgPSBvLmNsYXNzTmFtZS5yZXBsYWNlKHJlLCBcIiQxXCIpLnJlcGxhY2UoL1xccysvZywgXCIgXCIpLnJlcGxhY2UoLyheIHwgJCkvZywgXCJcIik7XG59XG5cbmZ1bmN0aW9uIGhhc0NsYXNzKG8sIGMpIHtcblx0aWYgKCFvKSByZXR1cm4gJyc7XHRcblx0cmV0dXJuIG8uY2xhc3NOYW1lLm1hdGNoKG5ldyBSZWdFeHAoJyhcXFxcc3xeKScrYysnKFxcXFxzfCQpJykpO1xufVxuXG5tbm92YVN1Z2dlc3QucHJvdG90eXBlLmVzY2FwZSA9IGZ1bmN0aW9uKHN0cikge1xuXHR2YXIgdHJhbnMgPSBbXTtcblx0Zm9yICh2YXIgaSA9IDB4NDEwOyBpIDw9IDB4NDRGOyBpKyspIHRyYW5zW2ldID0gaSAtIDB4MzUwOyAvLyBBLT9hLXlcblx0dHJhbnNbMHg0MDFdID0gMHhBODsgICAgLy8gP1xuXHR0cmFuc1sweDQ1MV0gPSAweEI4OyAgICAvLyA/XG5cdHRyYW5zWzB4NDU3XSA9IDB4QkY7ICAgIC8vID9cblx0dHJhbnNbMHg0MDddID0gMHhBRjsgICAgLy8gP1xuXHR0cmFuc1sweDQ1Nl0gPSAweEIzOyAgICAvLyA/XG5cdHRyYW5zWzB4NDA2XSA9IDB4QjI7ICAgIC8vID9cblx0dHJhbnNbMHg0MDRdID0gMHhCQTsgICAgLy8gP1xuXHR0cmFuc1sweDQ1NF0gPSAweEFBOyAgICAvLyA/XG5cdFxuICB2YXIgcmVzPScnO1xuICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7IGkrKykge1xuICAgIHZhciBuID0gc3RyLmNoYXJDb2RlQXQoaSk7XG4gICAgaWYgKHR5cGVvZiB0cmFuc1tuXSAhPSAndW5kZWZpbmVkJykge1xuICAgICAgbiA9IHRyYW5zW25dO1xuICAgICAgcmVzPXJlcytlc2NhcGUoU3RyaW5nLmZyb21DaGFyQ29kZShuKSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgbiA9IHN0ci5jaGFyQXQoaSk7XG4gICAgICByZXM9cmVzK247XG4gICAgfVxuICB9XG4gIHJldHVybiByZXM7XG59Il0sImZpbGUiOiJtZXRlb25vdmEuYXZpYS5taW4uanMifQ==
